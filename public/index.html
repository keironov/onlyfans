<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Team Dashboard - Enhanced</title>
<link rel="icon" href="https://public-frontend-cos.metadl.com/mgx/img/favicon.png" type="image/png">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root{
  --bg-primary:#0a0e1a;
  --bg-secondary:#0f1419;
  --glass-bg:rgba(255,255,255,0.03);
  --glass-border:rgba(255,255,255,0.08);
  --text-primary:#e8f0ff;
  --text-secondary:#8b92a8;
  --accent:#f59e0b;
  --accent-hover:#fbbf24;
  --accent-green:#10b981;
  --accent-red:#ef4444;
  --accent-blue:#3b82f6;
  --accent-purple:#a855f7;
  --shadow:0 8px 32px rgba(0,0,0,0.4);
}

*{box-sizing:border-box;margin:0;padding:0;}

html,body{
  height:100%;
  background:radial-gradient(ellipse at top, #1a1f35 0%, var(--bg-primary) 50%);
  color:var(--text-primary);
  font-family:'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
  overflow-x:hidden;
}

body::before{
  content:'';
  position:fixed;
  top:0;left:0;right:0;bottom:0;
  background:
    radial-gradient(circle at 20% 30%, rgba(245,158,11,0.08) 0%, transparent 50%),
    radial-gradient(circle at 80% 70%, rgba(59,130,246,0.06) 0%, transparent 50%);
  pointer-events:none;
  z-index:0;
}

.wrap{
  max-width:1600px;
  margin:0 auto;
  padding:24px;
  position:relative;
  z-index:1;
}

.top{
  display:flex;
  gap:16px;
  align-items:center;
  justify-content:space-between;
  margin-bottom:24px;
  padding:24px;
  background:var(--glass-bg);
  backdrop-filter:blur(20px);
  border-radius:24px;
  border:1px solid var(--glass-border);
  box-shadow:var(--shadow);
}

.top h1{
  font-size:32px;
  font-weight:700;
  background:linear-gradient(135deg, var(--accent) 0%, var(--accent-hover) 100%);
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
  margin-bottom:4px;
}

.muted{color:var(--text-secondary);font-size:14px;}
.small{font-size:13px;color:var(--text-secondary);}

.card{
  background:var(--glass-bg);
  backdrop-filter:blur(20px);
  border-radius:24px;
  padding:24px;
  border:1px solid var(--glass-border);
  box-shadow:var(--shadow);
  margin-bottom:20px;
  transition:all 0.3s ease;
}

.card:hover{
  border-color:rgba(245,158,11,0.2);
  box-shadow:0 12px 48px rgba(0,0,0,0.5);
  transform:translateY(-2px);
}

.card h3{
  font-size:20px;
  font-weight:600;
  margin-bottom:16px;
  color:var(--text-primary);
}

.grid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:20px;
}

.grid-3{
  display:grid;
  grid-template-columns:repeat(3, 1fr);
  gap:20px;
}

input,textarea,select{
  width:100%;
  padding:12px 16px;
  border-radius:16px;
  border:1px solid var(--glass-border);
  background:rgba(255,255,255,0.02);
  color:var(--text-primary);
  outline:none;
  transition:all 0.3s ease;
  font-size:14px;
}

input:focus,textarea:focus,select:focus{
  background:rgba(255,255,255,0.04);
  border-color:var(--accent);
  box-shadow:0 0 0 3px rgba(245,158,11,0.1);
}

/* Custom select dropdown styling */
select {
  appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%238b92a8' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 12px center;
  padding-right: 36px;
  cursor: pointer;
}

select option {
  background: var(--bg-secondary);
  color: var(--text-primary);
  padding: 12px;
}

/* Custom date input styling */
input[type="date"] {
  position: relative;
  cursor: pointer;
}

input[type="date"]::-webkit-calendar-picker-indicator {
  background: transparent;
  bottom: 0;
  color: transparent;
  cursor: pointer;
  height: auto;
  left: 0;
  position: absolute;
  right: 0;
  top: 0;
  width: auto;
}

input[type="date"]::before {
  content: attr(data-placeholder);
  width: 100%;
}

input[type="date"]:focus::before,
input[type="date"]:valid::before {
  display: none;
}

input[type="number"]{
  width:90px;
  text-align:center;
}

button{
  background:linear-gradient(135deg, var(--accent) 0%, var(--accent-hover) 100%);
  color:#0a0e1a;
  border:none;
  padding:12px 24px;
  border-radius:16px;
  cursor:pointer;
  font-weight:600;
  font-size:14px;
  transition:all 0.3s ease;
  box-shadow:0 4px 16px rgba(245,158,11,0.3);
}

button:hover{
  transform:translateY(-2px);
  box-shadow:0 6px 24px rgba(245,158,11,0.4);
}

button:active{
  transform:translateY(0);
}

button.secondary{
  background:rgba(255,255,255,0.05);
  color:var(--text-primary);
  border:1px solid var(--glass-border);
  box-shadow:none;
}

button.secondary:hover{
  background:rgba(255,255,255,0.08);
  border-color:var(--accent);
}

button.danger{
  background:linear-gradient(135deg, var(--accent-red) 0%, #dc2626 100%);
  color:#fff;
  box-shadow:0 4px 16px rgba(239,68,68,0.3);
}

.action-btn{
  width:40px;
  height:40px;
  border-radius:12px;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  font-weight:700;
  cursor:pointer;
  border:none;
  transition:all 0.3s ease;
}

.approve{
  background:linear-gradient(135deg, var(--accent-green) 0%, #059669 100%);
  color:#fff;
  box-shadow:0 4px 12px rgba(16,185,129,0.3);
}

.approve:hover{transform:scale(1.05);}

.reject{
  background:linear-gradient(135deg, var(--accent-red) 0%, #dc2626 100%);
  color:#fff;
  box-shadow:0 4px 12px rgba(239,68,68,0.3);
}

.reject:hover{transform:scale(1.05);}

table{
  width:100%;
  border-collapse:separate;
  border-spacing:0 8px;
}

th,td{
  padding:12px 16px;
  text-align:left;
  vertical-align:middle;
}

thead th{
  color:var(--text-secondary);
  font-weight:600;
  font-size:13px;
  text-transform:uppercase;
  letter-spacing:0.5px;
  border-bottom:1px solid var(--glass-border);
}

tbody tr{
  background:rgba(255,255,255,0.02);
  border-radius:12px;
  transition:all 0.3s ease;
}

tbody tr:hover{
  background:rgba(255,255,255,0.04);
  transform:translateX(4px);
}

.table-select{
  width:160px;
  padding:8px 12px;
  border-radius:12px;
}

canvas{max-width:100%;border-radius:16px;}

.tabs{
  display:flex;
  gap:12px;
  margin-bottom:24px;
  padding:8px;
  background:var(--glass-bg);
  backdrop-filter:blur(20px);
  border-radius:20px;
  border:1px solid var(--glass-border);
}

.tab{
  padding:12px 24px;
  cursor:pointer;
  border-radius:14px;
  transition:all 0.3s ease;
  font-weight:500;
  color:var(--text-secondary);
}

.tab:hover{
  background:rgba(255,255,255,0.05);
  color:var(--text-primary);
}

.tab.active{
  background:linear-gradient(135deg, var(--accent) 0%, var(--accent-hover) 100%);
  color:#0a0e1a;
  box-shadow:0 4px 16px rgba(245,158,11,0.3);
}

.tab-content{display:none;}

.insight-item{
  padding:16px;
  margin:8px 0;
  border-left:4px solid var(--accent);
  background:rgba(245,158,11,0.08);
  border-radius:12px;
  backdrop-filter:blur(10px);
  transition:all 0.3s ease;
}

.insight-item:hover{
  background:rgba(245,158,11,0.12);
  transform:translateX(4px);
}

.insight-success{
  border-left-color:var(--accent-green);
  background:rgba(16,185,129,0.08);
}

.insight-success:hover{background:rgba(16,185,129,0.12);}

.insight-warning{
  border-left-color:var(--accent-red);
  background:rgba(239,68,68,0.08);
}

.insight-warning:hover{background:rgba(239,68,68,0.12);}

.worklog-item{
  padding:16px;
  margin:8px 0;
  border-radius:16px;
  background:rgba(255,255,255,0.03);
  display:flex;
  justify-content:space-between;
  align-items:center;
  transition:all 0.3s ease;
  border:1px solid var(--glass-border);
}

.worklog-item:hover{
  background:rgba(255,255,255,0.05);
  border-color:var(--accent);
}

.status-badge{
  padding:6px 14px;
  border-radius:12px;
  font-size:12px;
  font-weight:600;
  text-transform:uppercase;
  letter-spacing:0.5px;
}

.status-working{
  background:linear-gradient(135deg, var(--accent-green) 0%, #059669 100%);
  color:#fff;
}

.status-absent{
  background:linear-gradient(135deg, var(--accent-red) 0%, #dc2626 100%);
  color:#fff;
}

.status-evening{
  background:linear-gradient(135deg, var(--accent) 0%, var(--accent-hover) 100%);
  color:#0a0e1a;
}

.stat-card{
  background:rgba(255,255,255,0.03);
  border-radius:16px;
  padding:20px;
  border:1px solid var(--glass-border);
  transition:all 0.3s ease;
}

.stat-card:hover{
  background:rgba(255,255,255,0.05);
  border-color:var(--accent);
  transform:translateY(-2px);
}

.stat-number{
  font-size:32px;
  font-weight:700;
  background:linear-gradient(135deg, var(--accent) 0%, var(--accent-hover) 100%);
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
  margin-bottom:4px;
}

.stat-label{
  font-size:13px;
  color:var(--text-secondary);
  text-transform:uppercase;
  letter-spacing:0.5px;
}

.user-row{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:12px 16px;
  margin:6px 0;
  border-radius:12px;
  background:rgba(255,255,255,0.02);
  border:1px solid var(--glass-border);
  transition:all 0.3s ease;
  gap:12px;
}

.user-row:hover{
  background:rgba(255,255,255,0.04);
  border-color:var(--accent);
}

.team-list{
  max-height:500px;
  overflow:auto;
  padding:8px;
}

.team-list::-webkit-scrollbar{width:8px;}
.team-list::-webkit-scrollbar-track{background:rgba(255,255,255,0.02);border-radius:8px;}
.team-list::-webkit-scrollbar-thumb{background:var(--accent);border-radius:8px;}

.ranking-item{
  display:flex;
  align-items:center;
  gap:16px;
  padding:16px;
  margin:8px 0;
  border-radius:16px;
  background:rgba(255,255,255,0.03);
  border:1px solid var(--glass-border);
  transition:all 0.3s ease;
}

.ranking-item:hover{
  background:rgba(255,255,255,0.05);
  border-color:var(--accent-red);
}

.ranking-badge{
  width:48px;
  height:48px;
  border-radius:50%;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:700;
  font-size:18px;
  flex-shrink:0;
}

.rank-1{background:linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);color:#0a0e1a;}
.rank-2{background:linear-gradient(135deg, #94a3b8 0%, #64748b 100%);color:#fff;}
.rank-3{background:linear-gradient(135deg, #fb923c 0%, #f97316 100%);color:#fff;}
.rank-other{background:rgba(255,255,255,0.05);color:var(--text-secondary);}

.period-selector{
  padding:10px 16px;
  border-radius:14px;
  background:rgba(255,255,255,0.05);
  border:1px solid var(--glass-border);
  color:var(--text-primary);
  font-weight:500;
}

.date-navigator{
  display:flex;
  align-items:center;
  gap:12px;
  padding:12px;
  background:rgba(255,255,255,0.03);
  border-radius:16px;
  border:1px solid var(--glass-border);
  margin-bottom:16px;
}

.date-navigator button{
  padding:8px 16px;
  min-width:40px;
}

.date-navigator .current-date{
  flex:1;
  text-align:center;
  font-weight:600;
  color:var(--accent);
}

.top-performer-badge{
  display:inline-flex;
  align-items:center;
  gap:6px;
  padding:6px 12px;
  border-radius:12px;
  font-size:12px;
  font-weight:600;
  background:linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
  color:#0a0e1a;
  margin-left:8px;
}

.detailed-stats-grid{
  display:grid;
  grid-template-columns:repeat(auto-fit, minmax(280px, 1fr));
  gap:16px;
  margin-top:12px;
}

.mini-stat{
  padding:12px;
  background:rgba(255,255,255,0.02);
  border-radius:12px;
  border:1px solid var(--glass-border);
}

.mini-stat-value{
  font-size:24px;
  font-weight:700;
  color:var(--accent);
  margin-bottom:4px;
}

.mini-stat-label{
  font-size:11px;
  color:var(--text-secondary);
  text-transform:uppercase;
  letter-spacing:0.5px;
}

@media (max-width:1200px){
  .grid,.grid-3{grid-template-columns:1fr;}
  .wrap{padding:16px;}
}

@keyframes fadeIn{
  from{opacity:0;transform:translateY(10px);}
  to{opacity:1;transform:translateY(0);}
}

.card{animation:fadeIn 0.5s ease;}
</style>
</head>
<body>
<div class="wrap" id="wrap">
  <div class="top">
    <div>
      <h1>Team Dashboard Enhanced</h1>
      <div class="muted">OnlyFans Agency Management System</div>
    </div>
  </div>

  <div class="tabs">
    <div class="tab active" data-tab="reports">üìä –û—Ç—á–µ—Ç—ã</div>
    <div class="tab" data-tab="stats">üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
    <div class="tab" data-tab="team">üë• –ö–æ–º–∞–Ω–¥–∞</div>
    <div class="tab" data-tab="insights">üí° –ü–æ–¥—Å–∫–∞–∑–∫–∏</div>
    <div class="tab" data-tab="worklog">üìù –ë–ª–æ–≥ —Ä–∞–±–æ—Ç—ã</div>
  </div>

  <!-- TAB: REPORTS -->
  <div id="tab-reports" class="tab-content" style="display:block;">
    <div class="grid">
      <div style="grid-column:1/-1;">
        <div class="card">
          <h3>üìä Global Stats</h3>
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;">
            <div id="globalSummary" class="small muted">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            <div style="font-size:12px;color:var(--text-secondary)">‚è± –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 3—Å</div>
          </div>
          <canvas id="globalChart" style="height:240px;"></canvas>
          
          <div style="margin-top:20px;padding-top:20px;border-top:1px solid var(--glass-border);">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
              <h4 style="font-size:16px;font-weight:600;">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ–¥–æ–±—Ä–µ–Ω–∏–π</h4>
              <div id="approvalRatio" class="small muted"></div>
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
              <div class="stat-card">
                <div class="stat-number" id="totalApproved">0</div>
                <div class="stat-label">‚úî –û–¥–æ–±—Ä–µ–Ω–æ</div>
              </div>
              <div class="stat-card">
                <div class="stat-number" id="totalRejected" style="background:linear-gradient(135deg, var(--accent-red) 0%, #dc2626 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;">0</div>
                <div class="stat-label">‚úñ –û—Ç–∫–ª–æ–Ω–µ–Ω–æ</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div style="grid-column:1/-1;">
        <div class="card">
          <h3>üìã –û—Ç—á–µ—Ç—ã (–æ–∂–∏–¥–∞—é—â–∏–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è)</h3>
          <div style="overflow:auto;max-height:400px;">
            <table>
              <thead>
                <tr>
                  <th style="width:12%">@user</th>
                  <th style="width:50%">Text</th>
                  <th style="width:10%">Number</th>
                  <th style="width:12%">Type</th>
                  <th style="width:16%">‚úî / ‚ùå</th>
                </tr>
              </thead>
              <tbody id="reportsTable"></tbody>
            </table>
          </div>
        </div>
      </div>

      <div style="grid-column:1/-1;">
        <div class="card">
          <h3>üí¨ –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–∏–¥–±–µ–∫</h3>
          <div style="display:grid;gap:12px">
            <select id="feedbackUserSelect">
              <option value="">–í—ã–±–µ—Ä–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è‚Ä¶</option>
            </select>
            <textarea id="feedbackText" rows="4" placeholder="–¢–µ–∫—Å—Ç —Ñ–∏–¥–±—ç–∫–∞"></textarea>
            <div style="display:flex;gap:12px;align-items:center">
              <button id="sendFeedbackBtn">üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
              <div id="feedbackStatus" class="small muted"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- TAB: STATISTICS -->
  <div id="tab-stats" class="tab-content">
    <div class="grid">
      <div class="card">
        <h3>üìà –†–æ—Å—Ç –∫–æ–º–∞–Ω–¥—ã</h3>
        <canvas id="teamGrowthChart" style="height:280px;"></canvas>
      </div>
      <div class="card">
        <h3>üìä –†–æ—Å—Ç –∫–æ–Ω–≤–µ—Ä—Å–∏–π</h3>
        <canvas id="conversionGrowthChart" style="height:280px;"></canvas>
      </div>
    </div>

    <div class="card">
      <h3>üë§ –î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º</h3>
      <div id="userDetailedStats" style="display:grid;gap:12px;"></div>
    </div>

    <div class="card">
      <h3>üö´ –†–µ–π—Ç–∏–Ω–≥ –ø—Ä–æ–ø—É—Å–∫–æ–≤ —Ä–∞–±–æ—Ç—ã</h3>
      <div id="absenceRanking"></div>
    </div>
  </div>

  <!-- TAB: TEAM -->
  <div id="tab-team" class="tab-content">
    <div class="grid">
      <div class="card">
        <h3>üë• –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥–æ–π</h3>
        <div style="display:grid;gap:12px;margin-bottom:20px;">
          <input id="newUsername" placeholder="–í–≤–µ–¥–∏ username (–Ω–∞–ø—Ä–∏–º–µ—Ä @ivan)" />
          <button id="addUserBtn">‚ûï –î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ–º–∞–Ω–¥—É</button>
          <div id="addUserStatus" class="small muted"></div>
        </div>
        <div id="teamList" class="team-list small">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
      </div>
      <div class="card">
        <h3>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫–æ–º–∞–Ω–¥—ã</h3>
        <div id="teamStats" class="small muted">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
      </div>
    </div>
  </div>

  <!-- TAB: INSIGHTS -->
  <div id="tab-insights" class="tab-content">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;flex-wrap:wrap;gap:12px;">
        <h3>üí° –£–º–Ω—ã–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏</h3>
        <div style="display:flex;gap:12px;align-items:center;">
          <select id="insightUserSelect" style="width:200px;">
            <option value="">–í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</option>
          </select>
          <button id="generateInsightsBtn">‚ú® –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫–∏</button>
        </div>
      </div>
      <div id="insightsList" class="small muted">–ù–∞–∂–º–∏ "–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫–∏" –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞</div>
    </div>
  </div>

  <!-- TAB: WORKLOG -->
  <div id="tab-worklog" class="tab-content">
    <div class="grid">
      <div class="card">
        <h3>‚ûï –î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å</h3>
        <div style="display:grid;gap:12px;">
          <select id="worklogUser">
            <option value="">–í—ã–±–µ—Ä–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è‚Ä¶</option>
          </select>
          <input type="date" id="worklogDate" />
          <select id="worklogStatus">
            <option value="working">‚úÖ –í—ã—à–µ–ª –Ω–∞ —Ä–∞–±–æ—Ç—É</option>
            <option value="absent">‚ùå –ù–µ –≤—ã—à–µ–ª –Ω–∞ —Ä–∞–±–æ—Ç—É</option>
            <option value="evening">üåô –í—ã–π–¥–µ—Ç –≤–µ—á–µ—Ä–æ–º</option>
          </select>
          <textarea id="worklogReason" rows="3" placeholder="–ü—Ä–∏—á–∏–Ω–∞ (–µ—Å–ª–∏ –Ω–µ –≤—ã—à–µ–ª)"></textarea>
          <button id="addWorklogBtn">üíæ –î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å</button>
          <div id="worklogStatus" class="small muted"></div>
        </div>
      </div>
      <div class="card">
        <h3>üìú –ò—Å—Ç–æ—Ä–∏—è —Ä–∞–±–æ—Ç—ã</h3>
        <div class="date-navigator">
          <button id="prevDayBtn" class="secondary">‚óÄ</button>
          <div class="current-date" id="currentDate"></div>
          <button id="nextDayBtn" class="secondary">‚ñ∂</button>
        </div>
        <div id="worklogList" style="max-height:500px;overflow:auto;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
      </div>
    </div>
  </div>
</div>

<script>
/* ========= Helpers ========= */
async function fetchJson(url, opts){ const res = await fetch(url, opts); return res.json(); }
const reportsTable = document.getElementById('reportsTable');
const globalSummaryEl = document.getElementById('globalSummary');
const globalChartCtx = document.getElementById('globalChart').getContext('2d');
let globalChart = null;
let teamGrowthChart = null;
let conversionGrowthChart = null;
let currentWorklogDate = new Date();
let isSelectOpen = false;

function escapeHtml(text){
  if(!text && text!==0) return '';
  return String(text).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"'"}[m]));
}

function formatDate(date) {
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  return `${year}-${month}-${day}`;
}

function formatDisplayDate(date) {
  const options = { year: 'numeric', month: 'long', day: 'numeric' };
  return date.toLocaleDateString('ru-RU', options);
}

/* ========= Tab Switching ========= */
document.querySelectorAll('.tab').forEach(tab => {
  tab.addEventListener('click', () => {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
    tab.classList.add('active');
    const tabName = tab.dataset.tab;
    document.getElementById('tab-' + tabName).style.display = 'block';
    
    if(tabName === 'stats'){
      loadStatistics();
    } else if(tabName === 'insights'){
      loadInsights();
    }
  });
});

/* ========= Preserve scroll state and prevent refresh during select interaction ========= */
let lastRefreshTime = Date.now();
const REFRESH_COOLDOWN = 3000;

function preserveStateStart(){
  return {
    scrollY: window.scrollY || document.documentElement.scrollTop || document.body.scrollTop || 0,
    activeElement: document.activeElement,
    activeRowId: (() => {
      const ae = document.activeElement;
      if(!ae) return null;
      const tr = ae.closest && ae.closest('tr');
      return tr ? tr.dataset.reportId : null;
    })()
  };
}

function preserveStateEnd(state){
  window.scrollTo({ top: state.scrollY, behavior: 'auto' });
  if(state.activeElement && document.body.contains(state.activeElement)) {
    try { state.activeElement.focus({ preventScroll: true }); } catch(e) {}
  }
}

// Track when selects are opened
document.addEventListener('mousedown', (e) => {
  if (e.target.tagName === 'SELECT') {
    isSelectOpen = true;
  }
});

document.addEventListener('change', (e) => {
  if (e.target.tagName === 'SELECT') {
    isSelectOpen = false;
  }
});

document.addEventListener('blur', (e) => {
  if (e.target.tagName === 'SELECT') {
    setTimeout(() => { isSelectOpen = false; }, 100);
  }
}, true);

/* ========= REPORTS ========= */
async function loadReports(){
  if (isSelectOpen) return; // Don't refresh if select is open
  
  const state = preserveStateStart();
  try{
    const res = await fetchJson('/api/reports');
    if(!res.ok){ reportsTable.innerHTML='<tr><td colspan="5">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</td></tr>'; preserveStateEnd(state); return; }
    const pendingReports = res.reports.filter(r=>r.status==='pending');

    const existingMap = {};
    reportsTable.querySelectorAll('tr[data-report-id]').forEach(tr=>{
      existingMap[tr.dataset.reportId] = tr;
    });

    pendingReports.forEach(rep=>{
      const id = String(rep.id);
      let tr = existingMap[id];
      if(!tr){
        tr = document.createElement('tr');
        tr.className = 'pending-row';
        tr.dataset.reportId = id;
        tr.innerHTML = `
          <td class="table-username">${escapeHtml(rep.username||'‚Äî')}</td>
          <td class="report-text" style="white-space:normal;word-break:break-word">${escapeHtml(rep.text)}</td>
          <td><input type="number" value="0" style="width:80px" /></td>
          <td>
            <select class="table-select">
              <option value="happn">Happn</option>
              <option value="instagram">Instagram</option>
              <option value="lid">–õ–∏–¥</option>
            </select>
          </td>
          <td>
            <button class="action-btn approve">‚úî</button>
            <button class="action-btn reject" style="margin-left:8px">‚úñ</button>
          </td>
        `;
        reportsTable.appendChild(tr);

        const numInput = tr.querySelector('input');
        const sel = tr.querySelector('select');
        tr.querySelector('.approve').addEventListener('click', async ()=>{
          const num = parseInt(numInput.value)||0;
          const type = sel.value;
          try {
            await fetch(`/api/reports/${id}/approve`,{
              method:'POST',
              headers:{'Content-Type':'application/json'},
              body: JSON.stringify({ number:num, type })
            });
            tr.remove();
            await loadGlobalChart();
            await loadApprovalStats();
          } catch(e){ console.error(e); }
        });
        tr.querySelector('.reject').addEventListener('click', async ()=>{
          try {
            await fetch(`/api/reports/${id}/reject`,{ method:'POST' });
            tr.remove();
            await loadApprovalStats();
          } catch(e){ console.error(e); }
        });
      } else {
        const activeRow = state.activeRowId === id;
        if(!activeRow){
          const numInput = tr.querySelector('input');
          const sel = tr.querySelector('select');
          if(numInput) numInput.value = numInput.value || '0';
          if(sel) sel.value = sel.value || 'happn';
        }
      }
      delete existingMap[id];
    });

    Object.keys(existingMap).forEach(oldId=>{
      const tr = existingMap[oldId];
      if(tr) tr.remove();
    });

  }catch(e){ console.error('loadReports err', e); }
  preserveStateEnd(state);
}

/* ========= GLOBAL CHART ========= */
async function loadGlobalChart(){
  try{
    const res = await fetchJson(`/api/stats/global?period=today`);
    if(!res.ok){ globalSummaryEl.innerText='–û—à–∏–±–∫–∞'; return; }
    const data = res.data || {happn:0,instagram:0,lid:0};
    const total = (data.happn||0)+(data.instagram||0)+(data.lid||0);
    globalSummaryEl.innerText = `–í—Å–µ–≥–æ: ${total} ¬∑ Happn: ${data.happn||0} ¬∑ Instagram: ${data.instagram||0} ¬∑ –õ–∏–¥: ${data.lid||0}`;

    const dataset = [data.happn||0, data.instagram||0, data.lid||0];

    if(globalChart){
      globalChart.data.datasets[0].data = dataset;
      globalChart.update();
    } else {
      globalChart = new Chart(globalChartCtx,{
        type:'doughnut',
        data:{
          labels:['Happn','Instagram','–õ–∏–¥'],
          datasets:[{
            data: dataset,
            backgroundColor:['#f59e0b','#10b981','#3b82f6'],
            borderWidth:0
          }]
        },
        options:{
          plugins:{
            legend:{
              position:'bottom',
              labels:{
                boxWidth:14,
                color:'#8b92a8',
                font:{size:12}
              }
            }
          },
          cutout: '65%',
          animation:{duration:600}
        }
      });
    }
  }catch(e){ console.error('loadGlobalChart err', e); globalSummaryEl.innerText='–û—à–∏–±–∫–∞'; }
}

/* ========= APPROVAL STATS ========= */
async function loadApprovalStats(){
  try{
    const res = await fetchJson('/api/stats/approvals');
    if(!res.ok) return;
    const approved = res.stats.total_approved || 0;
    const rejected = res.stats.total_rejected || 0;
    const total = approved + rejected;
    const ratio = total > 0 ? Math.round((approved / total) * 100) : 0;
    
    document.getElementById('totalApproved').textContent = approved;
    document.getElementById('totalRejected').textContent = rejected;
    document.getElementById('approvalRatio').textContent = `${ratio}% –æ–¥–æ–±—Ä–µ–Ω–æ`;
  }catch(e){ console.error('loadApprovalStats err', e); }
}

/* ========= FEEDBACK ========= */
document.getElementById('sendFeedbackBtn').addEventListener('click', async () => {
  const userId = document.getElementById('feedbackUserSelect').value;
  const text = document.getElementById('feedbackText').value.trim();
  const status = document.getElementById('feedbackStatus');

  if (!userId) { status.textContent = "–í—ã–±–µ—Ä–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è!"; return; }
  if (!text) { status.textContent = "–ù–∞–ø–∏—à–∏ —Ç–µ–∫—Å—Ç —Ñ–∏–¥–±—ç–∫–∞!"; return; }
  status.textContent = "–û—Ç–ø—Ä–∞–≤–∫–∞‚Ä¶";

  try {
    const res = await fetch('/api/feedback/send', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ telegram_id: userId, text })
    });
    const data = await res.json();
    if (data.ok) {
      status.textContent = "‚úÖ –§–∏–¥–±–µ–∫ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!";
      document.getElementById('feedbackText').value = "";
    } else {
      status.textContent = "‚ùå –û—à–∏–±–∫–∞: " + data.error;
    }
  } catch (e) {
    console.error(e);
    status.textContent = "‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è";
  }
});

/* ========= TEAM MANAGEMENT ========= */
async function loadTeam(){
  if (isSelectOpen) return; // Don't refresh if select is open
  
  try{
    const res = await fetchJson('/api/users');
    if(!res.ok){ document.getElementById('teamList').innerText='–û—à–∏–±–∫–∞'; return; }
    
    const teamList = document.getElementById('teamList');
    teamList.innerHTML = '';
    
    res.users.forEach(u=>{
      const div = document.createElement('div');
      div.className='user-row';
      div.dataset.userId = u.id;
      const uname = u.username || ('id:'+u.id);
      div.innerHTML = `
        <span style="font-weight:600;color:var(--accent);flex:1;">${escapeHtml(uname)}</span>
        <select class="table-select role-select" data-user-id="${u.id}">
          <option value="">–í—ã–±—Ä–∞—Ç—å —Ä–æ–ª—å</option>
          <option value="worker" ${u.role==='worker'?'selected':''}>–†–∞–±–æ—Ç–Ω–∏–∫</option>
          <option value="cleaner" ${u.role==='cleaner'?'selected':''}>–£–±–æ—Ä—â–∏–∫</option>
          <option value="accountant" ${u.role==='accountant'?'selected':''}>–ë—É—Ö–≥–∞–ª—Ç–µ—Ä</option>
        </select>
        <button class="action-btn reject delete-user" data-user-id="${u.id}" title="–£–¥–∞–ª–∏—Ç—å">‚úñ</button>
      `;
      teamList.appendChild(div);
    });

    // Role change handlers
    teamList.querySelectorAll('.role-select').forEach(sel => {
      sel.addEventListener('change', async (e) => {
        const userId = e.target.dataset.userId;
        const role = e.target.value;
        try {
          await fetch(`/api/users/${userId}/role`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ role })
          });
        } catch (err) {
          console.error('Role update error', err);
        }
      });
    });

    // Delete handlers
    teamList.querySelectorAll('.delete-user').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        const userId = e.target.dataset.userId;
        if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?')) return;
        try {
          await fetch(`/api/users/${userId}`, { method: 'DELETE' });
          await loadTeam();
        } catch (err) {
          console.error('Delete error', err);
        }
      });
    });

    // Fill selects
    fillFeedbackUsers(res.users);
    fillWorklogUsers(res.users);
    fillInsightUsers(res.users);
    
    // Load team stats
    await loadTeamStats();
  }catch(e){ console.error(e); document.getElementById('teamList').innerText='–û—à–∏–±–∫–∞'; }
}

document.getElementById('addUserBtn').addEventListener('click', async () => {
  const username = document.getElementById('newUsername').value.trim();
  const status = document.getElementById('addUserStatus');
  
  if (!username) {
    status.textContent = '–í–≤–µ–¥–∏ username!';
    return;
  }
  
  status.textContent = '–î–æ–±–∞–≤–ª–µ–Ω–∏–µ...';
  
  try {
    const res = await fetch('/api/users/add', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ username })
    });
    const data = await res.json();
    
    if (data.ok) {
      status.textContent = '‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–±–∞–≤–ª–µ–Ω!';
      document.getElementById('newUsername').value = '';
      await loadTeam();
    } else {
      status.textContent = '‚ùå –û—à–∏–±–∫–∞: ' + data.error;
    }
  } catch (e) {
    console.error(e);
    status.textContent = '‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è';
  }
});

async function loadTeamStats() {
  try {
    const res = await fetchJson('/api/stats/detailed');
    if (!res.ok) return;
    
    const statsEl = document.getElementById('teamStats');
    let html = '<div style="display:grid;gap:12px;">';
    
    res.stats.forEach(user => {
      const total = (user.happn_total || 0) + (user.instagram_total || 0) + (user.lid_total || 0);
      html += `
        <div style="padding:16px;background:rgba(255,255,255,0.03);border-radius:16px;border:1px solid var(--glass-border);">
          <div style="font-weight:600;color:var(--accent);margin-bottom:8px;">${escapeHtml(user.username || 'Unknown')}</div>
          <div class="small" style="margin-bottom:4px;">
            –†–æ–ª—å: ${user.role || '–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∞'} ¬∑ –û—Ç—á–µ—Ç–æ–≤: ${user.approved_reports || 0} ¬∑ –ö–æ–Ω–≤–µ—Ä—Å–∏–π: ${total}
          </div>
          <div class="small">
            Happn: ${user.happn_total || 0} ¬∑ Instagram: ${user.instagram_total || 0} ¬∑ –õ–∏–¥: ${user.lid_total || 0}
          </div>
        </div>
      `;
    });
    
    html += '</div>';
    statsEl.innerHTML = html;
  } catch (e) {
    console.error('Team stats error', e);
  }
}

function fillFeedbackUsers(users){
  const sel = document.getElementById('feedbackUserSelect');
  if(!sel) return;
  const cur = sel.value;
  sel.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è‚Ä¶</option>';
  users.forEach(u=>{
    const option = document.createElement('option');
    option.value = u.telegram_id || '';
    option.textContent = u.username || ('id:'+u.id);
    sel.appendChild(option);
  });
  if(cur) sel.value = cur;
}

function fillWorklogUsers(users){
  const sel = document.getElementById('worklogUser');
  if(!sel) return;
  const cur = sel.value;
  sel.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è‚Ä¶</option>';
  users.forEach(u=>{
    const option = document.createElement('option');
    option.value = u.id;
    option.textContent = u.username || ('id:'+u.id);
    sel.appendChild(option);
  });
  if(cur) sel.value = cur;
}

function fillInsightUsers(users){
  const sel = document.getElementById('insightUserSelect');
  if(!sel) return;
  const cur = sel.value;
  sel.innerHTML = '<option value="">–í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</option>';
  users.forEach(u=>{
    const option = document.createElement('option');
    option.value = u.id;
    option.textContent = u.username || ('id:'+u.id);
    sel.appendChild(option);
  });
  if(cur) sel.value = cur;
}

/* ========= STATISTICS ========= */
async function loadStatistics(){
  await loadTeamGrowth();
  await loadConversionGrowth();
  await loadUserDetailedStats();
  await loadAbsenceRanking();
}

async function loadTeamGrowth(){
  try{
    const res = await fetchJson('/api/stats/growth/team');
    if(!res.ok) return;
    
    const labels = res.growth.map(g => g.date);
    const data = res.growth.map(g => g.count);
    
    // Calculate cumulative
    const cumulative = [];
    let sum = 0;
    data.forEach(v => {
      sum += v;
      cumulative.push(sum);
    });
    
    const ctx = document.getElementById('teamGrowthChart').getContext('2d');
    if(teamGrowthChart){
      teamGrowthChart.data.labels = labels;
      teamGrowthChart.data.datasets[0].data = cumulative;
      teamGrowthChart.update();
    } else {
      teamGrowthChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: '–†–∞–∑–º–µ—Ä –∫–æ–º–∞–Ω–¥—ã',
            data: cumulative,
            backgroundColor: 'rgba(245,158,11,0.8)',
            borderColor: '#f59e0b',
            borderWidth: 2,
            borderRadius: 8
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              labels: {color: '#8b92a8', font: {size: 12}}
            }
          },
          scales: {
            x: {
              ticks: {color: '#8b92a8'},
              grid: {color: 'rgba(255,255,255,0.05)'}
            },
            y: {
              ticks: {
                color: '#8b92a8',
                stepSize: 1
              },
              grid: {color: 'rgba(255,255,255,0.05)'}
            }
          }
        }
      });
    }
  }catch(e){ console.error('loadTeamGrowth err', e); }
}

async function loadConversionGrowth(){
  try{
    const [happnRes, instaRes, lidRes] = await Promise.all([
      fetchJson('/api/stats/growth/happn'),
      fetchJson('/api/stats/growth/instagram'),
      fetchJson('/api/stats/growth/lid')
    ]);
    
    if(!happnRes.ok || !instaRes.ok || !lidRes.ok) return;
    
    // Merge all dates
    const allDates = new Set();
    happnRes.growth.forEach(g => allDates.add(g.date));
    instaRes.growth.forEach(g => allDates.add(g.date));
    lidRes.growth.forEach(g => allDates.add(g.date));
    
    const labels = Array.from(allDates).sort();
    
    const happnData = labels.map(date => {
      const found = happnRes.growth.find(g => g.date === date);
      return found ? found.total : 0;
    });
    
    const instaData = labels.map(date => {
      const found = instaRes.growth.find(g => g.date === date);
      return found ? found.total : 0;
    });
    
    const lidData = labels.map(date => {
      const found = lidRes.growth.find(g => g.date === date);
      return found ? found.total : 0;
    });
    
    const ctx = document.getElementById('conversionGrowthChart').getContext('2d');
    if(conversionGrowthChart){
      conversionGrowthChart.data.labels = labels;
      conversionGrowthChart.data.datasets[0].data = happnData;
      conversionGrowthChart.data.datasets[1].data = instaData;
      conversionGrowthChart.data.datasets[2].data = lidData;
      conversionGrowthChart.update();
    } else {
      conversionGrowthChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'Happn',
              data: happnData,
              backgroundColor: 'rgba(245,158,11,0.8)',
              borderColor: '#f59e0b',
              borderWidth: 2,
              borderRadius: 8
            },
            {
              label: 'Instagram',
              data: instaData,
              backgroundColor: 'rgba(16,185,129,0.8)',
              borderColor: '#10b981',
              borderWidth: 2,
              borderRadius: 8
            },
            {
              label: '–õ–∏–¥',
              data: lidData,
              backgroundColor: 'rgba(59,130,246,0.8)',
              borderColor: '#3b82f6',
              borderWidth: 2,
              borderRadius: 8
            }
          ]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              labels: {color: '#8b92a8', font: {size: 12}}
            }
          },
          scales: {
            x: {
              ticks: {color: '#8b92a8'},
              grid: {color: 'rgba(255,255,255,0.05)'}
            },
            y: {
              ticks: {
                color: '#8b92a8',
                stepSize: 1
              },
              grid: {color: 'rgba(255,255,255,0.05)'}
            }
          }
        }
      });
    }
  }catch(e){ console.error('loadConversionGrowth err', e); }
}

async function loadUserDetailedStats(){
  try{
    const res = await fetchJson('/api/stats/detailed');
    if(!res.ok) return;
    
    const container = document.getElementById('userDetailedStats');
    
    // Sort by total conversions and find top performers
    const sortedStats = res.stats.slice().sort((a, b) => {
      const totalA = (a.happn_total || 0) + (a.instagram_total || 0) + (a.lid_total || 0);
      const totalB = (b.happn_total || 0) + (b.instagram_total || 0) + (b.lid_total || 0);
      return totalB - totalA;
    });
    
    let html = '';
    
    sortedStats.forEach((user, index) => {
      const total = (user.happn_total || 0) + (user.instagram_total || 0) + (user.lid_total || 0);
      const approvalRate = user.total_reports > 0 ? Math.round((user.approved_reports / user.total_reports) * 100) : 0;
      const happnAccounts = user.happn_accounts_created || 0;
      const avgPerDay = happnAccounts > 0 ? (happnAccounts / 7).toFixed(1) : 0;
      const conversionRate = happnAccounts > 0 ? ((total / happnAccounts) * 100).toFixed(1) : 0;
      
      // Determine if top performer
      const isTopPerformer = index < 3 && total > 30;
      const topBadge = isTopPerformer ? `<span class="top-performer-badge">üèÜ –¢–æ–ø-${index + 1}</span>` : '';
      
      html += `
        <div style="padding:20px;background:rgba(255,255,255,0.03);border-radius:16px;border:1px solid var(--glass-border);">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
            <div>
              <div style="font-weight:600;font-size:18px;color:var(--accent);margin-bottom:4px;">
                ${escapeHtml(user.username || 'Unknown')}${topBadge}
              </div>
              <div class="small">–†–æ–ª—å: ${user.role || '–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∞'}</div>
            </div>
            <div style="text-align:right;">
              <div style="font-size:24px;font-weight:700;color:var(--accent);">${total}</div>
              <div class="small">–∫–æ–Ω–≤–µ—Ä—Å–∏–π</div>
            </div>
          </div>
          
          <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:12px;">
            <div class="stat-card">
              <div style="font-size:20px;font-weight:700;color:#f59e0b;">${user.happn_total || 0}</div>
              <div class="stat-label">Happn</div>
            </div>
            <div class="stat-card">
              <div style="font-size:20px;font-weight:700;color:#10b981;">${user.instagram_total || 0}</div>
              <div class="stat-label">Instagram</div>
            </div>
            <div class="stat-card">
              <div style="font-size:20px;font-weight:700;color:#3b82f6;">${user.lid_total || 0}</div>
              <div class="stat-label">–õ–∏–¥</div>
            </div>
          </div>
          
          <div class="detailed-stats-grid">
            <div class="mini-stat">
              <div class="mini-stat-value">${happnAccounts}</div>
              <div class="mini-stat-label">–ê–∫–∫–∞—É–Ω—Ç–æ–≤ Happn (7 –¥–Ω–µ–π)</div>
            </div>
            <div class="mini-stat">
              <div class="mini-stat-value">${avgPerDay}</div>
              <div class="mini-stat-label">–°—Ä–µ–¥–Ω. –∞–∫–∫–∞—É–Ω—Ç–æ–≤/–¥–µ–Ω—å</div>
            </div>
            <div class="mini-stat">
              <div class="mini-stat-value">${conversionRate}%</div>
              <div class="mini-stat-label">–ö–æ–Ω–≤–µ—Ä—Å–∏—è</div>
            </div>
            <div class="mini-stat">
              <div class="mini-stat-value">${user.total_reports || 0}</div>
              <div class="mini-stat-label">–í—Å–µ–≥–æ –æ—Ç—á–µ—Ç–æ–≤</div>
            </div>
            <div class="mini-stat">
              <div class="mini-stat-value">${user.approved_reports || 0}</div>
              <div class="mini-stat-label">–û–¥–æ–±—Ä–µ–Ω–æ</div>
            </div>
            <div class="mini-stat">
              <div class="mini-stat-value">${approvalRate}%</div>
              <div class="mini-stat-label">–ü—Ä–æ—Ü–µ–Ω—Ç –æ–¥–æ–±—Ä–µ–Ω–∏—è</div>
            </div>
          </div>
        </div>
      `;
    });
    
    container.innerHTML = html;
  }catch(e){ console.error('loadUserDetailedStats err', e); }
}

async function loadAbsenceRanking(){
  try{
    const res = await fetchJson('/api/stats/absences');
    if(!res.ok) return;
    
    const container = document.getElementById('absenceRanking');
    
    if(res.ranking.length === 0){
      container.innerHTML = '<div class="small muted">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –ø—Ä–æ–ø—É—Å–∫–∞—Ö üéâ</div>';
      return;
    }
    
    let html = '';
    res.ranking.forEach((user, index) => {
      const rank = index + 1;
      let badgeClass = 'ranking-badge rank-other';
      if(rank === 1) badgeClass = 'ranking-badge rank-1';
      else if(rank === 2) badgeClass = 'ranking-badge rank-2';
      else if(rank === 3) badgeClass = 'ranking-badge rank-3';
      
      html += `
        <div class="ranking-item">
          <div class="${badgeClass}">${rank}</div>
          <div style="flex:1;">
            <div style="font-weight:600;font-size:16px;color:var(--text-primary);">${escapeHtml(user.username || user.display_name || 'Unknown')}</div>
            <div class="small">–ü—Ä–æ–ø—É—Å–∫–æ–≤: ${user.absence_count}</div>
          </div>
        </div>
      `;
    });
    
    container.innerHTML = html;
  }catch(e){ console.error('loadAbsenceRanking err', e); }
}

/* ========= INSIGHTS ========= */
document.getElementById('generateInsightsBtn').addEventListener('click', async () => {
  const btn = document.getElementById('generateInsightsBtn');
  const userId = document.getElementById('insightUserSelect').value;
  
  btn.textContent = '‚è≥ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è...';
  btn.disabled = true;
  
  try {
    const body = userId ? JSON.stringify({ user_id: userId }) : '{}';
    const res = await fetch('/api/insights/generate', { 
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: body
    });
    const data = await res.json();
    
    if (data.ok) {
      await loadInsights();
    }
  } catch (e) {
    console.error('Insights generation error', e);
  } finally {
    btn.textContent = '‚ú® –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫–∏';
    btn.disabled = false;
  }
});

async function loadInsights() {
  try {
    const res = await fetchJson('/api/insights');
    if (!res.ok) return;
    
    const listEl = document.getElementById('insightsList');
    
    if (res.insights.length === 0) {
      listEl.innerHTML = '<div class="small muted">–ù–µ—Ç –ø–æ–¥—Å–∫–∞–∑–æ–∫. –ù–∞–∂–º–∏ "–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫–∏"</div>';
      return;
    }
    
    let html = '';
    res.insights.forEach(insight => {
      let className = 'insight-item';
      if (insight.category === 'success') className += ' insight-success';
      if (insight.category === 'improvement' || insight.category === 'warning') className += ' insight-warning';
      
      html += `<div class="${className}">${escapeHtml(insight.content)}</div>`;
    });
    
    listEl.innerHTML = html;
  } catch (e) {
    console.error('Load insights error', e);
  }
}

/* ========= WORK LOG ========= */
document.getElementById('addWorklogBtn').addEventListener('click', async () => {
  const userId = document.getElementById('worklogUser').value;
  const date = document.getElementById('worklogDate').value;
  const status = document.getElementById('worklogStatus').value;
  const reason = document.getElementById('worklogReason').value.trim();
  const statusEl = document.getElementById('worklogStatus');
  
  if (!userId || !date) {
    statusEl.textContent = '–ó–∞–ø–æ–ª–Ω–∏ –≤—Å–µ –ø–æ–ª—è!';
    return;
  }
  
  try {
    const res = await fetch('/api/worklogs/add', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ user_id: userId, date, status, reason })
    });
    const data = await res.json();
    
    if (data.ok) {
      document.getElementById('worklogStatus').textContent = '‚úÖ –ó–∞–ø–∏—Å—å –¥–æ–±–∞–≤–ª–µ–Ω–∞!';
      document.getElementById('worklogReason').value = '';
      // Reset the select to allow adding another entry
      document.getElementById('worklogUser').value = '';
      document.getElementById('worklogStatus').value = 'working';
      await loadWorklogsByDate(currentWorklogDate);
    }
  } catch (e) {
    console.error('Add worklog error', e);
  }
});

async function loadWorklogsByDate(date) {
  try {
    const dateStr = formatDate(date);
    const res = await fetchJson(`/api/worklogs?date=${dateStr}`);
    if (!res.ok) return;
    
    const listEl = document.getElementById('worklogList');
    document.getElementById('currentDate').textContent = formatDisplayDate(date);
    
    // Update navigation buttons
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const selectedDate = new Date(date);
    selectedDate.setHours(0, 0, 0, 0);
    
    document.getElementById('nextDayBtn').disabled = selectedDate >= today;
    document.getElementById('prevDayBtn').disabled = false;
    
    if (res.logs.length === 0) {
      listEl.innerHTML = '<div class="small muted">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π –∑–∞ —ç—Ç–æ—Ç –¥–µ–Ω—å</div>';
      return;
    }
    
    let html = '';
    res.logs.forEach(log => {
      let badgeClass = 'status-badge ';
      let statusText = '';
      
      if (log.status === 'working') {
        badgeClass += 'status-working';
        statusText = '‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç';
      } else if (log.status === 'absent') {
        badgeClass += 'status-absent';
        statusText = '‚ùå –ù–µ –≤—ã—à–µ–ª';
      } else if (log.status === 'evening') {
        badgeClass += 'status-evening';
        statusText = 'üåô –í–µ—á–µ—Ä–æ–º';
      }
      
      html += `
        <div class="worklog-item">
          <div>
            <div style="font-weight:600;margin-bottom:4px;">${escapeHtml(log.username || 'Unknown')}</div>
            <div class="small muted">${log.reason ? escapeHtml(log.reason) : '‚Äî'}</div>
          </div>
          <span class="${badgeClass}">${statusText}</span>
        </div>
      `;
    });
    
    listEl.innerHTML = html;
  } catch (e) {
    console.error('Load worklogs error', e);
  }
}

// Date navigation
document.getElementById('prevDayBtn').addEventListener('click', () => {
  currentWorklogDate.setDate(currentWorklogDate.getDate() - 1);
  loadWorklogsByDate(currentWorklogDate);
});

document.getElementById('nextDayBtn').addEventListener('click', () => {
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  const nextDate = new Date(currentWorklogDate);
  nextDate.setDate(nextDate.getDate() + 1);
  nextDate.setHours(0, 0, 0, 0);
  
  if (nextDate <= today) {
    currentWorklogDate = nextDate;
    loadWorklogsByDate(currentWorklogDate);
  }
});

// Set today's date as default
document.getElementById('worklogDate').valueAsDate = new Date();
currentWorklogDate = new Date();

/* ========= AUTO-REFRESH ========= */
let periodicHandle = null;

async function refreshAll(){
  if (isSelectOpen) return; // Don't refresh if select is open
  
  const now = Date.now();
  if (now - lastRefreshTime < REFRESH_COOLDOWN) return;
  lastRefreshTime = now;
  
  const state = preserveStateStart();
  await Promise.all([ 
    loadReports(), 
    loadTeam(), 
    loadGlobalChart(),
    loadApprovalStats()
  ]);
  preserveStateEnd(state);
}

(async function init(){
  await refreshAll();
  await loadInsights();
  await loadWorklogsByDate(currentWorklogDate);
  
  if(periodicHandle) clearInterval(periodicHandle);
  periodicHandle = setInterval(async ()=>{ 
    if(document.hidden) return; 
    await refreshAll(); 
  }, 3000);
})();

window.addEventListener('beforeunload', ()=>{ if(periodicHandle) clearInterval(periodicHandle); });
</script>
</body>
</html>