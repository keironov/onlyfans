<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Team Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root{--bg:#0f1724;--card:#111827;--muted:#9ca3af;--accent:#f59e0b;}
html,body{height:100%;margin:0;padding:0;}
body{font-family:Inter,Arial,Helvetica,sans-serif;background:linear-gradient(180deg,#0b1220,#0f1724);color:#e6eef8;}
.wrap{max-width:1200px;margin:24px auto;padding:20px;}
.top{display:flex;gap:12px;align-items:center;justify-content:space-between;}
.card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:12px;padding:16px;box-shadow: 0 6px 18px rgba(2,6,23,0.6);margin-bottom:12px;}
.grid{display:grid;grid-template-columns:1fr 420px;gap:16px;}
.team-list{max-height:540px;overflow:auto;padding:8px;}
.user-row{display:flex;justify-content:space-between;padding:8px;border-bottom:1px dashed rgba(255,255,255,0.03);}
.muted{color:var(--muted);font-size:13px;}
input,textarea,select{width:100%;padding:6px;border-radius:6px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit;box-sizing:border-box;}
button{background:var(--accent);color:#081125;border:none;padding:6px 10px;border-radius:8px;cursor:pointer;font-weight:600;}
.small{font-size:13px;color:var(--muted);}
h1,h3{margin:0 0 8px 0;}
table{width:100%;border-collapse:collapse;color:#e6eef8;}
th,td{padding:6px;border-bottom:1px solid rgba(255,255,255,0.1);text-align:left;}
td input,td select{width:auto;}
</style>
</head>
<body>
<div class="wrap">
  <div class="top">
    <div>
      <h1>Team Dashboard</h1>
      <div class="muted">Webhook bot mode — Telegram интеграция через WEBHOOK</div>
    </div>
    <div>
      <button id="refreshBtn">Refresh</button>
    </div>
  </div>

  <div class="grid">
    <div>
      <div class="card">
        <h3>Global Stats</h3>
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
          <span class="small muted" id="globalSummary">Loading...</span>
          <select id="globalPeriod" style="width:120px;">
            <option value="today">Сегодня</option>
            <option value="yesterday">Вчера</option>
            <option value="week">Неделя</option>
            <option value="month">Месяц</option>
          </select>
        </div>
        <canvas id="globalChart" style="height:220px;"></canvas>
      </div>

      <div class="card">
        <h3>Pending Reports (ОТЧЕТ)</h3>
        <table>
          <thead>
            <tr><th>@user</th><th>Text</th><th>Number</th><th>Type</th><th>✔ / ❌</th></tr>
          </thead>
          <tbody id="reportsTable"></tbody>
        </table>
      </div>
    </div>

    <div>
      <div class="card">
        <h3>Team</h3>
        <div id="teamList" class="team-list small muted">Loading...</div>
      </div>

      <div class="card">
        <h3>User Summary</h3>
        <div style="display:grid;gap:8px">
          <input id="viewUsername" placeholder="username to view (e.g. @ivan)" />
          <button id="viewUserBtn">View</button>
          <div id="userSummary" class="small muted">No user selected</div>
          <canvas id="userActivityChart" style="height:180px;"></canvas>
          <pre id="userReports" class="small muted" style="white-space:pre-wrap;"></pre>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
async function fetchJson(url, opts){ const res = await fetch(url, opts); return res.json(); }

// ====== Global Stats (Donut) ======
const globalCtx = document.getElementById('globalChart').getContext('2d');
let globalChart = null;
let globalPeriod = 'today';

async function loadGlobalChart(){
  try{
    const res = await fetch(`/api/stats/global?period=${globalPeriod}`);
    const json = await res.json();
    if(!json.ok) return;

    const data = json.data;
    const total = Object.values(data).reduce((a,b)=>a+b,0);
    document.getElementById('globalSummary').innerText = `Всего: ${total} (${data.happn} Happn, ${data.instagram} Instagram, ${data.lid} Лиды)`;

    const chartData = {
      labels: ['Happn','Instagram','Лиды'],
      datasets: [{
        data: [data.happn,data.instagram,data.lid],
        backgroundColor: ['#f59e0b','#3b82f6','#10b981'],
        borderColor: '#0f1724',
        borderWidth: 2
      }]
    };

    if(globalChart) globalChart.destroy();
    globalChart = new Chart(globalCtx,{
      type:'doughnut',
      data: chartData,
      options:{
        plugins:{legend:{position:'bottom'}},
        cutout:'60%',
        responsive:true
      }
    });

  }catch(e){ console.error(e); }
}
document.getElementById('globalPeriod').addEventListener('change', (e)=>{
  globalPeriod = e.target.value;
  loadGlobalChart();
});

// ====== Pending Reports ======
const reportsTable = document.getElementById('reportsTable');
async function loadReports(){
  try{
    const res = await fetchJson('/api/reports');
    if(!res.ok){ reportsTable.innerHTML='<tr><td colspan="5">Ошибка загрузки</td></tr>'; return; }

    const pendingReports = res.reports.filter(r=>r.status==='pending');
    reportsTable.innerHTML = '';

    pendingReports.forEach(rep=>{
      const tr = document.createElement('tr');
      tr.innerHTML=`
        <td>${rep.username||'—'}</td>
        <td>${rep.text}</td>
        <td><input type="number" value="0" style="width:60px"/></td>
        <td>
          <select>
            <option value="happn">Happn</option>
            <option value="instagram">Instagram</option>
            <option value="lid">Лид</option>
          </select>
        </td>
        <td>
          <button style="background:#10b981;color:#081125;padding:2px 6px;margin-right:4px;cursor:pointer">✔</button>
          <button style="background:#ef4444;color:#fff;padding:2px 6px;cursor:pointer">❌</button>
        </td>
      `;
      const numberInput = tr.querySelector('input');
      const typeSelect = tr.querySelector('select');

      tr.querySelector('button:first-child').addEventListener('click', async ()=>{
        const number = parseInt(numberInput.value)||0;
        const type = typeSelect.value;
        await fetch(`/api/reports/${rep.id}/approve`,{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({number,type})
        });
        tr.remove();
        loadGlobalChart();
      });
      tr.querySelector('button:last-child').addEventListener('click', async ()=>{
        await fetch(`/api/reports/${rep.id}/reject`,{method:'POST'});
        tr.remove();
      });
      reportsTable.appendChild(tr);
    });
  }catch(e){ console.error(e); }
}

// ====== Team List ======
const teamListDiv = document.getElementById('teamList');
async function loadTeam(){
  try{
    const res = await fetchJson('/api/users');
    if(!res.ok){ teamListDiv.innerText='Ошибка загрузки'; return; }
    teamListDiv.innerHTML='';
    res.users.forEach(u=>{
      const div = document.createElement('div');
      div.style.display='flex'; div.style.justifyContent='space-between'; div.style.alignItems='center'; div.style.marginBottom='4px';
      const nameSpan = document.createElement('span'); nameSpan.innerText = u.username || u.display_name;
      const roleSelect = document.createElement('select');
      ['работник','уборщик','бухгалтер'].forEach(role=>{
        const opt = document.createElement('option'); opt.value=role; opt.innerText=role;
        roleSelect.appendChild(opt);
      });
      div.appendChild(nameSpan); div.appendChild(roleSelect);
      teamListDiv.appendChild(div);
    });
  }catch(e){ console.error(e); }
}

// ====== User Summary ======
const viewBtn = document.getElementById('viewUserBtn');
let currentUser=null;
viewBtn.addEventListener('click', async ()=>{
  const username = document.getElementById('viewUsername').value.trim();
  if(!username) return;
  try{
    const usersRes = await fetchJson('/api/users');
    currentUser = usersRes.users.find(u=>u.username===username);
    if(!currentUser){ document.getElementById('userSummary').innerText='Пользователь не найден'; return; }
    updateUserSummary();
  }catch(e){ console.error(e); }
});

async function updateUserSummary(){
  if(!currentUser) return;
  const reportsRes = await fetchJson('/api/reports');
  const userReports = reportsRes.reports.filter(r=>r.user_id===currentUser.id && r.status==='approved');
  const total = userReports.reduce((a,b)=>b.number? a+parseInt(b.number):a,0);
  document.getElementById('userSummary').innerText = `Всего: ${total} (${userReports.length} отчета)`;

  const ctx = document.getElementById('userActivityChart').getContext('2d');
  const typeCount = {happn:0,instagram:0,lid:0};
  userReports.forEach(r=>{ if(r.number && r.type) typeCount[r.type]+=parseInt(r.number)||0; });
  const chartData = {labels:['Happn','Instagram','Лиды'],datasets:[{data:[typeCount.happn,typeCount.instagram,typeCount.lid],backgroundColor:['#f59e0b','#3b82f6','#10b981'],borderColor:'#0f1724',borderWidth:2}]};
  if(window.userChart) window.userChart.destroy();
  window.userChart = new Chart(ctx,{type:'doughnut',data:chartData,options:{plugins:{legend:{position:'bottom'}},cutout:'60%'}});
  document.getElementById('userReports').innerText = userReports.map(r=>`${r.text} (${r.number} ${r.type})`).join('\n');
}

// ====== Auto-refresh ======
async function autoRefresh(){
  loadReports();
  loadTeam();
  loadGlobalChart();
  updateUserSummary();
}
setInterval(autoRefresh, 3000); // каждые 3 секунды

// ====== Initial Load ======
loadReports(); loadTeam(); loadGlobalChart(); 
</script>
</body>
</html>
