<!DOCTYPE html>
<html>
<head>
  <title>Admin Dashboard</title>
  <style>
    body { font-family: sans-serif; background:#111; color:#fff; padding:20px;}
    input, button { padding:5px; margin:5px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { padding: 5px; border: 1px solid #444; text-align: left; }
    button { cursor: pointer; }
  </style>
</head>
<body>
  <h1>Admin Dashboard</h1>
  <div>
    <input id="username" placeholder="Введите username">
    <button onclick="loadUser()">Load</button>
  </div>

  <div id="feedbackDiv">
    <h3>Отправить фидбэк</h3>
    <input id="feedbackUsername" placeholder="Username">
    <input id="feedbackFrom" placeholder="От кого">
    <input id="feedbackMessage" placeholder="Сообщение">
    <button onclick="sendFeedback()">Отправить</button>
  </div>

  <div id="reports"></div>

  <script>
    async function loadUser() {
      const username = document.getElementById('username').value;
      if(!username) return alert('Введите username');

      const res = await fetch(`/api/user/${username}`);
      if(!res.ok) return alert('User not found');
      const data = await res.json();

      let html = `<h2>${username}</h2>`;
      html += `<h3>Сегодня</h3>`;
      html += createTable(data.reportsToday);
      html += `<h3>Вчера</h3>`;
      html += createTable(data.reportsYesterday);
      html += `<h3>Все отчёты</h3>`;
      html += createTable(data.reports);

      document.getElementById('reports').innerHTML = html;
    }

    function createTable(reports){
      if(!reports.length) return '<p>Нет отчётов</p>';
      let html = `<table><tr><th>Сообщение</th><th>Дата</th><th>Статус</th><th>Действие</th></tr>`;
      reports.forEach(r=>{
        html += `<tr>
          <td>${r.message}</td>
          <td>${new Date(r.date).toLocaleString()}</td>
          <td>${r.checked ? '✔' : '❌'}</td>
          <td>
            ${r.checked ? '' : `<button onclick="markDone(${r.id})">Сделано</button>`}
          </td>
        </tr>`;
      });
      html += `</table>`;
      return html;
    }

    async function markDone(id){
      await fetch(`/api/report/${id}/done`, {method:'POST'});
      loadUser();
    }

    async function sendFeedback(){
      const username = document.getElementById('feedbackUsername').value;
      const from = document.getElementById('feedbackFrom').value;
      const message = document.getElementById('feedbackMessage').value;
      if(!username || !message) return alert('Заполните поля');

      await fetch('/api/feedback',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({username,message,from_admin:from})
      });
      alert('Фидбэк отправлен!');
    }

    setInterval(()=>{
      const username = document.getElementById('username').value;
      if(username) loadUser();
    }, 10000); // автообновление каждые 10 секунд
  </script>
</body>
</html>
