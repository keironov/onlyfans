<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Team Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root{--bg:#0f1724;--card:#111827;--muted:#9ca3af;--accent:#f59e0b;}
html,body{height:100%;margin:0;padding:0;}
body{font-family:Inter,Arial,Helvetica,sans-serif;background:linear-gradient(180deg,#0b1220,#0f1724);color:#e6eef8;}
.wrap{max-width:1200px;margin:24px auto;padding:20px;}
.top{display:flex;gap:12px;align-items:center;justify-content:space-between;}
.card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:12px;padding:16px;box-shadow: 0 6px 18px rgba(2,6,23,0.6);margin-bottom:12px;}
.grid{display:grid;grid-template-columns:1fr 420px;gap:16px;}
.team-list{max-height:540px;overflow:auto;padding:8px;}
.user-row{display:flex;justify-content:space-between;padding:8px;border-bottom:1px dashed rgba(255,255,255,0.03);}
.muted{color:var(--muted);font-size:13px;}
input,textarea,select{width:100%;padding:6px;border-radius:6px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit;box-sizing:border-box;}
button{background:var(--accent);color:#081125;border:none;padding:6px 10px;border-radius:8px;cursor:pointer;font-weight:600;}
.small{font-size:13px;color:var(--muted);}
h1,h3{margin:0 0 8px 0;}
#userPickerOverlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.45);z-index:1999;}
#userPickerModal{display:none;position:fixed;top:20%;left:50%;transform:translateX(-50%);background:var(--card);padding:16px;border-radius:10px;box-shadow:0 0 30px rgba(0,0,0,0.6);width:320px;max-height:60%;overflow-y:auto;z-index:2000;}
.user-picker-item{padding:8px;cursor:pointer;border-radius:6px;}
.user-picker-item:hover{background:rgba(255,255,255,0.02);}
.muted-small{color:var(--muted);font-size:12px;}
table{width:100%;border-collapse:collapse;color:#e6eef8;}
th,td{padding:6px;border-bottom:1px solid rgba(255,255,255,0.1);text-align:left;}
td input,td select{width:auto;}
</style>
</head>
<body>
<div class="wrap">
  <div class="top">
    <div>
      <h1>Team Dashboard</h1>
      <div class="muted">Webhook bot mode — Telegram интеграция через WEBHOOK</div>
    </div>
    <div>
      <button id="refreshBtn">Refresh</button>
    </div>
  </div>

  <div class="grid">
    <div>
      <div class="card">
        <h3>Global Stats</h3>
        <div style="display:flex;align-items:center;justify-content:space-between;">
          <div id="globalSummary" class="small muted">Loading...</div>
          <select id="periodSelect">
            <option value="today">Сегодня</option>
            <option value="yesterday">Вчера</option>
            <option value="week">Неделя</option>
            <option value="month">Месяц</option>
          </select>
        </div>
        <canvas id="globalChart" style="height:220px;"></canvas>
      </div>

      <div class="card">
        <h3>Отчеты</h3>
        <table>
          <thead>
            <tr><th>@user</th><th>Text</th><th>Number</th><th>Type</th><th>✔ / ❌</th></tr>
          </thead>
          <tbody id="reportsTable"></tbody>
        </table>
      </div>
    </div>

    <div>
      <div class="card">
        <h3>Team</h3>
        <div id="teamList" class="team-list small muted">Loading...</div>
      </div>

      <div class="card">
        <h3>User Summary</h3>
        <div style="display:grid;gap:8px">
          <input id="viewUsername" placeholder="username to view (e.g. @ivan)" />
          <button id="viewUserBtn">View</button>
          <div id="userSummary" class="small muted">No user selected</div>
          <canvas id="userActivityChart" style="height:180px;"></canvas>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="userPickerOverlay"></div>
<div id="userPickerModal" role="dialog" aria-modal="true" aria-labelledby="userPickerTitle">
  <div id="userPickerTitle" style="font-weight:bold; margin-bottom:8px;">Выбери пользователя</div>
  <div id="userPickerList" class="small muted">Loading...</div>
  <div style="display:flex; gap:8px; margin-top:8px; justify-content:flex-end;">
    <button id="closePickerBtn" type="button">Закрыть</button>
  </div>
</div>

<script>
const reportsTable = document.getElementById('reportsTable');
const teamListEl = document.getElementById('teamList');
const globalSummaryEl = document.getElementById('globalSummary');
const globalChartCtx = document.getElementById('globalChart').getContext('2d');
let globalChart = null;

async function fetchJson(url, opts){ const res = await fetch(url, opts); return res.json(); }

// ======= PENDING REPORTS =======
async function loadReports(){
  try{
    const res = await fetchJson('/api/reports');
    if(!res.ok){ reportsTable.innerHTML='<tr><td colspan="5">Ошибка загрузки</td></tr>'; return; }
    const pendingReports = res.reports.filter(r=>r.status==='pending');

    const existingRows = {};
    reportsTable.querySelectorAll('tr').forEach(tr=>{
      const rid = tr.dataset.reportId;
      if(rid){
        const number = tr.querySelector('input')?.value || 0;
        const type = tr.querySelector('select')?.value || 'happn';
        existingRows[rid] = { number, type };
      }
    });

    pendingReports.forEach(rep=>{
      let tr = reportsTable.querySelector(`tr[data-report-id="${rep.id}"]`);
      if(!tr){
        tr = document.createElement('tr');
        tr.dataset.reportId = rep.id;
        tr.innerHTML=`
          <td>${rep.username||'—'}</td>
          <td>${rep.text}</td>
          <td><input type="number" value="0" style="width:60px"/></td>
          <td>
            <select>
              <option value="happn">Happn</option>
              <option value="instagram">Instagram</option>
              <option value="lid">Лид</option>
            </select>
          </td>
          <td>
            <button style="background:#10b981;color:#081125;padding:2px 6px;margin-right:4px;cursor:pointer">✔</button>
            <button style="background:#ef4444;color:#fff;padding:2px 6px;cursor:pointer">❌</button>
          </td>
        `;
        reportsTable.appendChild(tr);

        const numberInput = tr.querySelector('input');
        const typeSelect = tr.querySelector('select');

        tr.querySelector('button:first-child').addEventListener('click', async ()=>{
          const number = parseInt(numberInput.value)||0;
          const type = typeSelect.value;
          await fetch(`/api/reports/${rep.id}/approve`,{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({number,type})
          });
          tr.remove();
          loadGlobalChart();
        });
        tr.querySelector('button:last-child').addEventListener('click', async ()=>{
          await fetch(`/api/reports/${rep.id}/reject`,{method:'POST'});
          tr.remove();
        });
      } else {
        // Обновляем значения без пересоздания
        if(existingRows[rep.id]){
          tr.querySelector('input').value = existingRows[rep.id].number;
          tr.querySelector('select').value = existingRows[rep.id].type;
        }
      }
    });
  }catch(e){ console.error(e); }
}

// ======= TEAM LIST =======
async function loadTeam(){
  try{
    const res = await fetchJson('/api/users');
    if(!res.ok){ teamListEl.innerText='Ошибка'; return; }
    teamListEl.innerHTML='';
    res.users.forEach(u=>{
      const div = document.createElement('div');
      div.className='user-row';
      div.innerHTML=`
        <span>${u.username||'—'}</span>
        <select>
          <option value="">Выбрать роль</option>
          <option value="worker">Работник</option>
          <option value="cleaner">Уборщик</option>
          <option value="accountant">Бухгалтер</option>
        </select>
      `;
      teamListEl.appendChild(div);
    });
  }catch(e){ console.error(e); }
}

// ======= GLOBAL CHART =======
async function loadGlobalChart(){
  try{
    const period = document.getElementById('periodSelect').value;
    const res = await fetchJson(`/api/stats/global?period=${period}`);
    if(!res.ok){ globalSummaryEl.innerText='Ошибка'; return; }
    const data = res.data;
    const total = data.happn+data.instagram+data.lid;
    globalSummaryEl.innerText = `Всего: ${total} · Happn: ${data.happn} · Instagram: ${data.instagram} · Лид: ${data.lid}`;

    if(globalChart){
      globalChart.data.datasets[0].data = [data.happn,data.instagram,data.lid];
      globalChart.update();
    } else {
      globalChart = new Chart(globalChartCtx,{
        type:'doughnut',
        data:{
          labels:['Happn','Instagram','Лид'],
          datasets:[{
            data:[data.happn,data.instagram,data.lid],
            backgroundColor:['#f59e0b','#10b981','#3b82f6']
          }]
        },
        options:{
          plugins:{legend:{position:'bottom'}},
          cutout:'60%',
          animation:{duration:500}
        }
      });
    }
  }catch(e){ console.error(e); }
}

// ======= USER SUMMARY =======
document.getElementById('viewUserBtn').addEventListener('click', async ()=>{
  const username = document.getElementById('viewUsername').value.trim();
  if(!username) return;
  try{
    const users = await fetchJson('/api/users');
    const user = users.users.find(u=>u.username===username);
    if(!user){ document.getElementById('userSummary').innerText='Не найден'; return; }

    const reports = await fetchJson('/api/reports');
    const userReports = reports.reports.filter(r=>r.user_id===user.id && r.status==='approved');

    const total = userReports.reduce((a,b)=>a+(b.number||0),0);
    const byType = {happn:0, instagram:0, lid:0};
    userReports.forEach(r=>{ if(r.type) byType[r.type]+=parseInt(r.number)||0; });

    document.getElementById('userSummary').innerText=
      `Всего: ${total} · Happn: ${byType.happn} · Instagram: ${byType.instagram} · Лид: ${byType.lid}`;

    const ctx = document.getElementById('userActivityChart').getContext('2d');
    if(window.userChart){
      window.userChart.data.datasets[0].data = [byType.happn,byType.instagram,byType.lid];
      window.userChart.update();
    } else {
      window.userChart = new Chart(ctx,{
        type:'doughnut',
        data:{
          labels:['Happn','Instagram','Лид'],
          datasets:[{
            data:[byType.happn,byType.instagram,byType.lid],
            backgroundColor:['#f59e0b','#10b981','#3b82f6']
          }]
        },
        options:{cutout:'60%', animation:{duration:500}}
      });
    }
  }catch(e){ console.error(e); }
});

// ======= AUTO REFRESH =======
async function refreshAll(){
  await loadReports();
  await loadTeam();
  await loadGlobalChart();
}

document.getElementById('refreshBtn').addEventListener('click', refreshAll);
document.getElementById('periodSelect').addEventListener('change', loadGlobalChart);

// Initial load
refreshAll();
setInterval(refreshAll,3000);
</script>
</body>
</html>
