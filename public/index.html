<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Team Dashboard - Enhanced v3</title>
<link rel="icon" href="https://public-frontend-cos.metadl.com/mgx/img/favicon.png" type="image/png">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root{
  --bg-primary:#0a0e1a;
  --bg-secondary:#0f1419;
  --glass-bg:rgba(255,255,255,0.03);
  --glass-border:rgba(255,255,255,0.08);
  --text-primary:#e8f0ff;
  --text-secondary:#8b92a8;
  --accent:#f59e0b;
  --accent-hover:#fbbf24;
  --accent-green:#10b981;
  --accent-red:#ef4444;
  --accent-blue:#3b82f6;
  --accent-purple:#a855f7;
  --shadow:0 8px 32px rgba(0,0,0,0.4);
}

*{box-sizing:border-box;margin:0;padding:0;}

html,body{
  height:100%;
  background:radial-gradient(ellipse at top, #1a1f35 0%, var(--bg-primary) 50%);
  color:var(--text-primary);
  font-family:'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
  overflow-x:hidden;
}

body::before{
  content:'';
  position:fixed;
  top:0;left:0;right:0;bottom:0;
  background:
    radial-gradient(circle at 20% 30%, rgba(245,158,11,0.08) 0%, transparent 50%),
    radial-gradient(circle at 80% 70%, rgba(59,130,246,0.06) 0%, transparent 50%);
  pointer-events:none;
  z-index:0;
}

.wrap{
  max-width:1600px;
  margin:0 auto;
  padding:24px;
  position:relative;
  z-index:1;
}

.top{
  display:flex;
  gap:16px;
  align-items:center;
  justify-content:space-between;
  margin-bottom:24px;
  padding:24px;
  background:var(--glass-bg);
  backdrop-filter:blur(20px);
  border-radius:24px;
  border:1px solid var(--glass-border);
  box-shadow:var(--shadow);
}

.top h1{
  font-size:32px;
  font-weight:700;
  background:linear-gradient(135deg, var(--accent) 0%, var(--accent-hover) 100%);
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
  margin-bottom:4px;
}

.muted{color:var(--text-secondary);font-size:14px;}
.small{font-size:13px;color:var(--text-secondary);}

.card{
  background:var(--glass-bg);
  backdrop-filter:blur(20px);
  border-radius:24px;
  padding:24px;
  border:1px solid var(--glass-border);
  box-shadow:var(--shadow);
  margin-bottom:20px;
  transition:all 0.3s ease;
}

.card:hover{
  border-color:rgba(245,158,11,0.2);
  box-shadow:0 12px 48px rgba(0,0,0,0.5);
  transform:translateY(-2px);
}

.card h3{
  font-size:20px;
  font-weight:600;
  margin-bottom:16px;
  color:var(--text-primary);
}

.grid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:20px;
}

.grid-3{
  display:grid;
  grid-template-columns:repeat(3, 1fr);
  gap:20px;
}

.grid-4{
  display:grid;
  grid-template-columns:repeat(4, 1fr);
  gap:16px;
}

input,textarea,select{
  width:100%;
  padding:12px 16px;
  border-radius:16px;
  border:1px solid var(--glass-border);
  background:rgba(255,255,255,0.02);
  color:var(--text-primary);
  outline:none;
  transition:all 0.3s ease;
  font-size:14px;
}

input:focus,textarea:focus,select:focus{
  background:rgba(255,255,255,0.04);
  border-color:var(--accent);
  box-shadow:0 0 0 3px rgba(245,158,11,0.1);
}

select {
  appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%238b92a8' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 12px center;
  padding-right: 36px;
  cursor: pointer;
}

select option {
  background: var(--bg-secondary);
  color: var(--text-primary);
  padding: 12px;
}

input[type="date"] {
  position: relative;
  cursor: pointer;
}

input[type="number"]{
  width:90px;
  text-align:center;
}

button{
  background:linear-gradient(135deg, var(--accent) 0%, var(--accent-hover) 100%);
  color:#0a0e1a;
  border:none;
  padding:12px 24px;
  border-radius:16px;
  cursor:pointer;
  font-weight:600;
  font-size:14px;
  transition:all 0.3s ease;
  box-shadow:0 4px 16px rgba(245,158,11,0.3);
}

button:hover{
  transform:translateY(-2px);
  box-shadow:0 6px 24px rgba(245,158,11,0.4);
}

button:active{
  transform:translateY(0);
}

button.secondary{
  background:rgba(255,255,255,0.05);
  color:var(--text-primary);
  border:1px solid var(--glass-border);
  box-shadow:none;
}

button.secondary:hover{
  background:rgba(255,255,255,0.08);
  border-color:var(--accent);
}

button.danger{
  background:linear-gradient(135deg, var(--accent-red) 0%, #dc2626 100%);
  color:#fff;
  box-shadow:0 4px 16px rgba(239,68,68,0.3);
}

button.small-btn{
  padding:8px 16px;
  font-size:12px;
}

.action-btn{
  width:40px;
  height:40px;
  border-radius:12px;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  font-weight:700;
  cursor:pointer;
  border:none;
  transition:all 0.3s ease;
}

.approve{
  background:linear-gradient(135deg, var(--accent-green) 0%, #059669 100%);
  color:#fff;
  box-shadow:0 4px 12px rgba(16,185,129,0.3);
}

.approve:hover{transform:scale(1.05);}

.reject{
  background:linear-gradient(135deg, var(--accent-red) 0%, #dc2626 100%);
  color:#fff;
  box-shadow:0 4px 12px rgba(239,68,68,0.3);
}

.reject:hover{transform:scale(1.05);}

table{
  width:100%;
  border-collapse:separate;
  border-spacing:0 8px;
}

th,td{
  padding:12px 16px;
  text-align:left;
  vertical-align:middle;
}

thead th{
  color:var(--text-secondary);
  font-weight:600;
  font-size:13px;
  text-transform:uppercase;
  letter-spacing:0.5px;
  border-bottom:1px solid var(--glass-border);
}

tbody tr{
  background:rgba(255,255,255,0.02);
  border-radius:12px;
  transition:all 0.3s ease;
}

tbody tr:hover{
  background:rgba(255,255,255,0.04);
  transform:translateX(4px);
}

.table-select{
  width:160px;
  padding:8px 12px;
  border-radius:12px;
}

canvas{max-width:100%;border-radius:16px;}

.tabs{
  display:flex;
  gap:12px;
  margin-bottom:24px;
  padding:8px;
  background:var(--glass-bg);
  backdrop-filter:blur(20px);
  border-radius:20px;
  border:1px solid var(--glass-border);
  flex-wrap:wrap;
}

.tab{
  padding:12px 24px;
  cursor:pointer;
  border-radius:14px;
  transition:all 0.3s ease;
  font-weight:500;
  color:var(--text-secondary);
}

.tab:hover{
  background:rgba(255,255,255,0.05);
  color:var(--text-primary);
}

.tab.active{
  background:linear-gradient(135deg, var(--accent) 0%, var(--accent-hover) 100%);
  color:#0a0e1a;
  box-shadow:0 4px 16px rgba(245,158,11,0.3);
}

.tab-content{display:none;}

.stat-card{
  background:rgba(255,255,255,0.03);
  border-radius:16px;
  padding:20px;
  border:1px solid var(--glass-border);
  transition:all 0.3s ease;
  text-align:center;
}

.stat-card:hover{
  background:rgba(255,255,255,0.05);
  border-color:var(--accent);
  transform:translateY(-2px);
}

.stat-number{
  font-size:32px;
  font-weight:700;
  background:linear-gradient(135deg, var(--accent) 0%, var(--accent-hover) 100%);
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
  margin-bottom:4px;
}

.stat-label{
  font-size:13px;
  color:var(--text-secondary);
  text-transform:uppercase;
  letter-spacing:0.5px;
}

.user-row{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:12px 16px;
  margin:6px 0;
  border-radius:12px;
  background:rgba(255,255,255,0.02);
  border:1px solid var(--glass-border);
  transition:all 0.3s ease;
  gap:12px;
}

.user-row:hover{
  background:rgba(255,255,255,0.04);
  border-color:var(--accent);
}

.team-list{
  max-height:500px;
  overflow:auto;
  padding:8px;
}

.team-list::-webkit-scrollbar{width:8px;}
.team-list::-webkit-scrollbar-track{background:rgba(255,255,255,0.02);border-radius:8px;}
.team-list::-webkit-scrollbar-thumb{background:var(--accent);border-radius:8px;}

.period-buttons{
  display:flex;
  gap:8px;
  margin-bottom:16px;
  flex-wrap:wrap;
}

.period-btn{
  padding:8px 16px;
  border-radius:12px;
  background:rgba(255,255,255,0.05);
  border:1px solid var(--glass-border);
  color:var(--text-secondary);
  cursor:pointer;
  transition:all 0.3s ease;
  font-size:13px;
}

.period-btn:hover{
  background:rgba(255,255,255,0.08);
  color:var(--text-primary);
}

.period-btn.active{
  background:linear-gradient(135deg, var(--accent) 0%, var(--accent-hover) 100%);
  color:#0a0e1a;
  border-color:var(--accent);
}

.date-range-picker{
  display:flex;
  gap:12px;
  align-items:center;
  margin-top:12px;
  padding:12px;
  background:rgba(255,255,255,0.02);
  border-radius:12px;
  border:1px solid var(--glass-border);
}

.progress-bar{
  width:100%;
  height:8px;
  background:rgba(255,255,255,0.05);
  border-radius:8px;
  overflow:hidden;
  position:relative;
}

.progress-fill{
  height:100%;
  background:linear-gradient(90deg, var(--accent) 0%, var(--accent-hover) 100%);
  border-radius:8px;
  transition:width 0.5s ease;
  position:relative;
}

.progress-fill::after{
  content:'';
  position:absolute;
  top:0;
  right:0;
  width:20px;
  height:100%;
  background:rgba(255,255,255,0.3);
  border-radius:8px;
}

.note-item{
  padding:12px;
  margin:8px 0;
  background:rgba(255,255,255,0.03);
  border-radius:12px;
  border:1px solid var(--glass-border);
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:12px;
}

.note-item:hover{
  background:rgba(255,255,255,0.05);
}

.notes-list{
  max-height:300px;
  overflow:auto;
}

/* Sticky Notes Styles */
.sticky-notes-grid{
  display:grid;
  grid-template-columns:repeat(auto-fill, minmax(280px, 1fr));
  gap:20px;
  padding:8px;
}

.sticky-note{
  position:relative;
  min-height:200px;
  padding:20px;
  border-radius:4px;
  box-shadow:0 4px 12px rgba(0,0,0,0.3), 0 2px 4px rgba(0,0,0,0.2);
  transition:all 0.3s ease;
  cursor:pointer;
  transform:rotate(-1deg);
  animation:fadeIn 0.5s ease;
}

.sticky-note:nth-child(even){
  transform:rotate(1deg);
}

.sticky-note:hover{
  transform:rotate(0deg) scale(1.02);
  box-shadow:0 8px 24px rgba(0,0,0,0.4), 0 4px 8px rgba(0,0,0,0.3);
  z-index:10;
}

.sticky-note.completed{
  opacity:0.6;
  filter:grayscale(0.5);
  transform:rotate(-2deg) scale(0.95);
  transition:all 0.5s ease;
}

.sticky-note.completed:hover{
  opacity:0.8;
  transform:rotate(0deg) scale(0.98);
}

.sticky-note.yellow{
  background:linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
  color:#78350f;
}

.sticky-note.pink{
  background:linear-gradient(135deg, #fce7f3 0%, #fbcfe8 100%);
  color:#831843;
}

.sticky-note.blue{
  background:linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
  color:#1e3a8a;
}

.sticky-note.green{
  background:linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
  color:#064e3b;
}

.sticky-note.purple{
  background:linear-gradient(135deg, #e9d5ff 0%, #d8b4fe 100%);
  color:#581c87;
}

.sticky-note::before{
  content:'';
  position:absolute;
  top:0;
  left:50%;
  transform:translateX(-50%);
  width:60px;
  height:20px;
  background:rgba(0,0,0,0.1);
  border-radius:0 0 8px 8px;
}

.sticky-note-header{
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
  margin-bottom:12px;
  padding-top:8px;
}

.sticky-note-date{
  font-size:11px;
  opacity:0.7;
  font-weight:600;
}

.sticky-note-actions{
  display:flex;
  gap:8px;
}

.sticky-note-btn{
  width:28px;
  height:28px;
  border-radius:50%;
  border:none;
  cursor:pointer;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:14px;
  transition:all 0.2s ease;
  background:rgba(0,0,0,0.1);
}

.sticky-note-btn:hover{
  background:rgba(0,0,0,0.2);
  transform:scale(1.1);
}

.sticky-note-content{
  font-size:15px;
  line-height:1.6;
  word-wrap:break-word;
  white-space:pre-wrap;
  font-family:'Segoe Print', 'Comic Sans MS', cursive;
}

.sticky-note.completed .sticky-note-content{
  text-decoration:line-through;
}

.top-ranking-card{
  background:rgba(255,255,255,0.03);
  border-radius:16px;
  padding:16px;
  border:1px solid var(--glass-border);
  margin-bottom:12px;
}

.top-ranking-item{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:12px;
  margin:8px 0;
  border-radius:12px;
  background:rgba(255,255,255,0.02);
  border:1px solid var(--glass-border);
  transition:all 0.3s ease;
}

.top-ranking-item:hover{
  background:rgba(255,255,255,0.04);
  transform:translateX(4px);
}

.rank-badge{
  width:36px;
  height:36px;
  border-radius:50%;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:700;
  font-size:16px;
}

.rank-1{
  background:linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
  color:#0a0e1a;
  box-shadow:0 4px 12px rgba(251,191,36,0.4);
}

.rank-2{
  background:linear-gradient(135deg, #94a3b8 0%, #64748b 100%);
  color:#fff;
  box-shadow:0 4px 12px rgba(148,163,184,0.4);
}

.rank-3{
  background:linear-gradient(135deg, #fb923c 0%, #f97316 100%);
  color:#fff;
  box-shadow:0 4px 12px rgba(251,146,60,0.4);
}

.rank-other{
  background:rgba(255,255,255,0.05);
  color:var(--text-secondary);
  border:1px solid var(--glass-border);
}

@media (max-width:1200px){
  .grid,.grid-3,.grid-4{grid-template-columns:1fr;}
  .wrap{padding:16px;}
  .sticky-notes-grid{grid-template-columns:1fr;}
}

@keyframes fadeIn{
  from{opacity:0;transform:translateY(10px);}
  to{opacity:1;transform:translateY(0);}
}

.card{animation:fadeIn 0.5s ease;}
</style>
</head>
<body>
<div class="wrap" id="wrap">
  <div class="top">
    <div>
      <h1>Team Dashboard Enhanced v3</h1>
      <div class="muted">OnlyFans Agency Management System</div>
    </div>
  </div>

  <div class="tabs">
    <div class="tab active" data-tab="reports">üìä –û—Ç—á–µ—Ç—ã</div>
    <div class="tab" data-tab="stats">üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
    <div class="tab" data-tab="rankings">üèÜ –†–µ–π—Ç–∏–Ω–≥–∏</div>
    <div class="tab" data-tab="mynotes">üìå –ú–æ–∏ –∑–∞–º–µ—Ç–∫–∏</div>
    <div class="tab" data-tab="team">üë• –ö–æ–º–∞–Ω–¥–∞</div>
    <div class="tab" data-tab="insights">üí° –ü–æ–¥—Å–∫–∞–∑–∫–∏</div>
    <div class="tab" data-tab="worklog">üìù –ë–ª–æ–≥ —Ä–∞–±–æ—Ç—ã</div>
  </div>

  
  <div id="tab-reports" class="tab-content" style="display:block;">
    <div class="grid-4" style="margin-bottom:20px;">
      <div class="stat-card">
        <div class="stat-number" id="totalHappn">0</div>
        <div class="stat-label">Happn –∞–∫–∫–∞—É–Ω—Ç–æ–≤</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="totalLeads">0</div>
        <div class="stat-label">–õ–∏–¥–æ–≤ –ø–µ—Ä–µ–≤–µ–¥–µ–Ω–æ</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="totalUsers">0</div>
        <div class="stat-label">–ê–∫—Ç–∏–≤–Ω—ã—Ö —é–∑–µ—Ä–æ–≤</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="approvalRate">0%</div>
        <div class="stat-label">–û–¥–æ–±—Ä–µ–Ω–æ</div>
      </div>
    </div>

    <div class="card">
      <h3>üìã –û—Ç—á–µ—Ç—ã (–æ–∂–∏–¥–∞—é—â–∏–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è)</h3>
      <div style="overflow:auto;max-height:500px;">
        <table>
          <thead>
            <tr>
              <th style="width:12%">@user</th>
              <th style="width:10%">Instagram</th>
              <th style="width:35%">Text</th>
              <th style="width:10%">Happn</th>
              <th style="width:10%">–õ–∏–¥—ã</th>
              <th style="width:10%">–î–∞—Ç–∞</th>
              <th style="width:13%">‚úî / ‚ùå</th>
            </tr>
          </thead>
          <tbody id="reportsTable"></tbody>
        </table>
      </div>
    </div>

    <div class="card">
      <h3>üí¨ –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–∏–¥–±–µ–∫</h3>
      <div style="display:grid;gap:12px">
        <select id="feedbackUserSelect">
          <option value="">–í—ã–±–µ—Ä–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è‚Ä¶</option>
        </select>
        <textarea id="feedbackText" rows="4" placeholder="–¢–µ–∫—Å—Ç —Ñ–∏–¥–±—ç–∫–∞"></textarea>
        <div style="display:flex;gap:12px;align-items:center">
          <button id="sendFeedbackBtn">üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
          <div id="feedbackStatus" class="small muted"></div>
        </div>
      </div>
    </div>
  </div>

  
  <div id="tab-stats" class="tab-content">
    <div class="card">
      <h3>üìà –†–æ—Å—Ç –∫–æ–º–∞–Ω–¥—ã</h3>
      <div id="teamGrowthProgress"></div>
    </div>

    <div class="card">
      <h3>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ Happn –∏ –õ–∏–¥–∞–º</h3>
      <div class="period-buttons">
        <button class="period-btn active" data-period="yesterday">–í—á–µ—Ä–∞</button>
        <button class="period-btn" data-period="week">–ù–µ–¥–µ–ª—è</button>
        <button class="period-btn" data-period="month">–ú–µ—Å—è—Ü</button>
        <button class="period-btn" data-period="custom">–ü–æ –¥–∞—Ç–µ</button>
      </div>
      <div id="customDateRange" class="date-range-picker" style="display:none;">
        <input type="date" id="statsStartDate" />
        <span>‚Äî</span>
        <input type="date" id="statsEndDate" />
        <button class="small-btn" id="applyDateRange">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
      </div>
      <div style="margin-top:20px;">
        <canvas id="statsChart" style="height:300px;"></canvas>
      </div>
    </div>

    <div class="card">
      <h3>üìä –°—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞</h3>
      <div style="margin-top:20px;">
        <canvas id="comparisonChart" style="height:300px;"></canvas>
      </div>
    </div>

    <div class="card">
      <h3>üë§ –î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º</h3>
      <div style="display:flex;gap:12px;margin-bottom:16px;flex-wrap:wrap;">
        <select id="userStatsSelect" style="width:200px;">
          <option value="">–í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</option>
        </select>
        <div class="period-buttons">
          <button class="period-btn active" data-user-period="all">–í—Å—ë –≤—Ä–µ–º—è</button>
          <button class="period-btn" data-user-period="week">–ù–µ–¥–µ–ª—è</button>
          <button class="period-btn" data-user-period="month">–ú–µ—Å—è—Ü</button>
          <button class="period-btn" data-user-period="custom">–ü–æ –¥–∞—Ç–µ</button>
        </div>
      </div>
      <div id="userCustomDateRange" class="date-range-picker" style="display:none;">
        <input type="date" id="userStatsStartDate" />
        <span>‚Äî</span>
        <input type="date" id="userStatsEndDate" />
        <button class="small-btn" id="applyUserDateRange">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
      </div>
      <div id="userDetailedStats" style="display:grid;gap:12px;margin-top:16px;"></div>
    </div>
  </div>

  
  <div id="tab-rankings" class="tab-content">
    <div class="grid-3">
      <div class="card">
        <h3>üèÜ –¢–æ–ø-5 –∑–∞ —Å–µ–≥–æ–¥–Ω—è</h3>
        <div id="rankingToday"></div>
      </div>
      <div class="card">
        <h3>üèÜ –¢–æ–ø-5 –∑–∞ –Ω–µ–¥–µ–ª—é</h3>
        <div id="rankingWeek"></div>
      </div>
      <div class="card">
        <h3>üèÜ –¢–æ–ø-5 –∑–∞ –º–µ—Å—è—Ü</h3>
        <div id="rankingMonth"></div>
      </div>
    </div>

    <div class="card">
      <h3>üìä –î–∏–Ω–∞–º–∏–∫–∞ —Ç–æ–ø-5 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h3>
      <div style="margin-top:20px;">
        <canvas id="top5TrendChart" style="height:300px;"></canvas>
      </div>
    </div>

    <div class="card">
      <h3>üéØ –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥—ã</h3>
      <div id="achievements" style="display:grid;gap:12px;"></div>
    </div>
  </div>

  
  <div id="tab-mynotes" class="tab-content">
    <div class="card">
      <h3>üìå –î–æ–±–∞–≤–∏—Ç—å –∑–∞–º–µ—Ç–∫—É</h3>
      <div style="display:grid;gap:12px;">
        <textarea id="newPersonalNote" rows="4" placeholder="–ù–∞–ø–∏—à–∏ —Å–≤–æ—é –∑–∞–º–µ—Ç–∫—É..."></textarea>
        <div style="display:flex;gap:12px;align-items:center;">
          <select id="noteColor" style="width:150px;">
            <option value="yellow">üü® –ñ–µ–ª—Ç–∞—è</option>
            <option value="pink">üü™ –†–æ–∑–æ–≤–∞—è</option>
            <option value="blue">üü¶ –°–∏–Ω—è—è</option>
            <option value="green">üü© –ó–µ–ª–µ–Ω–∞—è</option>
            <option value="purple">üü£ –§–∏–æ–ª–µ—Ç–æ–≤–∞—è</option>
          </select>
          <button id="addPersonalNoteBtn">‚ûï –î–æ–±–∞–≤–∏—Ç—å –∑–∞–º–µ—Ç–∫—É</button>
        </div>
      </div>
    </div>

    <div class="card">
      <h3>üìù –ú–æ–∏ –∑–∞–º–µ—Ç–∫–∏</h3>
      <div id="personalNotesList" class="sticky-notes-grid"></div>
    </div>
  </div>

  
  <div id="tab-team" class="tab-content">
    <div class="grid">
      <div class="card">
        <h3>üë• –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥–æ–π</h3>
        <div style="display:grid;gap:12px;margin-bottom:20px;">
          <input id="newUsername" placeholder="–í–≤–µ–¥–∏ username (–Ω–∞–ø—Ä–∏–º–µ—Ä @ivan)" />
          <button id="addUserBtn">‚ûï –î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ–º–∞–Ω–¥—É</button>
          <div id="addUserStatus" class="small muted"></div>
        </div>
        <div id="teamList" class="team-list small">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
      </div>
      <div class="card">
        <h3>üìù –ó–∞–º–µ—Ç–∫–∏ –º–µ–Ω–µ–¥–∂–µ—Ä–∞</h3>
        <div style="display:grid;gap:12px;margin-bottom:16px;">
          <select id="notesUserSelect">
            <option value="">–í—ã–±–µ—Ä–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è‚Ä¶</option>
          </select>
          <textarea id="newNote" rows="3" placeholder="–ù–æ–≤–∞—è –∑–∞–º–µ—Ç–∫–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: –ü–æ–¥–∫–ª—é—á–∏—Ç—å –ò–ò –Ω–∞ —ç—Ç—É –∏–Ω—Å—Ç—É)"></textarea>
          <button id="addNoteBtn">üíæ –î–æ–±–∞–≤–∏—Ç—å –∑–∞–º–µ—Ç–∫—É</button>
        </div>
        <div id="notesList" class="notes-list small">–í—ã–±–µ—Ä–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</div>
      </div>
    </div>
  </div>

  
  <div id="tab-insights" class="tab-content">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;flex-wrap:wrap;gap:12px;">
        <h3>üí° –£–º–Ω—ã–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏</h3>
        <div style="display:flex;gap:12px;align-items:center;">
          <select id="insightUserSelect" style="width:200px;">
            <option value="">–í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</option>
          </select>
          <button id="generateInsightsBtn">‚ú® –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫–∏</button>
        </div>
      </div>
      <div id="insightsList" class="small muted">–ù–∞–∂–º–∏ "–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫–∏" –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞</div>
    </div>
  </div>

  
  <div id="tab-worklog" class="tab-content">
    <div class="grid">
      <div class="card">
        <h3>‚ûï –î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å</h3>
        <div style="display:grid;gap:12px;">
          <select id="worklogUser">
            <option value="">–í—ã–±–µ—Ä–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è‚Ä¶</option>
          </select>
          <input type="date" id="worklogDate" />
          <select id="worklogStatus">
            <option value="working">‚úÖ –í—ã—à–µ–ª –Ω–∞ —Ä–∞–±–æ—Ç—É</option>
            <option value="absent">‚ùå –ù–µ –≤—ã—à–µ–ª –Ω–∞ —Ä–∞–±–æ—Ç—É</option>
            <option value="evening">üåô –í—ã–π–¥–µ—Ç –≤–µ—á–µ—Ä–æ–º</option>
          </select>
          <textarea id="worklogReason" rows="3" placeholder="–ü—Ä–∏—á–∏–Ω–∞ (–µ—Å–ª–∏ –Ω–µ –≤—ã—à–µ–ª)"></textarea>
          <button id="addWorklogBtn">üíæ –î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å</button>
          <div id="worklogStatusMsg" class="small muted"></div>
        </div>
      </div>
      <div class="card">
        <h3>üìú –ò—Å—Ç–æ—Ä–∏—è —Ä–∞–±–æ—Ç—ã</h3>
        <div style="display:flex;gap:12px;margin-bottom:16px;">
          <button id="prevDayBtn" class="secondary">‚óÄ –ù–∞–∑–∞–¥</button>
          <input type="date" id="worklogDatePicker" style="flex:1;" />
          <button id="nextDayBtn" class="secondary">–í–ø–µ—Ä–µ–¥ ‚ñ∂</button>
        </div>
        <div id="worklogList" style="max-height:500px;overflow:auto;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
      </div>
    </div>
  </div>
</div>

<script>
/* ========= Helpers ========= */
async function fetchJson(url, opts){ const res = await fetch(url, opts); return res.json(); }
const reportsTable = document.getElementById('reportsTable');
let statsChart = null;
let comparisonChart = null;
let top5TrendChart = null;
let currentWorklogDate = new Date();
let isSelectOpen = false;

function escapeHtml(text){
  if(!text && text!==0) return '';
  return String(text).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot',"'":"&#39;"}[m]));
}

function formatDate(date) {
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  return `${year}-${month}-${day}`;
}

function formatDisplayDate(date) {
  const options = { year: 'numeric', month: 'long', day: 'numeric' };
  return date.toLocaleDateString('ru-RU', options);
}

/* ========= Tab Switching ========= */
document.querySelectorAll('.tab').forEach(tab => {
  tab.addEventListener('click', () => {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
    tab.classList.add('active');
    const tabName = tab.dataset.tab;
    document.getElementById('tab-' + tabName).style.display = 'block';
    
    if(tabName === 'stats'){
      loadStatistics();
    } else if(tabName === 'insights'){
      loadInsights();
    } else if(tabName === 'rankings'){
      loadRankings();
    } else if(tabName === 'mynotes'){
      loadPersonalNotes();
    }
  });
});

/* ========= Preserve scroll state ========= */
let lastRefreshTime = Date.now();
const REFRESH_COOLDOWN = 3000;

function preserveStateStart(){
  return {
    scrollY: window.scrollY || document.documentElement.scrollTop || document.body.scrollTop || 0,
    activeElement: document.activeElement
  };
}

function preserveStateEnd(state){
  window.scrollTo({ top: state.scrollY, behavior: 'auto' });
  if(state.activeElement && document.body.contains(state.activeElement)) {
    try { state.activeElement.focus({ preventScroll: true }); } catch(e) {}
  }
}

document.addEventListener('mousedown', (e) => {
  if (e.target.tagName === 'SELECT') {
    isSelectOpen = true;
  }
});

document.addEventListener('change', (e) => {
  if (e.target.tagName === 'SELECT') {
    isSelectOpen = false;
  }
});

document.addEventListener('blur', (e) => {
  if (e.target.tagName === 'SELECT') {
    setTimeout(() => { isSelectOpen = false; }, 100);
  }
}, true);

/* ========= REPORTS ========= */
async function loadReports(){
  if (isSelectOpen) return;
  
  const state = preserveStateStart();
  try{
    const res = await fetchJson('/api/reports');
    if(!res.ok){ reportsTable.innerHTML='<tr><td colspan="7">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</td></tr>'; preserveStateEnd(state); return; }
    const pendingReports = res.reports.filter(r=>r.status==='pending');

    const existingMap = {};
    reportsTable.querySelectorAll('tr[data-report-id]').forEach(tr=>{
      existingMap[tr.dataset.reportId] = tr;
    });

    pendingReports.forEach(rep=>{
      const id = String(rep.id);
      let tr = existingMap[id];
      if(!tr){
        tr = document.createElement('tr');
        tr.className = 'pending-row';
        tr.dataset.reportId = id;
        tr.innerHTML = `
          <td class="table-username">${escapeHtml(rep.username||'‚Äî')}</td>
          <td class="table-instagram">${escapeHtml(rep.instagram_username||'‚Äî')}</td>
          <td class="report-text" style="white-space:normal;word-break:break-word">${escapeHtml(rep.text)}</td>
          <td><input type="number" class="happn-input" value="0" style="width:70px" min="0" /></td>
          <td><input type="number" class="leads-input" value="0" style="width:70px" min="0" /></td>
          <td><input type="date" class="date-input" value="${rep.report_date||formatDate(new Date())}" style="width:140px" /></td>
          <td>
            <button class="action-btn approve">‚úî</button>
            <button class="action-btn reject" style="margin-left:8px">‚úñ</button>
          </td>
        `;
        reportsTable.appendChild(tr);

        const happnInput = tr.querySelector('.happn-input');
        const leadsInput = tr.querySelector('.leads-input');
        const dateInput = tr.querySelector('.date-input');
        
        tr.querySelector('.approve').addEventListener('click', async ()=>{
          const happn = parseInt(happnInput.value)||0;
          const leads = parseInt(leadsInput.value)||0;
          const date = dateInput.value;
          try {
            await fetch(`/api/reports/${id}/approve`,{
              method:'POST',
              headers:{'Content-Type':'application/json'},
              body: JSON.stringify({ happn_accounts: happn, leads_converted: leads, report_date: date })
            });
            tr.remove();
            await loadGlobalStats();
          } catch(e){ console.error(e); }
        });
        
        tr.querySelector('.reject').addEventListener('click', async ()=>{
          try {
            await fetch(`/api/reports/${id}/reject`,{ method:'POST' });
            tr.remove();
          } catch(e){ console.error(e); }
        });
      }
      delete existingMap[id];
    });

    Object.keys(existingMap).forEach(oldId=>{
      const tr = existingMap[oldId];
      if(tr) tr.remove();
    });

  }catch(e){ console.error('loadReports err', e); }
  preserveStateEnd(state);
}

/* ========= GLOBAL STATS ========= */
async function loadGlobalStats(){
  try{
    const res = await fetchJson('/api/stats/global');
    if(!res.ok) return;
    
    document.getElementById('totalHappn').textContent = res.data.happn || 0;
    document.getElementById('totalLeads').textContent = res.data.leads || 0;
    document.getElementById('totalUsers').textContent = res.data.users || 0;
    
    const approvalRes = await fetchJson('/api/stats/approvals');
    if(approvalRes.ok){
      const approved = approvalRes.stats.total_approved || 0;
      const rejected = approvalRes.stats.total_rejected || 0;
      const total = approved + rejected;
      const rate = total > 0 ? Math.round((approved / total) * 100) : 0;
      document.getElementById('approvalRate').textContent = rate + '%';
    }
  }catch(e){ console.error('loadGlobalStats err', e); }
}

/* ========= FEEDBACK ========= */
document.getElementById('sendFeedbackBtn').addEventListener('click', async () => {
  const userId = document.getElementById('feedbackUserSelect').value;
  const text = document.getElementById('feedbackText').value.trim();
  const status = document.getElementById('feedbackStatus');

  if (!userId) { status.textContent = "–í—ã–±–µ—Ä–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è!"; return; }
  if (!text) { status.textContent = "–ù–∞–ø–∏—à–∏ —Ç–µ–∫—Å—Ç —Ñ–∏–¥–±—ç–∫–∞!"; return; }
  status.textContent = "–û—Ç–ø—Ä–∞–≤–∫–∞‚Ä¶";

  try {
    const res = await fetch('/api/feedback/send', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ telegram_id: userId, text })
    });
    const data = await res.json();
    if (data.ok) {
      status.textContent = "‚úÖ –§–∏–¥–±–µ–∫ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!";
      document.getElementById('feedbackText').value = "";
    } else {
      status.textContent = "‚ùå –û—à–∏–±–∫–∞: " + data.error;
    }
  } catch (e) {
    console.error(e);
    status.textContent = "‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è";
  }
});

/* ========= TEAM MANAGEMENT ========= */
async function loadTeam(){
  if (isSelectOpen) return;
  
  try{
    const res = await fetchJson('/api/users');
    if(!res.ok){ document.getElementById('teamList').innerText='–û—à–∏–±–∫–∞'; return; }
    
    const teamList = document.getElementById('teamList');
    teamList.innerHTML = '';
    
    res.users.forEach(u=>{
      const div = document.createElement('div');
      div.className='user-row';
      div.dataset.userId = u.id;
      const uname = u.username || ('id:'+u.id);
      div.innerHTML = `
        <div style="flex:1;">
          <div style="font-weight:600;color:var(--accent);">${escapeHtml(uname)}</div>
          <div class="small">Instagram: ${escapeHtml(u.instagram_username||'‚Äî')}</div>
        </div>
        <input type="text" class="instagram-input" placeholder="@instagram" value="${escapeHtml(u.instagram_username||'')}" style="width:140px;" data-user-id="${u.id}" />
        <select class="table-select role-select" data-user-id="${u.id}">
          <option value="">–í—ã–±—Ä–∞—Ç—å —Ä–æ–ª—å</option>
          <option value="–¢—Ä–∞—Ñ–µ—Ä" ${u.role==='–¢—Ä–∞—Ñ–µ—Ä'?'selected':''}>–¢—Ä–∞—Ñ–µ—Ä</option>
          <option value="–ù–æ–≤–∏—á–æ–∫ –¢—Ä–∞—Ñ–µ—Ä" ${u.role==='–ù–æ–≤–∏—á–æ–∫ –¢—Ä–∞—Ñ–µ—Ä'?'selected':''}>–ù–æ–≤–∏—á–æ–∫ –¢—Ä–∞—Ñ–µ—Ä</option>
          <option value="–¢–∏–º –õ–∏–¥" ${u.role==='–¢–∏–º –õ–∏–¥'?'selected':''}>–¢–∏–º –õ–∏–¥</option>
          <option value="‚≠êÔ∏è –†–∞—Ñ" ${u.role==='‚≠êÔ∏è –†–∞—Ñ'?'selected':''}>‚≠êÔ∏è –†–∞—Ñ</option>
        </select>
        <button class="action-btn reject delete-user" data-user-id="${u.id}" title="–£–¥–∞–ª–∏—Ç—å">‚úñ</button>
      `;
      teamList.appendChild(div);
    });

    teamList.querySelectorAll('.instagram-input').forEach(input => {
      input.addEventListener('blur', async (e) => {
        const userId = e.target.dataset.userId;
        const instagram = e.target.value.trim();
        try {
          await fetch(`/api/users/${userId}/instagram`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ instagram })
          });
        } catch (err) {
          console.error('Instagram update error', err);
        }
      });
    });

    teamList.querySelectorAll('.role-select').forEach(sel => {
      sel.addEventListener('change', async (e) => {
        const userId = e.target.dataset.userId;
        const role = e.target.value;
        try {
          await fetch(`/api/users/${userId}/role`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ role })
          });
        } catch (err) {
          console.error('Role update error', err);
        }
      });
    });

    teamList.querySelectorAll('.delete-user').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        const userId = e.target.dataset.userId;
        if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?')) return;
        try {
          await fetch(`/api/users/${userId}`, { method: 'DELETE' });
          await loadTeam();
        } catch (err) {
          console.error('Delete error', err);
        }
      });
    });

    fillFeedbackUsers(res.users);
    fillWorklogUsers(res.users);
    fillInsightUsers(res.users);
    fillNotesUsers(res.users);
    fillUserStatsSelect(res.users);
    
  }catch(e){ console.error(e); document.getElementById('teamList').innerText='–û—à–∏–±–∫–∞'; }
}

document.getElementById('addUserBtn').addEventListener('click', async () => {
  const username = document.getElementById('newUsername').value.trim();
  const status = document.getElementById('addUserStatus');
  
  if (!username) {
    status.textContent = '–í–≤–µ–¥–∏ username!';
    return;
  }
  
  status.textContent = '–î–æ–±–∞–≤–ª–µ–Ω–∏–µ...';
  
  try {
    const res = await fetch('/api/users/add', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ username })
    });
    const data = await res.json();
    
    if (data.ok) {
      status.textContent = '‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–±–∞–≤–ª–µ–Ω!';
      document.getElementById('newUsername').value = '';
      await loadTeam();
    } else {
      status.textContent = '‚ùå –û—à–∏–±–∫–∞: ' + data.error;
    }
  } catch (e) {
    console.error(e);
    status.textContent = '‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è';
  }
});

function fillFeedbackUsers(users){
  const sel = document.getElementById('feedbackUserSelect');
  if(!sel) return;
  const cur = sel.value;
  sel.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è‚Ä¶</option>';
  users.forEach(u=>{
    const option = document.createElement('option');
    option.value = u.telegram_id || '';
    option.textContent = u.username || ('id:'+u.id);
    sel.appendChild(option);
  });
  if(cur) sel.value = cur;
}

function fillWorklogUsers(users){
  const sel = document.getElementById('worklogUser');
  if(!sel) return;
  const cur = sel.value;
  sel.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è‚Ä¶</option>';
  users.forEach(u=>{
    const option = document.createElement('option');
    option.value = u.id;
    option.textContent = u.username || ('id:'+u.id);
    sel.appendChild(option);
  });
  if(cur) sel.value = cur;
}

function fillInsightUsers(users){
  const sel = document.getElementById('insightUserSelect');
  if(!sel) return;
  const cur = sel.value;
  sel.innerHTML = '<option value="">–í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</option>';
  users.forEach(u=>{
    const option = document.createElement('option');
    option.value = u.id;
    option.textContent = u.username || ('id:'+u.id);
    sel.appendChild(option);
  });
  if(cur) sel.value = cur;
}

function fillNotesUsers(users){
  const sel = document.getElementById('notesUserSelect');
  if(!sel) return;
  const cur = sel.value;
  sel.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è‚Ä¶</option>';
  users.forEach(u=>{
    const option = document.createElement('option');
    option.value = u.id;
    option.textContent = u.username || ('id:'+u.id);
    sel.appendChild(option);
  });
  if(cur) sel.value = cur;
}

function fillUserStatsSelect(users){
  const sel = document.getElementById('userStatsSelect');
  if(!sel) return;
  const cur = sel.value;
  sel.innerHTML = '<option value="">–í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</option>';
  users.forEach(u=>{
    const option = document.createElement('option');
    option.value = u.id;
    option.textContent = u.username || ('id:'+u.id);
    sel.appendChild(option);
  });
  if(cur) sel.value = cur;
}

/* ========= MANAGER NOTES ========= */
document.getElementById('notesUserSelect').addEventListener('change', async (e) => {
  const userId = e.target.value;
  if(!userId){
    document.getElementById('notesList').innerHTML = '–í—ã–±–µ—Ä–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è';
    return;
  }
  await loadNotes(userId);
});

document.getElementById('addNoteBtn').addEventListener('click', async () => {
  const userId = document.getElementById('notesUserSelect').value;
  const note = document.getElementById('newNote').value.trim();
  
  if(!userId || !note){
    alert('–í—ã–±–µ—Ä–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –≤–≤–µ–¥–∏ –∑–∞–º–µ—Ç–∫—É!');
    return;
  }
  
  try{
    const res = await fetch('/api/notes/add', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ user_id: userId, note })
    });
    const data = await res.json();
    if(data.ok){
      document.getElementById('newNote').value = '';
      await loadNotes(userId);
    }
  }catch(e){
    console.error('Add note error', e);
  }
});

async function loadNotes(userId){
  try{
    const res = await fetchJson(`/api/notes/${userId}`);
    if(!res.ok) return;
    
    const list = document.getElementById('notesList');
    if(res.notes.length === 0){
      list.innerHTML = '<div class="small muted">–ù–µ—Ç –∑–∞–º–µ—Ç–æ–∫</div>';
      return;
    }
    
    list.innerHTML = '';
    res.notes.forEach(note => {
      const div = document.createElement('div');
      div.className = 'note-item';
      div.innerHTML = `
        <div style="flex:1;">${escapeHtml(note.note)}</div>
        <button class="action-btn reject" data-note-id="${note.id}">‚úñ</button>
      `;
      list.appendChild(div);
      
      div.querySelector('.reject').addEventListener('click', async () => {
        try{
          await fetch(`/api/notes/${note.id}`, { method: 'DELETE' });
          await loadNotes(userId);
        }catch(e){
          console.error('Delete note error', e);
        }
      });
    });
  }catch(e){
    console.error('Load notes error', e);
  }
}

/* ========= PERSONAL NOTES (STICKY NOTES) ========= */
document.getElementById('addPersonalNoteBtn').addEventListener('click', async () => {
  const content = document.getElementById('newPersonalNote').value.trim();
  const color = document.getElementById('noteColor').value;
  
  if(!content){
    alert('–ù–∞–ø–∏—à–∏ —Ç–µ–∫—Å—Ç –∑–∞–º–µ—Ç–∫–∏!');
    return;
  }
  
  try{
    const res = await fetch('/api/personal-notes/add', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ content, color })
    });
    const data = await res.json();
    if(data.ok){
      document.getElementById('newPersonalNote').value = '';
      await loadPersonalNotes();
    }
  }catch(e){
    console.error('Add personal note error', e);
  }
});

async function loadPersonalNotes(){
  try{
    const res = await fetchJson('/api/personal-notes');
    if(!res.ok) return;
    
    const list = document.getElementById('personalNotesList');
    if(res.notes.length === 0){
      list.innerHTML = '<div class="small muted" style="grid-column:1/-1;text-align:center;padding:40px;">–ù–µ—Ç –∑–∞–º–µ—Ç–æ–∫. –î–æ–±–∞–≤—å —Å–≤–æ—é –ø–µ—Ä–≤—É—é –∑–∞–º–µ—Ç–∫—É!</div>';
      return;
    }
    
    list.innerHTML = '';
    res.notes.forEach(note => {
      const div = document.createElement('div');
      div.className = `sticky-note ${note.color} ${note.completed ? 'completed' : ''}`;
      div.dataset.noteId = note.id;
      
      const date = new Date(note.created_at);
      const dateStr = date.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit' });
      
      div.innerHTML = `
        <div class="sticky-note-header">
          <div class="sticky-note-date">${dateStr}</div>
          <div class="sticky-note-actions">
            <button class="sticky-note-btn complete-note" title="${note.completed ? '–í–µ—Ä–Ω—É—Ç—å' : '–í—ã–ø–æ–ª–Ω–µ–Ω–æ'}">
              ${note.completed ? '‚Ü©Ô∏è' : '‚úì'}
            </button>
            <button class="sticky-note-btn delete-note" title="–£–¥–∞–ª–∏—Ç—å">‚úñ</button>
          </div>
        </div>
        <div class="sticky-note-content">${escapeHtml(note.content)}</div>
      `;
      
      list.appendChild(div);
      
      div.querySelector('.complete-note').addEventListener('click', async (e) => {
        e.stopPropagation();
        try{
          await fetch(`/api/personal-notes/${note.id}/toggle`, { method: 'POST' });
          await loadPersonalNotes();
        }catch(err){
          console.error('Toggle note error', err);
        }
      });
      
      div.querySelector('.delete-note').addEventListener('click', async (e) => {
        e.stopPropagation();
        if(!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–º–µ—Ç–∫—É?')) return;
        try{
          await fetch(`/api/personal-notes/${note.id}`, { method: 'DELETE' });
          await loadPersonalNotes();
        }catch(err){
          console.error('Delete note error', err);
        }
      });
    });
  }catch(e){
    console.error('Load personal notes error', e);
  }
}

/* ========= STATISTICS ========= */
async function loadStatistics(){
  await loadTeamGrowth();
  await loadStatsChart('yesterday');
  await loadComparisonChart();
  await loadUserDetailedStats();
}

async function loadTeamGrowth(){
  try{
    const res = await fetchJson('/api/stats/growth/team');
    if(!res.ok) return;
    
    const container = document.getElementById('teamGrowthProgress');
    
    const cumulative = [];
    let sum = 0;
    res.growth.forEach(g => {
      sum += g.count;
      cumulative.push({ date: g.date, count: sum });
    });
    
    if(cumulative.length === 0){
      container.innerHTML = '<div class="small muted">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>';
      return;
    }
    
    const maxCount = Math.max(...cumulative.map(c => c.count));
    
    let html = '<div style="display:grid;gap:12px;">';
    cumulative.forEach((item, index) => {
      const percentage = maxCount > 0 ? (item.count / maxCount) * 100 : 0;
      const isGrowth = index > 0 && item.count > cumulative[index-1].count;
      
      html += `
        <div>
          <div style="display:flex;justify-content:space-between;margin-bottom:4px;">
            <span class="small">${item.date}</span>
            <span class="small" style="color:var(--accent);font-weight:600;">${item.count} ${isGrowth ? 'üìà' : ''}</span>
          </div>
          <div class="progress-bar">
            <div class="progress-fill" style="width:${percentage}%"></div>
          </div>
        </div>
      `;
    });
    html += '</div>';
    
    container.innerHTML = html;
  }catch(e){ console.error('loadTeamGrowth err', e); }
}

document.querySelectorAll('.period-buttons .period-btn').forEach(btn => {
  if(!btn.dataset.userPeriod){
    btn.addEventListener('click', async (e) => {
      document.querySelectorAll('.period-buttons .period-btn').forEach(b => {
        if(!b.dataset.userPeriod) b.classList.remove('active');
      });
      e.target.classList.add('active');
      
      const period = e.target.dataset.period;
      if(period === 'custom'){
        document.getElementById('customDateRange').style.display = 'flex';
      } else {
        document.getElementById('customDateRange').style.display = 'none';
        await loadStatsChart(period);
      }
    });
  }
});

document.getElementById('applyDateRange').addEventListener('click', async () => {
  const startDate = document.getElementById('statsStartDate').value;
  const endDate = document.getElementById('statsEndDate').value;
  
  if(!startDate || !endDate){
    alert('–í—ã–±–µ—Ä–∏ –æ–±–µ –¥–∞—Ç—ã!');
    return;
  }
  
  await loadStatsChart('custom', startDate, endDate);
});

async function loadStatsChart(period, startDate = null, endDate = null){
  try{
    let start, end;
    const today = new Date();
    
    if(period === 'custom' && startDate && endDate){
      start = startDate;
      end = endDate;
    } else if(period === 'yesterday'){
      const yesterday = new Date(today);
      yesterday.setDate(yesterday.getDate() - 1);
      start = end = formatDate(yesterday);
    } else if(period === 'week'){
      const weekAgo = new Date(today);
      weekAgo.setDate(weekAgo.getDate() - 7);
      start = formatDate(weekAgo);
      end = formatDate(today);
    } else if(period === 'month'){
      const monthAgo = new Date(today);
      monthAgo.setDate(monthAgo.getDate() - 30);
      start = formatDate(monthAgo);
      end = formatDate(today);
    }
    
    const [happnRes, leadsRes] = await Promise.all([
      fetchJson(`/api/stats/growth/happn?startDate=${start}&endDate=${end}`),
      fetchJson(`/api/stats/growth/leads?startDate=${start}&endDate=${end}`)
    ]);
    
    if(!happnRes.ok || !leadsRes.ok) return;
    
    const allDates = new Set();
    happnRes.growth.forEach(g => allDates.add(g.date));
    leadsRes.growth.forEach(g => allDates.add(g.date));
    
    const labels = Array.from(allDates).sort();
    
    const happnData = labels.map(date => {
      const found = happnRes.growth.find(g => g.date === date);
      return found ? found.total : 0;
    });
    
    const leadsData = labels.map(date => {
      const found = leadsRes.growth.find(g => g.date === date);
      return found ? found.total : 0;
    });
    
    const ctx = document.getElementById('statsChart').getContext('2d');
    if(statsChart){
      statsChart.data.labels = labels;
      statsChart.data.datasets[0].data = happnData;
      statsChart.data.datasets[1].data = leadsData;
      statsChart.update();
    } else {
      statsChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'Happn –∞–∫–∫–∞—É–Ω—Ç—ã',
              data: happnData,
              backgroundColor: 'rgba(245,158,11,0.8)',
              borderColor: '#f59e0b',
              borderWidth: 2,
              borderRadius: 8
            },
            {
              label: '–õ–∏–¥—ã',
              data: leadsData,
              backgroundColor: 'rgba(16,185,129,0.8)',
              borderColor: '#10b981',
              borderWidth: 2,
              borderRadius: 8
            }
          ]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              labels: {color: '#8b92a8', font: {size: 12}}
            }
          },
          scales: {
            x: {
              ticks: {color: '#8b92a8'},
              grid: {color: 'rgba(255,255,255,0.05)'}
            },
            y: {
              ticks: {
                color: '#8b92a8',
                stepSize: 1
              },
              grid: {color: 'rgba(255,255,255,0.05)'}
            }
          }
        }
      });
    }
  }catch(e){ console.error('loadStatsChart err', e); }
}

async function loadComparisonChart(){
  try{
    const res = await fetchJson('/api/stats/detailed');
    if(!res.ok) return;
    
    const stats = res.stats.slice(0, 10);
    const labels = stats.map(s => s.username || 'Unknown');
    const happnData = stats.map(s => s.happn_total || 0);
    const leadsData = stats.map(s => s.leads_total || 0);
    
    const ctx = document.getElementById('comparisonChart').getContext('2d');
    if(comparisonChart){
      comparisonChart.data.labels = labels;
      comparisonChart.data.datasets[0].data = happnData;
      comparisonChart.data.datasets[1].data = leadsData;
      comparisonChart.update();
    } else {
      comparisonChart = new Chart(ctx, {
        type: 'horizontalBar',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'Happn',
              data: happnData,
              backgroundColor: 'rgba(245,158,11,0.8)',
              borderColor: '#f59e0b',
              borderWidth: 2
            },
            {
              label: '–õ–∏–¥—ã',
              data: leadsData,
              backgroundColor: 'rgba(16,185,129,0.8)',
              borderColor: '#10b981',
              borderWidth: 2
            }
          ]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          plugins: {
            legend: {
              labels: {color: '#8b92a8', font: {size: 12}}
            }
          },
          scales: {
            x: {
              ticks: {color: '#8b92a8'},
              grid: {color: 'rgba(255,255,255,0.05)'}
            },
            y: {
              ticks: {color: '#8b92a8'},
              grid: {color: 'rgba(255,255,255,0.05)'}
            }
          }
        }
      });
    }
  }catch(e){ console.error('loadComparisonChart err', e); }
}

document.querySelectorAll('[data-user-period]').forEach(btn => {
  btn.addEventListener('click', async (e) => {
    document.querySelectorAll('[data-user-period]').forEach(b => b.classList.remove('active'));
    e.target.classList.add('active');
    
    const period = e.target.dataset.userPeriod;
    if(period === 'custom'){
      document.getElementById('userCustomDateRange').style.display = 'flex';
    } else {
      document.getElementById('userCustomDateRange').style.display = 'none';
      await loadUserDetailedStats(period);
    }
  });
});

document.getElementById('userStatsSelect').addEventListener('change', async () => {
  const activePeriod = document.querySelector('[data-user-period].active');
  const period = activePeriod ? activePeriod.dataset.userPeriod : 'all';
  await loadUserDetailedStats(period);
});

document.getElementById('applyUserDateRange').addEventListener('click', async () => {
  const startDate = document.getElementById('userStatsStartDate').value;
  const endDate = document.getElementById('userStatsEndDate').value;
  
  if(!startDate || !endDate){
    alert('–í—ã–±–µ—Ä–∏ –æ–±–µ –¥–∞—Ç—ã!');
    return;
  }
  
  await loadUserDetailedStats('custom', startDate, endDate);
});

async function loadUserDetailedStats(period = 'all', startDate = null, endDate = null){
  try{
    const userId = document.getElementById('userStatsSelect').value;
    
    let start, end;
    const today = new Date();
    
    if(period === 'custom' && startDate && endDate){
      start = startDate;
      end = endDate;
    } else if(period === 'week'){
      const weekAgo = new Date(today);
      weekAgo.setDate(weekAgo.getDate() - 7);
      start = formatDate(weekAgo);
      end = formatDate(today);
    } else if(period === 'month'){
      const monthAgo = new Date(today);
      monthAgo.setDate(monthAgo.getDate() - 30);
      start = formatDate(monthAgo);
      end = formatDate(today);
    }
    
    let url = '/api/stats/detailed';
    if(start && end){
      url = `/api/stats/by-date?startDate=${start}&endDate=${end}`;
    }
    
    const res = await fetchJson(url);
    if(!res.ok) return;
    
    let stats = res.stats;
    
    if(userId){
      stats = stats.filter(s => s.id === parseInt(userId));
    }
    
    const container = document.getElementById('userDetailedStats');
    
    if(stats.length === 0){
      container.innerHTML = '<div class="small muted">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>';
      return;
    }
    
    stats.sort((a, b) => {
      const totalA = (a.happn_total || 0) + (a.leads_total || 0);
      const totalB = (b.happn_total || 0) + (b.leads_total || 0);
      return totalB - totalA;
    });
    
    let html = '';
    stats.forEach((user, index) => {
      const happn = user.happn_total || 0;
      const leads = user.leads_total || 0;
      const total = happn + leads;
      
      const isTopPerformer = index < 3 && total > 20;
      const topBadge = isTopPerformer ? `<span style="display:inline-flex;align-items:center;gap:6px;padding:6px 12px;border-radius:12px;font-size:12px;font-weight:600;background:linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);color:#0a0e1a;margin-left:8px;">üèÜ –¢–æ–ø-${index + 1}</span>` : '';
      
      let requirementText = '';
      if(user.role === '–¢—Ä–∞—Ñ–µ—Ä'){
        const status = leads >= 10 ? '‚úÖ' : '‚ö†Ô∏è';
        requirementText = `${status} –ù–æ—Ä–º–∞: 10 –ª–∏–¥–æ–≤ (—Ç–µ–∫—É—â–µ–µ: ${leads})`;
      } else if(user.role === '–ù–æ–≤–∏—á–æ–∫ –¢—Ä–∞—Ñ–µ—Ä'){
        const dailyAvg = period === 'week' ? (happn / 7).toFixed(1) : (happn / 30).toFixed(1);
        const status = dailyAvg >= 5 ? '‚úÖ' : '‚ö†Ô∏è';
        requirementText = `${status} –ù–æ—Ä–º–∞: 5 –∞–∫–∫–∞—É–Ω—Ç–æ–≤/–¥–µ–Ω—å (—Å—Ä–µ–¥–Ω: ${dailyAvg})`;
      } else if(user.role === '–¢–∏–º –õ–∏–¥' || user.role === '‚≠êÔ∏è –†–∞—Ñ'){
        requirementText = '‚ú® –ù–µ—Ç –æ–±—è–∑–∞—Ç–µ–ª—å—Å—Ç–≤';
      }
      
      html += `
        <div style="padding:20px;background:rgba(255,255,255,0.03);border-radius:16px;border:1px solid var(--glass-border);">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
            <div>
              <div style="font-weight:600;font-size:18px;color:var(--accent);margin-bottom:4px;">
                ${escapeHtml(user.username || 'Unknown')}${topBadge}
              </div>
              <div class="small">–†–æ–ª—å: ${user.role || '–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∞'} ¬∑ Instagram: ${escapeHtml(user.instagram_username || '‚Äî')}</div>
              ${requirementText ? `<div class="small" style="margin-top:4px;">${requirementText}</div>` : ''}
            </div>
            <div style="text-align:right;">
              <div style="font-size:24px;font-weight:700;color:var(--accent);">${total}</div>
              <div class="small">–≤—Å–µ–≥–æ</div>
            </div>
          </div>
          
          <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:12px;">
            <div class="stat-card">
              <div style="font-size:20px;font-weight:700;color:#f59e0b;">${happn}</div>
              <div class="stat-label">Happn –∞–∫–∫–∞—É–Ω—Ç—ã</div>
            </div>
            <div class="stat-card">
              <div style="font-size:20px;font-weight:700;color:#10b981;">${leads}</div>
              <div class="stat-label">–õ–∏–¥—ã</div>
            </div>
          </div>
        </div>
      `;
    });
    
    container.innerHTML = html;
  }catch(e){ console.error('loadUserDetailedStats err', e); }
}

/* ========= RANKINGS ========= */
async function loadRankings(){
  await loadRankingToday();
  await loadRankingWeek();
  await loadRankingMonth();
  await loadTop5TrendChart();
  await loadAchievements();
}

async function loadRankingToday(){
  try{
    const today = formatDate(new Date());
    const res = await fetchJson(`/api/stats/ranking?period=today&date=${today}`);
    if(!res.ok) return;
    
    renderRanking('rankingToday', res.ranking);
  }catch(e){ console.error('loadRankingToday err', e); }
}

async function loadRankingWeek(){
  try{
    const res = await fetchJson('/api/stats/ranking?period=week');
    if(!res.ok) return;
    
    renderRanking('rankingWeek', res.ranking);
  }catch(e){ console.error('loadRankingWeek err', e); }
}

async function loadRankingMonth(){
  try{
    const res = await fetchJson('/api/stats/ranking?period=month');
    if(!res.ok) return;
    
    renderRanking('rankingMonth', res.ranking);
  }catch(e){ console.error('loadRankingMonth err', e); }
}

function renderRanking(containerId, ranking){
  const container = document.getElementById(containerId);
  if(!container) return;
  
  if(ranking.length === 0){
    container.innerHTML = '<div class="small muted">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>';
    return;
  }
  
  let html = '';
  ranking.forEach((user, index) => {
    const rank = index + 1;
    let rankClass = 'rank-other';
    if(rank === 1) rankClass = 'rank-1';
    else if(rank === 2) rankClass = 'rank-2';
    else if(rank === 3) rankClass = 'rank-3';
    
    const total = user.total || 0;
    const happn = user.happn_total || 0;
    const leads = user.leads_total || 0;
    
    html += `
      <div class="top-ranking-item">
        <div class="rank-badge ${rankClass}">${rank}</div>
        <div style="flex:1;margin-left:12px;">
          <div style="font-weight:600;color:var(--accent);">${escapeHtml(user.username || 'Unknown')}</div>
          <div class="small">Happn: ${happn} ¬∑ –õ–∏–¥—ã: ${leads}</div>
        </div>
        <div style="text-align:right;">
          <div style="font-size:20px;font-weight:700;color:var(--accent);">${total}</div>
          <div class="small">–≤—Å–µ–≥–æ</div>
        </div>
      </div>
    `;
  });
  
  container.innerHTML = html;
}

async function loadTop5TrendChart(){
  try{
    const res = await fetchJson('/api/stats/top5-trend');
    if(!res.ok) return;
    
    const dates = res.trend.dates || [];
    const users = res.trend.users || [];
    
    const colors = [
      'rgba(245,158,11,0.8)',
      'rgba(16,185,129,0.8)',
      'rgba(59,130,246,0.8)',
      'rgba(168,85,247,0.8)',
      'rgba(239,68,68,0.8)'
    ];
    
    const datasets = users.map((user, index) => ({
      label: user.username,
      data: user.data,
      borderColor: colors[index],
      backgroundColor: colors[index].replace('0.8', '0.2'),
      borderWidth: 2,
      tension: 0.4,
      fill: true
    }));
    
    const ctx = document.getElementById('top5TrendChart').getContext('2d');
    if(top5TrendChart){
      top5TrendChart.data.labels = dates;
      top5TrendChart.data.datasets = datasets;
      top5TrendChart.update();
    } else {
      top5TrendChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: dates,
          datasets: datasets
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              labels: {color: '#8b92a8', font: {size: 12}}
            }
          },
          scales: {
            x: {
              ticks: {color: '#8b92a8'},
              grid: {color: 'rgba(255,255,255,0.05)'}
            },
            y: {
              ticks: {color: '#8b92a8'},
              grid: {color: 'rgba(255,255,255,0.05)'}
            }
          }
        }
      });
    }
  }catch(e){ console.error('loadTop5TrendChart err', e); }
}

async function loadAchievements(){
  try{
    const res = await fetchJson('/api/stats/achievements');
    if(!res.ok) return;
    
    const container = document.getElementById('achievements');
    const achievements = res.achievements || [];
    
    if(achievements.length === 0){
      container.innerHTML = '<div class="small muted">–ù–µ—Ç –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π</div>';
      return;
    }
    
    let html = '';
    achievements.forEach(ach => {
      html += `
        <div style="padding:16px;background:rgba(255,255,255,0.03);border-radius:12px;border:1px solid var(--glass-border);">
          <div style="display:flex;align-items:center;gap:12px;">
            <div style="font-size:32px;">${ach.icon}</div>
            <div style="flex:1;">
              <div style="font-weight:600;color:var(--accent);">${escapeHtml(ach.title)}</div>
              <div class="small">${escapeHtml(ach.description)}</div>
            </div>
          </div>
        </div>
      `;
    });
    
    container.innerHTML = html;
  }catch(e){ console.error('loadAchievements err', e); }
}

/* ========= INSIGHTS ========= */
document.getElementById('generateInsightsBtn').addEventListener('click', async () => {
  const btn = document.getElementById('generateInsightsBtn');
  const userId = document.getElementById('insightUserSelect').value;
  
  btn.textContent = '‚è≥ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è...';
  btn.disabled = true;
  
  try {
    const body = userId ? JSON.stringify({ user_id: userId }) : '{}';
    const res = await fetch('/api/insights/generate', { 
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: body
    });
    const data = await res.json();
    
    if (data.ok) {
      await loadInsights();
    }
  } catch (e) {
    console.error('Insights generation error', e);
  } finally {
    btn.textContent = '‚ú® –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫–∏';
    btn.disabled = false;
  }
});

async function loadInsights() {
  try {
    const res = await fetchJson('/api/insights');
    if (!res.ok) return;
    
    const listEl = document.getElementById('insightsList');
    
    if (res.insights.length === 0) {
      listEl.innerHTML = '<div class="small muted">–ù–µ—Ç –ø–æ–¥—Å–∫–∞–∑–æ–∫. –ù–∞–∂–º–∏ "–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫–∏"</div>';
      return;
    }
    
    let html = '';
    res.insights.forEach(insight => {
      let style = 'padding:16px;margin:8px 0;border-left:4px solid var(--accent);background:rgba(245,158,11,0.08);border-radius:12px;';
      
      if (insight.category === 'success') {
        style = 'padding:16px;margin:8px 0;border-left:4px solid var(--accent-green);background:rgba(16,185,129,0.08);border-radius:12px;';
      } else if (insight.category === 'improvement' || insight.category === 'warning') {
        style = 'padding:16px;margin:8px 0;border-left:4px solid var(--accent-red);background:rgba(239,68,68,0.08);border-radius:12px;';
      }
      
      html += `<div style="${style}">${escapeHtml(insight.content)}</div>`;
    });
    
    listEl.innerHTML = html;
  } catch (e) {
    console.error('Load insights error', e);
  }
}

/* ========= WORK LOG ========= */
document.getElementById('addWorklogBtn').addEventListener('click', async () => {
  const userId = document.getElementById('worklogUser').value;
  const date = document.getElementById('worklogDate').value;
  const status = document.getElementById('worklogStatus').value;
  const reason = document.getElementById('worklogReason').value.trim();
  const statusEl = document.getElementById('worklogStatusMsg');
  
  if (!userId || !date) {
    statusEl.textContent = '–ó–∞–ø–æ–ª–Ω–∏ –≤—Å–µ –ø–æ–ª—è!';
    return;
  }
  
  try {
    const res = await fetch('/api/worklogs/add', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ user_id: userId, date, status, reason })
    });
    const data = await res.json();
    
    if (data.ok) {
      statusEl.textContent = '‚úÖ –ó–∞–ø–∏—Å—å –¥–æ–±–∞–≤–ª–µ–Ω–∞!';
      document.getElementById('worklogReason').value = '';
      document.getElementById('worklogUser').value = '';
      document.getElementById('worklogStatus').value = 'working';
      await loadWorklogsByDate(currentWorklogDate);
    }
  } catch (e) {
    console.error('Add worklog error', e);
  }
});

document.getElementById('worklogDatePicker').addEventListener('change', (e) => {
  currentWorklogDate = new Date(e.target.value);
  loadWorklogsByDate(currentWorklogDate);
});

document.getElementById('prevDayBtn').addEventListener('click', () => {
  currentWorklogDate.setDate(currentWorklogDate.getDate() - 1);
  document.getElementById('worklogDatePicker').valueAsDate = currentWorklogDate;
  loadWorklogsByDate(currentWorklogDate);
});

document.getElementById('nextDayBtn').addEventListener('click', () => {
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  const nextDate = new Date(currentWorklogDate);
  nextDate.setDate(nextDate.getDate() + 1);
  nextDate.setHours(0, 0, 0, 0);
  
  if (nextDate <= today) {
    currentWorklogDate = nextDate;
    document.getElementById('worklogDatePicker').valueAsDate = currentWorklogDate;
    loadWorklogsByDate(currentWorklogDate);
  }
});

async function loadWorklogsByDate(date) {
  try {
    const dateStr = formatDate(date);
    const res = await fetchJson(`/api/worklogs?date=${dateStr}`);
    if (!res.ok) return;
    
    const listEl = document.getElementById('worklogList');
    
    if (res.logs.length === 0) {
      listEl.innerHTML = '<div class="small muted">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π –∑–∞ —ç—Ç–æ—Ç –¥–µ–Ω—å</div>';
      return;
    }
    
    let html = '';
    res.logs.forEach(log => {
      let badgeStyle = 'padding:6px 14px;border-radius:12px;font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;';
      let statusText = '';
      
      if (log.status === 'working') {
        badgeStyle += 'background:linear-gradient(135deg, var(--accent-green) 0%, #059669 100%);color:#fff;';
        statusText = '‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç';
      } else if (log.status === 'absent') {
        badgeStyle += 'background:linear-gradient(135deg, var(--accent-red) 0%, #dc2626 100%);color:#fff;';
        statusText = '‚ùå –ù–µ –≤—ã—à–µ–ª';
      } else if (log.status === 'evening') {
        badgeStyle += 'background:linear-gradient(135deg, var(--accent) 0%, var(--accent-hover) 100%);color:#0a0e1a;';
        statusText = 'üåô –í–µ—á–µ—Ä–æ–º';
      }
      
      html += `
        <div style="padding:16px;margin:8px 0;border-radius:16px;background:rgba(255,255,255,0.03);display:flex;justify-content:space-between;align-items:center;border:1px solid var(--glass-border);">
          <div>
            <div style="font-weight:600;margin-bottom:4px;">${escapeHtml(log.username || 'Unknown')}</div>
            <div class="small muted">${log.reason ? escapeHtml(log.reason) : '‚Äî'}</div>
          </div>
          <span style="${badgeStyle}">${statusText}</span>
        </div>
      `;
    });
    
    listEl.innerHTML = html;
  } catch (e) {
    console.error('Load worklogs error', e);
  }
}

document.getElementById('worklogDate').valueAsDate = new Date();
document.getElementById('worklogDatePicker').valueAsDate = new Date();
currentWorklogDate = new Date();

/* ========= AUTO-REFRESH ========= */
let periodicHandle = null;

async function refreshAll(){
  if (isSelectOpen) return;
  
  const now = Date.now();
  if (now - lastRefreshTime < REFRESH_COOLDOWN) return;
  lastRefreshTime = now;
  
  const state = preserveStateStart();
  await Promise.all([ 
    loadReports(), 
    loadTeam(), 
    loadGlobalStats()
  ]);
  preserveStateEnd(state);
}

(async function init(){
  await refreshAll();
  await loadInsights();
  await loadWorklogsByDate(currentWorklogDate);
  
  if(periodicHandle) clearInterval(periodicHandle);
  periodicHandle = setInterval(async ()=>{ 
    if(document.hidden) return; 
    await refreshAll(); 
  }, 3000);
})();

window.addEventListener('beforeunload', ()=>{ if(periodicHandle) clearInterval(periodicHandle); });
</script>
</body>
</html>