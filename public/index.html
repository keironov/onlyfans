<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Team Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root{--bg:#0f1724;--card:#111827;--muted:#9ca3af;--accent:#f59e0b;}
html,body{height:100%;margin:0;padding:0;}
body{font-family:Inter,Arial,Helvetica,sans-serif;background:linear-gradient(180deg,#0b1220,#0f1724);color:#e6eef8;}
.wrap{max-width:1200px;margin:24px auto;padding:20px;}
.top{display:flex;gap:12px;align-items:center;justify-content:space-between;}
.card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:12px;padding:16px;box-shadow: 0 6px 18px rgba(2,6,23,0.6);margin-bottom:12px;}
.grid{display:grid;grid-template-columns:1fr 420px;gap:16px;}
.team-list{max-height:540px;overflow:auto;padding:8px;}
.user-row{display:flex;justify-content:space-between;padding:8px;border-bottom:1px dashed rgba(255,255,255,0.03);}
.muted{color:var(--muted);font-size:13px;}
input,textarea,select{width:100%;padding:8px;border-radius:6px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit;box-sizing:border-box;}
button{background:var(--accent);color:#081125;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:600;}
.small{font-size:13px;color:var(--muted);}
h1,h3{margin:0 0 8px 0;}
table{width:100%;border-collapse:collapse;color:#e6eef8;}
th,td{padding:6px;border-bottom:1px solid rgba(255,255,255,0.1);text-align:left;}
td input,td select{width:auto;}
</style>
</head>
<body>
<div class="wrap">
  <div class="top">
    <div>
      <h1>Team Dashboard</h1>
      <div class="muted">Webhook bot mode — Telegram интеграция через WEBHOOK</div>
    </div>
    <div>
      <button id="refreshBtn">Refresh</button>
    </div>
  </div>

  <div class="grid">
    <div>
      <!-- Global Stats -->
      <div class="card">
        <h3>Global Stats</h3>
        <div style="display:flex;gap:8px;margin-bottom:8px;">
          <select id="globalPeriod">
            <option value="today">Сегодня</option>
            <option value="yesterday">Вчера</option>
            <option value="week">Неделя</option>
            <option value="month">Месяц</option>
          </select>
        </div>
        <canvas id="globalChart" style="height:220px;"></canvas>
      </div>

      <!-- Отчёты -->
      <div class="card">
        <h3>Отчёты</h3>
        <table>
          <thead>
            <tr><th>@user</th><th>Text</th><th>Number</th><th>Type</th><th>✔ / ❌</th></tr>
          </thead>
          <tbody id="dailyTableBody"></tbody>
        </table>
      </div>
    </div>

    <div>
      <div class="card">
        <h3>Team</h3>
        <div id="teamList" class="team-list small muted">Loading...</div>
      </div>

      <div class="card">
        <h3>User Summary</h3>
        <div style="display:grid;gap:8px">
          <input id="viewUsername" placeholder="username to view (e.g. @ivan)" />
          <button id="viewUserBtn">View</button>
          <div id="userSummary" class="small muted">No user selected</div>
          <canvas id="userActivityChart" style="height:180px;"></canvas>
          <div id="userReports" class="small muted"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
async function fetchJson(url, opts){ const res = await fetch(url, opts); return res.json(); }

const dailyTableBody = document.getElementById('dailyTableBody');

// ===== Load Reports =====
async function loadReportsTable() {
  dailyTableBody.innerHTML = '';
  try {
    const r = await fetchJson('/api/reports');
    if(!r.ok){ dailyTableBody.innerHTML='<tr><td colspan="5">Ошибка загрузки</td></tr>'; return; }
    r.reports.filter(rep=>rep.status==='pending').forEach(rep=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${rep.username||'—'}</td>
        <td>${rep.text}</td>
        <td><input type="number" value="0" style="width:60px"></td>
        <td>
          <select>
            <option value="happn">happn</option>
            <option value="instagram">instagram</option>
            <option value="lid">lid</option>
          </select>
        </td>
        <td>
          <button style="background:#10b981;color:#081125;border:none;padding:2px 6px;margin-right:4px;cursor:pointer">✔</button>
          <button style="background:#ef4444;color:#fff;border:none;padding:2px 6px;cursor:pointer">❌</button>
        </td>
      `;
      tr.querySelector('button:first-child').addEventListener('click', async ()=>{
        const number = tr.querySelector('input').value;
        const type = tr.querySelector('select').value;
        await fetch(`/api/reports/${rep.id}/approve`,{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({number,type})
        });
        tr.remove();
        loadGlobalChart();
      });
      tr.querySelector('button:last-child').addEventListener('click', async ()=>{
        await fetch(`/api/reports/${rep.id}/reject`,{method:'POST'});
        tr.remove();
      });
      dailyTableBody.appendChild(tr);
    });
  } catch(e){ console.error(e); }
}

// ===== Global Stats Chart =====
const globalCtx = document.getElementById('globalChart').getContext('2d');
let globalChart = null;
const periodSelect = document.getElementById('globalPeriod');

async function loadGlobalChart() {
  try {
    const period = periodSelect.value;
    const g = await fetchJson('/api/stats/global?period='+period);
    if(!g.ok) return;
    const data = g.data;
    const labels = ['happn','instagram','lid'];
    const values = [data.happn||0, data.instagram||0, data.lid||0];

    if(globalChart) globalChart.destroy();
    globalChart = new Chart(globalCtx,{
      type:'doughnut',
      data:{
        labels,
        datasets:[{data:values, backgroundColor:['#f59e0b','#3b82f6','#10b981'] }]
      },
      options:{
        plugins:{legend:{position:'bottom'}}
      }
    });
  } catch(e){ console.error(e); }
}

periodSelect.addEventListener('change', ()=>{ loadGlobalChart(); });

document.getElementById('refreshBtn').addEventListener('click', ()=>{
  loadReportsTable();
  loadGlobalChart();
});

// Initial load
loadReportsTable();
loadGlobalChart();
</script>
</body>
</html>
