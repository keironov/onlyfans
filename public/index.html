<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Team Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root{--bg:#0f1724;--card:#111827;--muted:#9ca3af;--accent:#f59e0b;}
html,body{height:100%;margin:0;padding:0;}
body{font-family:Inter,Arial,Helvetica,sans-serif;background:linear-gradient(180deg,#0b1220,#0f1724);color:#e6eef8;}
.wrap{max-width:1200px;margin:24px auto;padding:20px;}
.top{display:flex;gap:12px;align-items:center;justify-content:space-between;}
.card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:12px;padding:16px;box-shadow: 0 6px 18px rgba(2,6,23,0.6);margin-bottom:12px;}
.grid{display:grid;grid-template-columns:1fr 420px;gap:16px;}
.team-list{max-height:540px;overflow:auto;padding:8px;}
.user-row{display:flex;justify-content:space-between;padding:8px;border-bottom:1px dashed rgba(255,255,255,0.03);}
.muted{color:var(--muted);font-size:13px;}
input,textarea,select{width:100%;padding:8px;border-radius:6px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit;box-sizing:border-box;}
button{background:var(--accent);color:#081125;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:600;}
.small{font-size:13px;color:var(--muted);}
h1,h3{margin:0 0 8px 0;}
#userPickerOverlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.45);z-index:1999;}
#userPickerModal{display:none;position:fixed;top:20%;left:50%;transform:translateX(-50%);background:var(--card);padding:16px;border-radius:10px;box-shadow:0 0 30px rgba(0,0,0,0.6);width:320px;max-height:60%;overflow-y:auto;z-index:2000;}
.user-picker-item{padding:8px;cursor:pointer;border-radius:6px;}
.user-picker-item:hover{background:rgba(255,255,255,0.02);}
.muted-small{color:var(--muted);font-size:12px;}
table{width:100%;border-collapse:collapse;color:#e6eef8;}
th,td{padding:6px;border-bottom:1px solid rgba(255,255,255,0.1);text-align:left;}
td input,td select{width:auto;}
</style>
</head>
<body>
<div class="wrap">
  <div class="top">
    <div>
      <h1>Team Dashboard</h1>
      <div class="muted">Webhook bot mode — Telegram интеграция через WEBHOOK</div>
    </div>
    <div>
      <button id="refreshBtn">Refresh</button>
    </div>
  </div>

  <div class="grid">
    <div>
      <div class="card">
        <h3>Global Stats</h3>
        <div id="globalSummary" class="small muted">Loading...</div>
        <canvas id="leaderboardChart" style="height:220px;"></canvas>
      </div>

      <div class="card">
        <h3>Pending Reports</h3>
        <table>
          <thead>
            <tr><th>@user</th><th>Text</th><th>Type</th><th>✔ / ❌</th></tr>
          </thead>
          <tbody id="dailyTableBody"></tbody>
        </table>
      </div>
    </div>

    <div>
      <div class="card">
        <h3>Team</h3>
        <div id="teamList" class="team-list small muted">Loading...</div>
      </div>

      <div class="card">
        <h3>User Summary</h3>
        <div style="display:grid;gap:8px">
          <input id="viewUsername" placeholder="username to view (e.g. @ivan)" />
          <button id="viewUserBtn">View</button>
          <div id="userSummary" class="small muted">No user selected</div>
          <canvas id="userActivityChart" style="height:180px;"></canvas>
          <div id="userReports" class="small muted"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="userPickerOverlay"></div>
<div id="userPickerModal" role="dialog" aria-modal="true" aria-labelledby="userPickerTitle">
  <div id="userPickerTitle" style="font-weight:bold; margin-bottom:8px;">Выбери пользователя</div>
  <div id="userPickerList" class="small muted">Loading...</div>
  <div style="display:flex; gap:8px; margin-top:8px; justify-content:flex-end;">
    <button id="closePickerBtn" type="button">Закрыть</button>
  </div>
</div>

<script>
async function fetchJson(url, opts){ const res = await fetch(url, opts); return res.json(); }

const dailyTableBody = document.getElementById('dailyTableBody');

// ==== Load Pending Reports ====
async function loadReportsTable() {
  dailyTableBody.innerHTML = '';
  try {
    const r = await fetchJson('/api/reports');
    if(!r.ok) { dailyTableBody.innerHTML='<tr><td colspan="4">Ошибка загрузки</td></tr>'; return; }
    r.reports.filter(rep=>rep.status==='pending').forEach(rep=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${rep.username||'—'}</td>
        <td>${rep.text}</td>
        <td>${rep.task_type||'—'}</td>
        <td>
          <button style="background:#10b981;color:#081125;border:none;padding:2px 6px;margin-right:4px;cursor:pointer">✔</button>
          <button style="background:#ef4444;color:#fff;border:none;padding:2px 6px;cursor:pointer">❌</button>
        </td>
      `;
      tr.querySelector('button:first-child').addEventListener('click', async ()=>{
        await fetch(`/api/reports/${rep.id}/approve`,{method:'POST'});
        tr.remove(); loadGlobal(); loadLeaderboard();
      });
      tr.querySelector('button:last-child').addEventListener('click', async ()=>{
        await fetch(`/api/reports/${rep.id}/reject`,{method:'POST'});
        tr.remove();
      });
      dailyTableBody.appendChild(tr);
    });
  } catch(e){ console.error(e); }
}

// ==== Global Stats / Leaderboard ====
const globalSummaryEl = document.getElementById('globalSummary');
const leaderboardCtx = document.getElementById('leaderboardChart').getContext('2d');
let leaderboardChart = null;

async function loadGlobal(){
  try{
    const g = await fetchJson('/api/stats/global');
    if(!g.ok){ globalSummaryEl.innerText='Failed'; return; }
    const s = g.summary;
    globalSummaryEl.innerText = `Reports: ${s.reports_total||0} · Suspicious: ${s.suspicious_total||0}`;
    const labels = (s.leaderboard||[]).slice(0,7).map(x=>x.user_id);
    const data = (s.leaderboard||[]).slice(0,7).map(x=>x.count);
    if(leaderboardChart) leaderboardChart.destroy();
    leaderboardChart = new Chart(leaderboardCtx,{
      type:'bar',
      data:{labels,datasets:[{label:'Reports',data}]},
      options:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}
    });
  }catch(e){ console.error(e); globalSummaryEl.innerText='Failed'; }
}

function loadLeaderboard(){ loadGlobal(); }

document.getElementById('refreshBtn').addEventListener('click', ()=>{
  loadReportsTable();
  loadGlobal();
});

// Initial load
loadReportsTable();
loadGlobal();
</script>
</body>
</html>
