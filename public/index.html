proanalizirui   

index.html:  <!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Team Dashboard - Enhanced v3</title>
<link rel="icon" href="https://public-frontend-cos.metadl.com/mgx/img/favicon.png" type="image/png">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root{
  --bg-primary:#0a0e1a;
  --bg-secondary:#0f1419;
  --glass-bg:rgba(255,255,255,0.03);
  --glass-border:rgba(255,255,255,0.08);
  --text-primary:#e8f0ff;
  --text-secondary:#8b92a8;
  --accent:#f59e0b;
  --accent-hover:#fbbf24;
  --accent-green:#10b981;
  --accent-red:#ef4444;
  --accent-blue:#3b82f6;
  --accent-purple:#a855f7;
  --shadow:0 8px 32px rgba(0,0,0,0.4);
}

*{box-sizing:border-box;margin:0;padding:0;}

html,body{
  height:100%;
  background:radial-gradient(ellipse at top, #1a1f35 0%, var(--bg-primary) 50%);
  color:var(--text-primary);
  font-family:'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
  overflow-x:hidden;
}

body::before{
  content:'';
  position:fixed;
  top:0;left:0;right:0;bottom:0;
  background:
    radial-gradient(circle at 20% 30%, rgba(245,158,11,0.08) 0%, transparent 50%),
    radial-gradient(circle at 80% 70%, rgba(59,130,246,0.06) 0%, transparent 50%);
  pointer-events:none;
  z-index:0;
}

.wrap{
  max-width:1600px;
  margin:0 auto;
  padding:24px;
  position:relative;
  z-index:1;
}

.top{
  display:flex;
  gap:16px;
  align-items:center;
  justify-content:space-between;
  margin-bottom:24px;
  padding:24px;
  background:var(--glass-bg);
  backdrop-filter:blur(20px);
  border-radius:24px;
  border:1px solid var(--glass-border);
  box-shadow:var(--shadow);
}

.top h1{
  font-size:32px;
  font-weight:700;
  background:linear-gradient(135deg, var(--accent) 0%, var(--accent-hover) 100%);
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
  margin-bottom:4px;
}

.muted{color:var(--text-secondary);font-size:14px;}
.small{font-size:13px;color:var(--text-secondary);}

.card{
  background:var(--glass-bg);
  backdrop-filter:blur(20px);
  border-radius:24px;
  padding:24px;
  border:1px solid var(--glass-border);
  box-shadow:var(--shadow);
  margin-bottom:20px;
  transition:all 0.3s ease;
}

.card:hover{
  border-color:rgba(245,158,11,0.2);
  box-shadow:0 12px 48px rgba(0,0,0,0.5);
  transform:translateY(-2px);
}

.card h3{
  font-size:20px;
  font-weight:600;
  margin-bottom:16px;
  color:var(--text-primary);
}

.grid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:20px;
}

.grid-3{
  display:grid;
  grid-template-columns:repeat(3, 1fr);
  gap:20px;
}

.grid-4{
  display:grid;
  grid-template-columns:repeat(4, 1fr);
  gap:16px;
}

input,textarea,select{
  width:100%;
  padding:12px 16px;
  border-radius:16px;
  border:1px solid var(--glass-border);
  background:rgba(255,255,255,0.02);
  color:var(--text-primary);
  outline:none;
  transition:all 0.3s ease;
  font-size:14px;
}

input:focus,textarea:focus,select:focus{
  background:rgba(255,255,255,0.04);
  border-color:var(--accent);
  box-shadow:0 0 0 3px rgba(245,158,11,0.1);
}

select {
  appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%238b92a8' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 12px center;
  padding-right: 36px;
  cursor: pointer;
}

select option {
  background: var(--bg-secondary);
  color: var(--text-primary);
  padding: 12px;
}

input[type="date"] {
  position: relative;
  cursor: pointer;
}

input[type="number"]{
  width:90px;
  text-align:center;
}

button{
  background:linear-gradient(135deg, var(--accent) 0%, var(--accent-hover) 100%);
  color:#0a0e1a;
  border:none;
  padding:12px 24px;
  border-radius:16px;
  cursor:pointer;
  font-weight:600;
  font-size:14px;
  transition:all 0.3s ease;
  box-shadow:0 4px 16px rgba(245,158,11,0.3);
}

button:hover{
  transform:translateY(-2px);
  box-shadow:0 6px 24px rgba(245,158,11,0.4);
}

button:active{
  transform:translateY(0);
}

button.secondary{
  background:rgba(255,255,255,0.05);
  color:var(--text-primary);
  border:1px solid var(--glass-border);
  box-shadow:none;
}

button.secondary:hover{
  background:rgba(255,255,255,0.08);
  border-color:var(--accent);
}

button.danger{
  background:linear-gradient(135deg, var(--accent-red) 0%, #dc2626 100%);
  color:#fff;
  box-shadow:0 4px 16px rgba(239,68,68,0.3);
}

button.small-btn{
  padding:8px 16px;
  font-size:12px;
}

.action-btn{
  width:40px;
  height:40px;
  border-radius:12px;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  font-weight:700;
  cursor:pointer;
  border:none;
  transition:all 0.3s ease;
}

.approve{
  background:linear-gradient(135deg, var(--accent-green) 0%, #059669 100%);
  color:#fff;
  box-shadow:0 4px 12px rgba(16,185,129,0.3);
}

.approve:hover{transform:scale(1.05);}

.reject{
  background:linear-gradient(135deg, var(--accent-red) 0%, #dc2626 100%);
  color:#fff;
  box-shadow:0 4px 12px rgba(239,68,68,0.3);
}

.reject:hover{transform:scale(1.05);}

table{
  width:100%;
  border-collapse:separate;
  border-spacing:0 8px;
}

th,td{
  padding:12px 16px;
  text-align:left;
  vertical-align:middle;
}

thead th{
  color:var(--text-secondary);
  font-weight:600;
  font-size:13px;
  text-transform:uppercase;
  letter-spacing:0.5px;
  border-bottom:1px solid var(--glass-border);
}

tbody tr{
  background:rgba(255,255,255,0.02);
  border-radius:12px;
  transition:all 0.3s ease;
}

tbody tr:hover{
  background:rgba(255,255,255,0.04);
  transform:translateX(4px);
}

.table-select{
  width:160px;
  padding:8px 12px;
  border-radius:12px;
}

canvas{max-width:100%;border-radius:16px;}

.tabs{
  display:flex;
  gap:12px;
  margin-bottom:24px;
  padding:8px;
  background:var(--glass-bg);
  backdrop-filter:blur(20px);
  border-radius:20px;
  border:1px solid var(--glass-border);
  flex-wrap:wrap;
}

.tab{
  padding:12px 24px;
  cursor:pointer;
  border-radius:14px;
  transition:all 0.3s ease;
  font-weight:500;
  color:var(--text-secondary);
}

.tab:hover{
  background:rgba(255,255,255,0.05);
  color:var(--text-primary);
}

.tab.active{
  background:linear-gradient(135deg, var(--accent) 0%, var(--accent-hover) 100%);
  color:#0a0e1a;
  box-shadow:0 4px 16px rgba(245,158,11,0.3);
}

.tab-content{display:none;}

.stat-card{
  background:rgba(255,255,255,0.03);
  border-radius:16px;
  padding:20px;
  border:1px solid var(--glass-border);
  transition:all 0.3s ease;
  text-align:center;
}

.stat-card:hover{
  background:rgba(255,255,255,0.05);
  border-color:var(--accent);
  transform:translateY(-2px);
}

.stat-number{
  font-size:32px;
  font-weight:700;
  background:linear-gradient(135deg, var(--accent) 0%, var(--accent-hover) 100%);
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
  margin-bottom:4px;
}

.stat-label{
  font-size:13px;
  color:var(--text-secondary);
  text-transform:uppercase;
  letter-spacing:0.5px;
}

.user-row{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:12px 16px;
  margin:6px 0;
  border-radius:12px;
  background:rgba(255,255,255,0.02);
  border:1px solid var(--glass-border);
  transition:all 0.3s ease;
  gap:12px;
}

.user-row:hover{
  background:rgba(255,255,255,0.04);
  border-color:var(--accent);
}

.team-list{
  max-height:500px;
  overflow:auto;
  padding:8px;
}

.team-list::-webkit-scrollbar{width:8px;}
.team-list::-webkit-scrollbar-track{background:rgba(255,255,255,0.02);border-radius:8px;}
.team-list::-webkit-scrollbar-thumb{background:var(--accent);border-radius:8px;}

.period-buttons{
  display:flex;
  gap:8px;
  margin-bottom:16px;
  flex-wrap:wrap;
}

.period-btn{
  padding:8px 16px;
  border-radius:12px;
  background:rgba(255,255,255,0.05);
  border:1px solid var(--glass-border);
  color:var(--text-secondary);
  cursor:pointer;
  transition:all 0.3s ease;
  font-size:13px;
}

.period-btn:hover{
  background:rgba(255,255,255,0.08);
  color:var(--text-primary);
}

.period-btn.active{
  background:linear-gradient(135deg, var(--accent) 0%, var(--accent-hover) 100%);
  color:#0a0e1a;
  border-color:var(--accent);
}

.date-range-picker{
  display:flex;
  gap:12px;
  align-items:center;
  margin-top:12px;
  padding:12px;
  background:rgba(255,255,255,0.02);
  border-radius:12px;
  border:1px solid var(--glass-border);
}

.progress-bar{
  width:100%;
  height:8px;
  background:rgba(255,255,255,0.05);
  border-radius:8px;
  overflow:hidden;
  position:relative;
}

.progress-fill{
  height:100%;
  background:linear-gradient(90deg, var(--accent) 0%, var(--accent-hover) 100%);
  border-radius:8px;
  transition:width 0.5s ease;
  position:relative;
}

.progress-fill::after{
  content:'';
  position:absolute;
  top:0;
  right:0;
  width:20px;
  height:100%;
  background:rgba(255,255,255,0.3);
  border-radius:8px;
}

.note-item{
  padding:12px;
  margin:8px 0;
  background:rgba(255,255,255,0.03);
  border-radius:12px;
  border:1px solid var(--glass-border);
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:12px;
}

.note-item:hover{
  background:rgba(255,255,255,0.05);
}

.notes-list{
  max-height:300px;
  overflow:auto;
}

/* Sticky Notes Styles */
.sticky-notes-grid{
  display:grid;
  grid-template-columns:repeat(auto-fill, minmax(280px, 1fr));
  gap:20px;
  padding:8px;
}

.sticky-note{
  position:relative;
  min-height:200px;
  padding:20px;
  border-radius:4px;
  box-shadow:0 4px 12px rgba(0,0,0,0.3), 0 2px 4px rgba(0,0,0,0.2);
  transition:all 0.3s ease;
  cursor:pointer;
  transform:rotate(-1deg);
  animation:fadeIn 0.5s ease;
}

.sticky-note:nth-child(even){
  transform:rotate(1deg);
}

.sticky-note:hover{
  transform:rotate(0deg) scale(1.02);
  box-shadow:0 8px 24px rgba(0,0,0,0.4), 0 4px 8px rgba(0,0,0,0.3);
  z-index:10;
}

.sticky-note.completed{
  opacity:0.6;
  filter:grayscale(0.5);
  transform:rotate(-2deg) scale(0.95);
  transition:all 0.5s ease;
}

.sticky-note.completed:hover{
  opacity:0.8;
  transform:rotate(0deg) scale(0.98);
}

.sticky-note.yellow{
  background:linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
  color:#78350f;
}

.sticky-note.pink{
  background:linear-gradient(135deg, #fce7f3 0%, #fbcfe8 100%);
  color:#831843;
}

.sticky-note.blue{
  background:linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
  color:#1e3a8a;
}

.sticky-note.green{
  background:linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
  color:#064e3b;
}

.sticky-note.purple{
  background:linear-gradient(135deg, #e9d5ff 0%, #d8b4fe 100%);
  color:#581c87;
}

.sticky-note::before{
  content:'';
  position:absolute;
  top:0;
  left:50%;
  transform:translateX(-50%);
  width:60px;
  height:20px;
  background:rgba(0,0,0,0.1);
  border-radius:0 0 8px 8px;
}

.sticky-note-header{
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
  margin-bottom:12px;
  padding-top:8px;
}

.sticky-note-date{
  font-size:11px;
  opacity:0.7;
  font-weight:600;
}

.sticky-note-actions{
  display:flex;
  gap:8px;
}

.sticky-note-btn{
  width:28px;
  height:28px;
  border-radius:50%;
  border:none;
  cursor:pointer;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:14px;
  transition:all 0.2s ease;
  background:rgba(0,0,0,0.1);
}

.sticky-note-btn:hover{
  background:rgba(0,0,0,0.2);
  transform:scale(1.1);
}

.sticky-note-content{
  font-size:15px;
  line-height:1.6;
  word-wrap:break-word;
  white-space:pre-wrap;
  font-family:'Segoe Print', 'Comic Sans MS', cursive;
}

.sticky-note.completed .sticky-note-content{
  text-decoration:line-through;
}

.top-ranking-card{
  background:rgba(255,255,255,0.03);
  border-radius:16px;
  padding:16px;
  border:1px solid var(--glass-border);
  margin-bottom:12px;
}

.top-ranking-item{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:12px;
  margin:8px 0;
  border-radius:12px;
  background:rgba(255,255,255,0.02);
  border:1px solid var(--glass-border);
  transition:all 0.3s ease;
}

.top-ranking-item:hover{
  background:rgba(255,255,255,0.04);
  transform:translateX(4px);
}

.rank-badge{
  width:36px;
  height:36px;
  border-radius:50%;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:700;
  font-size:16px;
}

.rank-1{
  background:linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
  color:#0a0e1a;
  box-shadow:0 4px 12px rgba(251,191,36,0.4);
}

.rank-2{
  background:linear-gradient(135deg, #94a3b8 0%, #64748b 100%);
  color:#fff;
  box-shadow:0 4px 12px rgba(148,163,184,0.4);
}

.rank-3{
  background:linear-gradient(135deg, #fb923c 0%, #f97316 100%);
  color:#fff;
  box-shadow:0 4px 12px rgba(251,146,60,0.4);
}

.rank-other{
  background:rgba(255,255,255,0.05);
  color:var(--text-secondary);
  border:1px solid var(--glass-border);
}

@media (max-width:1200px){
  .grid,.grid-3,.grid-4{grid-template-columns:1fr;}
  .wrap{padding:16px;}
  .sticky-notes-grid{grid-template-columns:1fr;}
}

@keyframes fadeIn{
  from{opacity:0;transform:translateY(10px);}
  to{opacity:1;transform:translateY(0);}
}

.card{animation:fadeIn 0.5s ease;}
</style>
</head>
<body>
<div class="wrap" id="wrap">
  <div class="top">
    <div>
      <h1>Team Dashboard Enhanced v3</h1>
      <div class="muted">OnlyFans Agency Management System</div>
    </div>
  </div>

  <div class="tabs">
    <div class="tab active" data-tab="reports">üìä –û—Ç—á–µ—Ç—ã</div>
    <div class="tab" data-tab="stats">üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
    <div class="tab" data-tab="rankings">üèÜ –†–µ–π—Ç–∏–Ω–≥–∏</div>
    <div class="tab" data-tab="mynotes">üìå –ú–æ–∏ –∑–∞–º–µ—Ç–∫–∏</div>
    <div class="tab" data-tab="team">üë• –ö–æ–º–∞–Ω–¥–∞</div>
    <div class="tab" data-tab="insights">üí° –ü–æ–¥—Å–∫–∞–∑–∫–∏</div>
    <div class="tab" data-tab="worklog">üìù –ë–ª–æ–≥ —Ä–∞–±–æ—Ç—ã</div>
  </div>

  
  <div id="tab-reports" class="tab-content" style="display:block;">
    <div class="grid-4" style="margin-bottom:20px;">
      <div class="stat-card">
        <div class="stat-number" id="totalHappn">0</div>
        <div class="stat-label">Happn –∞–∫–∫–∞—É–Ω—Ç–æ–≤</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="totalLeads">0</div>
        <div class="stat-label">–õ–∏–¥–æ–≤ –ø–µ—Ä–µ–≤–µ–¥–µ–Ω–æ</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="totalUsers">0</div>
        <div class="stat-label">–ê–∫—Ç–∏–≤–Ω—ã—Ö —é–∑–µ—Ä–æ–≤</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="approvalRate">0%</div>
        <div class="stat-label">–û–¥–æ–±—Ä–µ–Ω–æ</div>
      </div>
    </div>

    <div class="card">
      <h3>üìã –û—Ç—á–µ—Ç—ã (–æ–∂–∏–¥–∞—é—â–∏–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è)</h3>
      <div style="overflow:auto;max-height:500px;">
        <table>
          <thead>
            <tr>
              <th style="width:12%">@user</th>
              <th style="width:10%">Instagram</th>
              <th style="width:35%">Text</th>
              <th style="width:10%">Happn</th>
              <th style="width:10%">–õ–∏–¥—ã</th>
              <th style="width:10%">–î–∞—Ç–∞</th>
              <th style="width:13%">‚úî / ‚ùå</th>
            </tr>
          </thead>
          <tbody id="reportsTable"></tbody>
        </table>
      </div>
    </div>

    <div class="card">
      <h3>üí¨ –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–∏–¥–±–µ–∫</h3>
      <div style="display:grid;gap:12px">
        <select id="feedbackUserSelect">
          <option value="">–í—ã–±–µ—Ä–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è‚Ä¶</option>
        </select>
        <textarea id="feedbackText" rows="4" placeholder="–¢–µ–∫—Å—Ç —Ñ–∏–¥–±—ç–∫–∞"></textarea>
        <div style="display:flex;gap:12px;align-items:center">
          <button id="sendFeedbackBtn">üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
          <div id="feedbackStatus" class="small muted"></div>
        </div>
      </div>
    </div>
  </div>

  
  <div id="tab-stats" class="tab-content">
    <div class="card">
      <h3>üìà –†–æ—Å—Ç –∫–æ–º–∞–Ω–¥—ã</h3>
      <div id="teamGrowthProgress"></div>
    </div>

    <div class="card">
      <h3>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ Happn –∏ –õ–∏–¥–∞–º</h3>
      <div class="period-buttons">
        <button class="period-btn active" data-period="yesterday">–í—á–µ—Ä–∞</button>
        <button class="period-btn" data-period="week">–ù–µ–¥–µ–ª—è</button>
        <button class="period-btn" data-period="month">–ú–µ—Å—è—Ü</button>
        <button class="period-btn" data-period="custom">–ü–æ –¥–∞—Ç–µ</button>
      </div>
      <div id="customDateRange" class="date-range-picker" style="display:none;">
        <input type="date" id="statsStartDate" />
        <span>‚Äî</span>
        <input type="date" id="statsEndDate" />
        <button class="small-btn" id="applyDateRange">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
      </div>
      <div style="margin-top:20px;">
        <canvas id="statsChart" style="height:300px;"></canvas>
      </div>
    </div>

    <div class="card">
      <h3>üìä –°—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞</h3>
      <div style="margin-top:20px;">
        <canvas id="comparisonChart" style="height:300px;"></canvas>
      </div>
    </div>

    <div class="card">
      <h3>üë§ –î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º</h3>
      <div style="display:flex;gap:12px;margin-bottom:16px;flex-wrap:wrap;">
        <select id="userStatsSelect" style="width:200px;">
          <option value="">–í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</option>
        </select>
        <div class="period-buttons">
          <button class="period-btn active" data-user-period="all">–í—Å—ë –≤—Ä–µ–º—è</button>
          <button class="period-btn" data-user-period="week">–ù–µ–¥–µ–ª—è</button>
          <button class="period-btn" data-user-period="month">–ú–µ—Å—è—Ü</button>
          <button class="period-btn" data-user-period="custom">–ü–æ –¥–∞—Ç–µ</button>
        </div>
      </div>
      <div id="userCustomDateRange" class="date-range-picker" style="display:none;">
        <input type="date" id="userStatsStartDate" />
        <span>‚Äî</span>
        <input type="date" id="userStatsEndDate" />
        <button class="small-btn" id="applyUserDateRange">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
      </div>
      <div id="userDetailedStats" style="display:grid;gap:12px;margin-top:16px;"></div>
    </div>
  </div>

  
  <div id="tab-rankings" class="tab-content">
    <div class="grid-3">
      <div class="card">
        <h3>üèÜ –¢–æ–ø-5 –∑–∞ —Å–µ–≥–æ–¥–Ω—è</h3>
        <div id="rankingToday"></div>
      </div>
      <div class="card">
        <h3>üèÜ –¢–æ–ø-5 –∑–∞ –Ω–µ–¥–µ–ª—é</h3>
        <div id="rankingWeek"></div>
      </div>
      <div class="card">
        <h3>üèÜ –¢–æ–ø-5 –∑–∞ –º–µ—Å—è—Ü</h3>
        <div id="rankingMonth"></div>
      </div>
    </div>

    <div class="card">
      <h3>üìä –î–∏–Ω–∞–º–∏–∫–∞ —Ç–æ–ø-5 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h3>
      <div style="margin-top:20px;">
        <canvas id="top5TrendChart" style="height:300px;"></canvas>
      </div>
    </div>

    <div class="card">
      <h3>üéØ –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥—ã</h3>
      <div id="achievements" style="display:grid;gap:12px;"></div>
    </div>
  </div>

  
  <div id="tab-mynotes" class="tab-content">
    <div class="card">
      <h3>üìå –î–æ–±–∞–≤–∏—Ç—å –∑–∞–º–µ—Ç–∫—É</h3>
      <div style="display:grid;gap:12px;">
        <textarea id="newPersonalNote" rows="4" placeholder="–ù–∞–ø–∏—à–∏ —Å–≤–æ—é –∑–∞–º–µ—Ç–∫—É..."></textarea>
        <div style="display:flex;gap:12px;align-items:center;">
          <select id="noteColor" style="width:150px;">
            <option value="yellow">üü® –ñ–µ–ª—Ç–∞—è</option>
            <option value="pink">üü™ –†–æ–∑–æ–≤–∞—è</option>
            <option value="blue">üü¶ –°–∏–Ω—è—è</option>
            <option value="green">üü© –ó–µ–ª–µ–Ω–∞—è</option>
            <option value="purple">üü£ –§–∏–æ–ª–µ—Ç–æ–≤–∞—è</option>
          </select>
          <button id="addPersonalNoteBtn">‚ûï –î–æ–±–∞–≤–∏—Ç—å –∑–∞–º–µ—Ç–∫—É</button>
        </div>
      </div>
    </div>

    <div class="card">
      <h3>üìù –ú–æ–∏ –∑–∞–º–µ—Ç–∫–∏</h3>
      <div id="personalNotesList" class="sticky-notes-grid"></div>
    </div>
  </div>

  
  <div id="tab-team" class="tab-content">
    <div class="grid">
      <div class="card">
        <h3>üë• –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥–æ–π</h3>
        <div style="display:grid;gap:12px;margin-bottom:20px;">
          <input id="newUsername" placeholder="–í–≤–µ–¥–∏ username (–Ω–∞–ø—Ä–∏–º–µ—Ä @ivan)" />
          <button id="addUserBtn">‚ûï –î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ–º–∞–Ω–¥—É</button>
          <div id="addUserStatus" class="small muted"></div>
        </div>
        <div id="teamList" class="team-list small">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
      </div>
      <div class="card">
        <h3>üìù –ó–∞–º–µ—Ç–∫–∏ –º–µ–Ω–µ–¥–∂–µ—Ä–∞</h3>
        <div style="display:grid;gap:12px;margin-bottom:16px;">
          <select id="notesUserSelect">
            <option value="">–í—ã–±–µ—Ä–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è‚Ä¶</option>
          </select>
          <textarea id="newNote" rows="3" placeholder="–ù–æ–≤–∞—è –∑–∞–º–µ—Ç–∫–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: –ü–æ–¥–∫–ª—é—á–∏—Ç—å –ò–ò –Ω–∞ —ç—Ç—É –∏–Ω—Å—Ç—É)"></textarea>
          <button id="addNoteBtn">üíæ –î–æ–±–∞–≤–∏—Ç—å –∑–∞–º–µ—Ç–∫—É</button>
        </div>
        <div id="notesList" class="notes-list small">–í—ã–±–µ—Ä–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</div>
      </div>
    </div>
  </div>

  
  <div id="tab-insights" class="tab-content">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;flex-wrap:wrap;gap:12px;">
        <h3>üí° –£–º–Ω—ã–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏</h3>
        <div style="display:flex;gap:12px;align-items:center;">
          <select id="insightUserSelect" style="width:200px;">
            <option value="">–í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</option>
          </select>
          <button id="generateInsightsBtn">‚ú® –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫–∏</button>
        </div>
      </div>
      <div id="insightsList" class="small muted">–ù–∞–∂–º–∏ "–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫–∏" –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞</div>
    </div>
  </div>

  
  <div id="tab-worklog" class="tab-content">
    <div class="grid">
      <div class="card">
        <h3>‚ûï –î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å</h3>
        <div style="display:grid;gap:12px;">
          <select id="worklogUser">
            <option value="">–í—ã–±–µ—Ä–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è‚Ä¶</option>
          </select>
          <input type="date" id="worklogDate" />
          <select id="worklogStatus">
            <option value="working">‚úÖ –í—ã—à–µ–ª –Ω–∞ —Ä–∞–±–æ—Ç—É</option>
            <option value="absent">‚ùå –ù–µ –≤—ã—à–µ–ª –Ω–∞ —Ä–∞–±–æ—Ç—É</option>
            <option value="evening">üåô –í—ã–π–¥–µ—Ç –≤–µ—á–µ—Ä–æ–º</option>
          </select>
          <textarea id="worklogReason" rows="3" placeholder="–ü—Ä–∏—á–∏–Ω–∞ (–µ—Å–ª–∏ –Ω–µ –≤—ã—à–µ–ª)"></textarea>
          <button id="addWorklogBtn">üíæ –î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å</button>
          <div id="worklogStatusMsg" class="small muted"></div>
        </div>
      </div>
      <div class="card">
        <h3>üìú –ò—Å—Ç–æ—Ä–∏—è —Ä–∞–±–æ—Ç—ã</h3>
        <div style="display:flex;gap:12px;margin-bottom:16px;">
          <button id="prevDayBtn" class="secondary">‚óÄ –ù–∞–∑–∞–¥</button>
          <input type="date" id="worklogDatePicker" style="flex:1;" />
          <button id="nextDayBtn" class="secondary">–í–ø–µ—Ä–µ–¥ ‚ñ∂</button>
        </div>
        <div id="worklogList" style="max-height:500px;overflow:auto;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
      </div>
    </div>
  </div>
</div>

<script>
/* ========= Helpers ========= */
async function fetchJson(url, opts){ const res = await fetch(url, opts); return res.json(); }
const reportsTable = document.getElementById('reportsTable');
let statsChart = null;
let comparisonChart = null;
let top5TrendChart = null;
let currentWorklogDate = new Date();
let isSelectOpen = false;

function escapeHtml(text){
  if(!text && text!==0) return '';
  return String(text).replace(/[&<>"']/g, m => ({'&':'&','<':'<','>':'>','"':'"',"'":"'"}[m]));
}

function formatDate(date) {
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  return `${year}-${month}-${day}`;
}

function formatDisplayDate(date) {
  const options = { year: 'numeric', month: 'long', day: 'numeric' };
  return date.toLocaleDateString('ru-RU', options);
}

/* ========= Tab Switching ========= */
document.querySelectorAll('.tab').forEach(tab => {
  tab.addEventListener('click', () => {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
    tab.classList.add('active');
    const tabName = tab.dataset.tab;
    document.getElementById('tab-' + tabName).style.display = 'block';
    
    if(tabName === 'stats'){
      loadStatistics();
    } else if(tabName === 'insights'){
      loadInsights();
    } else if(tabName === 'rankings'){
      loadRankings();
    } else if(tabName === 'mynotes'){
      loadPersonalNotes();
    }
  });
});

/* ========= Preserve scroll state ========= */
let lastRefreshTime = Date.now();
const REFRESH_COOLDOWN = 3000;

function preserveStateStart(){
  return {
    scrollY: window.scrollY || document.documentElement.scrollTop || document.body.scrollTop || 0,
    activeElement: document.activeElement
  };
}

function preserveStateEnd(state){
  window.scrollTo({ top: state.scrollY, behavior: 'auto' });
  if(state.activeElement && document.body.contains(state.activeElement)) {
    try { state.activeElement.focus({ preventScroll: true }); } catch(e) {}
  }
}

document.addEventListener('mousedown', (e) => {
  if (e.target.tagName === 'SELECT') {
    isSelectOpen = true;
  }
});

document.addEventListener('change', (e) => {
  if (e.target.tagName === 'SELECT') {
    isSelectOpen = false;
  }
});

document.addEventListener('blur', (e) => {
  if (e.target.tagName === 'SELECT') {
    setTimeout(() => { isSelectOpen = false; }, 100);
  }
}, true);

/* ========= REPORTS ========= */
async function loadReports(){
  if (isSelectOpen) return;
  
  const state = preserveStateStart();
  try{
    const res = await fetchJson('/api/reports');
    if(!res.ok){ reportsTable.innerHTML='<tr><td colspan="7">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</td></tr>'; preserveStateEnd(state); return; }
    const pendingReports = res.reports.filter(r=>r.status==='pending');

    const existingMap = {};
    reportsTable.querySelectorAll('tr[data-report-id]').forEach(tr=>{
      existingMap[tr.dataset.reportId] = tr;
    });

    pendingReports.forEach(rep=>{
      const id = String(rep.id);
      let tr = existingMap[id];
      if(!tr){
        tr = document.createElement('tr');
        tr.className = 'pending-row';
        tr.dataset.reportId = id;
        tr.innerHTML = `
          <td class="table-username">${escapeHtml(rep.username||'‚Äî')}</td>
          <td class="table-instagram">${escapeHtml(rep.instagram_username||'‚Äî')}</td>
          <td class="report-text" style="white-space:normal;word-break:break-word">${escapeHtml(rep.text)}</td>
          <td><input type="number" class="happn-input" value="0" style="width:70px" min="0" /></td>
          <td><input type="number" class="leads-input" value="0" style="width:70px" min="0" /></td>
          <td><input type="date" class="date-input" value="${rep.report_date||formatDate(new Date())}" style="width:140px" /></td>
          <td>
            <button class="action-btn approve">‚úî</button>
            <button class="action-btn reject" style="margin-left:8px">‚úñ</button>
          </td>
        `;
        reportsTable.appendChild(tr);

        const happnInput = tr.querySelector('.happn-input');
        const leadsInput = tr.querySelector('.leads-input');
        const dateInput = tr.querySelector('.date-input');
        
        tr.querySelector('.approve').addEventListener('click', async ()=>{
          const happn = parseInt(happnInput.value)||0;
          const leads = parseInt(leadsInput.value)||0;
          const date = dateInput.value;
          try {
            await fetch(`/api/reports/${id}/approve`,{
              method:'POST',
              headers:{'Content-Type':'application/json'},
              body: JSON.stringify({ happn_accounts: happn, leads_converted: leads, report_date: date })
            });
            tr.remove();
            await loadGlobalStats();
          } catch(e){ console.error(e); }
        });
        
        tr.querySelector('.reject').addEventListener('click', async ()=>{
          try {
            await fetch(`/api/reports/${id}/reject`,{ method:'POST' });
            tr.remove();
          } catch(e){ console.error(e); }
        });
      }
      delete existingMap[id];
    });

    Object.keys(existingMap).forEach(oldId=>{
      const tr = existingMap[oldId];
      if(tr) tr.remove();
    });

  }catch(e){ console.error('loadReports err', e); }
  preserveStateEnd(state);
}

/* ========= GLOBAL STATS ========= */
async function loadGlobalStats(){
  try{
    const res = await fetchJson('/api/stats/global');
    if(!res.ok) return;
    
    document.getElementById('totalHappn').textContent = res.data.happn || 0;
    document.getElementById('totalLeads').textContent = res.data.leads || 0;
    document.getElementById('totalUsers').textContent = res.data.users || 0;
    
    const approvalRes = await fetchJson('/api/stats/approvals');
    if(approvalRes.ok){
      const approved = approvalRes.stats.total_approved || 0;
      const rejected = approvalRes.stats.total_rejected || 0;
      const total = approved + rejected;
      const rate = total > 0 ? Math.round((approved / total) * 100) : 0;
      document.getElementById('approvalRate').textContent = rate + '%';
    }
  }catch(e){ console.error('loadGlobalStats err', e); }
}

/* ========= FEEDBACK ========= */
document.getElementById('sendFeedbackBtn').addEventListener('click', async () => {
  const userId = document.getElementById('feedbackUserSelect').value;
  const text = document.getElementById('feedbackText').value.trim();
  const status = document.getElementById('feedbackStatus');

  if (!userId) { status.textContent = "–í—ã–±–µ—Ä–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è!"; return; }
  if (!text) { status.textContent = "–ù–∞–ø–∏—à–∏ —Ç–µ–∫—Å—Ç —Ñ–∏–¥–±—ç–∫–∞!"; return; }
  status.textContent = "–û—Ç–ø—Ä–∞–≤–∫–∞‚Ä¶";

  try {
    const res = await fetch('/api/feedback/send', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ telegram_id: userId, text })
    });
    const data = await res.json();
    if (data.ok) {
      status.textContent = "‚úÖ –§–∏–¥–±–µ–∫ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!";
      document.getElementById('feedbackText').value = "";
    } else {
      status.textContent = "‚ùå –û—à–∏–±–∫–∞: " + data.error;
    }
  } catch (e) {
    console.error(e);
    status.textContent = "‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è";
  }
});

/* ========= TEAM MANAGEMENT ========= */
async function loadTeam(){
  if (isSelectOpen) return;
  
  try{
    const res = await fetchJson('/api/users');
    if(!res.ok){ document.getElementById('teamList').innerText='–û—à–∏–±–∫–∞'; return; }
    
    const teamList = document.getElementById('teamList');
    teamList.innerHTML = '';
    
    res.users.forEach(u=>{
      const div = document.createElement('div');
      div.className='user-row';
      div.dataset.userId = u.id;
      const uname = u.username || ('id:'+u.id);
      div.innerHTML = `
        <div style="flex:1;">
          <div style="font-weight:600;color:var(--accent);">${escapeHtml(uname)}</div>
          <div class="small">Instagram: ${escapeHtml(u.instagram_username||'‚Äî')}</div>
        </div>
        <input type="text" class="instagram-input" placeholder="@instagram" value="${escapeHtml(u.instagram_username||'')}" style="width:140px;" data-user-id="${u.id}" />
        <select class="table-select role-select" data-user-id="${u.id}">
          <option value="">–í—ã–±—Ä–∞—Ç—å —Ä–æ–ª—å</option>
          <option value="–¢—Ä–∞—Ñ–µ—Ä" ${u.role==='–¢—Ä–∞—Ñ–µ—Ä'?'selected':''}>–¢—Ä–∞—Ñ–µ—Ä</option>
          <option value="–ù–æ–≤–∏—á–æ–∫ –¢—Ä–∞—Ñ–µ—Ä" ${u.role==='–ù–æ–≤–∏—á–æ–∫ –¢—Ä–∞—Ñ–µ—Ä'?'selected':''}>–ù–æ–≤–∏—á–æ–∫ –¢—Ä–∞—Ñ–µ—Ä</option>
          <option value="–¢–∏–º –õ–∏–¥" ${u.role==='–¢–∏–º –õ–∏–¥'?'selected':''}>–¢–∏–º –õ–∏–¥</option>
          <option value="‚≠êÔ∏è –†–∞—Ñ" ${u.role==='‚≠êÔ∏è –†–∞—Ñ'?'selected':''}>‚≠êÔ∏è –†–∞—Ñ</option>
        </select>
        <button class="action-btn reject delete-user" data-user-id="${u.id}" title="–£–¥–∞–ª–∏—Ç—å">‚úñ</button>
      `;
      teamList.appendChild(div);
    });

    teamList.querySelectorAll('.instagram-input').forEach(input => {
      input.addEventListener('blur', async (e) => {
        const userId = e.target.dataset.userId;
        const instagram = e.target.value.trim();
        try {
          await fetch(`/api/users/${userId}/instagram`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ instagram })
          });
        } catch (err) {
          console.error('Instagram update error', err);
        }
      });
    });

    teamList.querySelectorAll('.role-select').forEach(sel => {
      sel.addEventListener('change', async (e) => {
        const userId = e.target.dataset.userId;
        const role = e.target.value;
        try {
          await fetch(`/api/users/${userId}/role`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ role })
          });
        } catch (err) {
          console.error('Role update error', err);
        }
      });
    });

    teamList.querySelectorAll('.delete-user').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        const userId = e.target.dataset.userId;
        if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?')) return;
        try {
          await fetch(`/api/users/${userId}`, { method: 'DELETE' });
          await loadTeam();
        } catch (err) {
          console.error('Delete error', err);
        }
      });
    });

    fillFeedbackUsers(res.users);
    fillWorklogUsers(res.users);
    fillInsightUsers(res.users);
    fillNotesUsers(res.users);
    fillUserStatsSelect(res.users);
    
  }catch(e){ console.error(e); document.getElementById('teamList').innerText='–û—à–∏–±–∫–∞'; }
}

document.getElementById('addUserBtn').addEventListener('click', async () => {
  const username = document.getElementById('newUsername').value.trim();
  const status = document.getElementById('addUserStatus');
  
  if (!username) {
    status.textContent = '–í–≤–µ–¥–∏ username!';
    return;
  }
  
  status.textContent = '–î–æ–±–∞–≤–ª–µ–Ω–∏–µ...';
  
  try {
    const res = await fetch('/api/users/add', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ username })
    });
    const data = await res.json();
    
    if (data.ok) {
      status.textContent = '‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–±–∞–≤–ª–µ–Ω!';
      document.getElementById('newUsername').value = '';
      await loadTeam();
    } else {
      status.textContent = '‚ùå –û—à–∏–±–∫–∞: ' + data.error;
    }
  } catch (e) {
    console.error(e);
    status.textContent = '‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è';
  }
});

function fillFeedbackUsers(users){
  const sel = document.getElementById('feedbackUserSelect');
  if(!sel) return;
  const cur = sel.value;
  sel.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è‚Ä¶</option>';
  users.forEach(u=>{
    const option = document.createElement('option');
    option.value = u.telegram_id || '';
    option.textContent = u.username || ('id:'+u.id);
    sel.appendChild(option);
  });
  if(cur) sel.value = cur;
}

function fillWorklogUsers(users){
  const sel = document.getElementById('worklogUser');
  if(!sel) return;
  const cur = sel.value;
  sel.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è‚Ä¶</option>';
  users.forEach(u=>{
    const option = document.createElement('option');
    option.value = u.id;
    option.textContent = u.username || ('id:'+u.id);
    sel.appendChild(option);
  });
  if(cur) sel.value = cur;
}

function fillInsightUsers(users){
  const sel = document.getElementById('insightUserSelect');
  if(!sel) return;
  const cur = sel.value;
  sel.innerHTML = '<option value="">–í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</option>';
  users.forEach(u=>{
    const option = document.createElement('option');
    option.value = u.id;
    option.textContent = u.username || ('id:'+u.id);
    sel.appendChild(option);
  });
  if(cur) sel.value = cur;
}

function fillNotesUsers(users){
  const sel = document.getElementById('notesUserSelect');
  if(!sel) return;
  const cur = sel.value;
  sel.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è‚Ä¶</option>';
  users.forEach(u=>{
    const option = document.createElement('option');
    option.value = u.id;
    option.textContent = u.username || ('id:'+u.id);
    sel.appendChild(option);
  });
  if(cur) sel.value = cur;
}

function fillUserStatsSelect(users){
  const sel = document.getElementById('userStatsSelect');
  if(!sel) return;
  const cur = sel.value;
  sel.innerHTML = '<option value="">–í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</option>';
  users.forEach(u=>{
    const option = document.createElement('option');
    option.value = u.id;
    option.textContent = u.username || ('id:'+u.id);
    sel.appendChild(option);
  });
  if(cur) sel.value = cur;
}

/* ========= MANAGER NOTES ========= */
document.getElementById('notesUserSelect').addEventListener('change', async (e) => {
  const userId = e.target.value;
  if(!userId){
    document.getElementById('notesList').innerHTML = '–í—ã–±–µ—Ä–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è';
    return;
  }
  await loadNotes(userId);
});

document.getElementById('addNoteBtn').addEventListener('click', async () => {
  const userId = document.getElementById('notesUserSelect').value;
  const note = document.getElementById('newNote').value.trim();
  
  if(!userId || !note){
    alert('–í—ã–±–µ—Ä–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –≤–≤–µ–¥–∏ –∑–∞–º–µ—Ç–∫—É!');
    return;
  }
  
  try{
    const res = await fetch('/api/notes/add', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ user_id: userId, note })
    });
    const data = await res.json();
    if(data.ok){
      document.getElementById('newNote').value = '';
      await loadNotes(userId);
    }
  }catch(e){
    console.error('Add note error', e);
  }
});

async function loadNotes(userId){
  try{
    const res = await fetchJson(`/api/notes/${userId}`);
    if(!res.ok) return;
    
    const list = document.getElementById('notesList');
    if(res.notes.length === 0){
      list.innerHTML = '<div class="small muted">–ù–µ—Ç –∑–∞–º–µ—Ç–æ–∫</div>';
      return;
    }
    
    list.innerHTML = '';
    res.notes.forEach(note => {
      const div = document.createElement('div');
      div.className = 'note-item';
      div.innerHTML = `
        <div style="flex:1;">${escapeHtml(note.note)}</div>
        <button class="action-btn reject" data-note-id="${note.id}">‚úñ</button>
      `;
      list.appendChild(div);
      
      div.querySelector('.reject').addEventListener('click', async () => {
        try{
          await fetch(`/api/notes/${note.id}`, { method: 'DELETE' });
          await loadNotes(userId);
        }catch(e){
          console.error('Delete note error', e);
        }
      });
    });
  }catch(e){
    console.error('Load notes error', e);
  }
}

/* ========= PERSONAL NOTES (STICKY NOTES) ========= */
document.getElementById('addPersonalNoteBtn').addEventListener('click', async () => {
  const content = document.getElementById('newPersonalNote').value.trim();
  const color = document.getElementById('noteColor').value;
  
  if(!content){
    alert('–ù–∞–ø–∏—à–∏ —Ç–µ–∫—Å—Ç –∑–∞–º–µ—Ç–∫–∏!');
    return;
  }
  
  try{
    const res = await fetch('/api/personal-notes/add', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ content, color })
    });
    const data = await res.json();
    if(data.ok){
      document.getElementById('newPersonalNote').value = '';
      await loadPersonalNotes();
    }
  }catch(e){
    console.error('Add personal note error', e);
  }
});

async function loadPersonalNotes(){
  try{
    const res = await fetchJson('/api/personal-notes');
    if(!res.ok) return;
    
    const list = document.getElementById('personalNotesList');
    if(res.notes.length === 0){
      list.innerHTML = '<div class="small muted" style="grid-column:1/-1;text-align:center;padding:40px;">–ù–µ—Ç –∑–∞–º–µ—Ç–æ–∫. –î–æ–±–∞–≤—å —Å–≤–æ—é –ø–µ—Ä–≤—É—é –∑–∞–º–µ—Ç–∫—É!</div>';
      return;
    }
    
    list.innerHTML = '';
    res.notes.forEach(note => {
      const div = document.createElement('div');
      div.className = `sticky-note ${note.color} ${note.completed ? 'completed' : ''}`;
      div.dataset.noteId = note.id;
      
      const date = new Date(note.created_at);
      const dateStr = date.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit' });
      
      div.innerHTML = `
        <div class="sticky-note-header">
          <div class="sticky-note-date">${dateStr}</div>
          <div class="sticky-note-actions">
            <button class="sticky-note-btn complete-note" title="${note.completed ? '–í–µ—Ä–Ω—É—Ç—å' : '–í—ã–ø–æ–ª–Ω–µ–Ω–æ'}">
              ${note.completed ? '‚Ü©Ô∏è' : '‚úì'}
            </button>
            <button class="sticky-note-btn delete-note" title="–£–¥–∞–ª–∏—Ç—å">‚úñ</button>
          </div>
        </div>
        <div class="sticky-note-content">${escapeHtml(note.content)}</div>
      `;
      
      list.appendChild(div);
      
      div.querySelector('.complete-note').addEventListener('click', async (e) => {
        e.stopPropagation();
        try{
          await fetch(`/api/personal-notes/${note.id}/toggle`, { method: 'POST' });
          await loadPersonalNotes();
        }catch(err){
          console.error('Toggle note error', err);
        }
      });
      
      div.querySelector('.delete-note').addEventListener('click', async (e) => {
        e.stopPropagation();
        if(!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–º–µ—Ç–∫—É?')) return;
        try{
          await fetch(`/api/personal-notes/${note.id}`, { method: 'DELETE' });
          await loadPersonalNotes();
        }catch(err){
          console.error('Delete note error', err);
        }
      });
    });
  }catch(e){
    console.error('Load personal notes error', e);
  }
}

/* ========= STATISTICS ========= */
async function loadStatistics(){
  await loadTeamGrowth();
  await loadStatsChart('yesterday');
  await loadComparisonChart();
  await loadUserDetailedStats();
}

async function loadTeamGrowth(){
  try{
    const res = await fetchJson('/api/stats/growth/team');
    if(!res.ok) return;
    
    const container = document.getElementById('teamGrowthProgress');
    
    const cumulative = [];
    let sum = 0;
    res.growth.forEach(g => {
      sum += g.count;
      cumulative.push({ date: g.date, count: sum });
    });
    
    if(cumulative.length === 0){
      container.innerHTML = '<div class="small muted">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>';
      return;
    }
    
    const maxCount = Math.max(...cumulative.map(c => c.count));
    
    let html = '<div style="display:grid;gap:12px;">';
    cumulative.forEach((item, index) => {
      const percentage = maxCount > 0 ? (item.count / maxCount) * 100 : 0;
      const isGrowth = index > 0 && item.count > cumulative[index-1].count;
      
      html += `
        <div>
          <div style="display:flex;justify-content:space-between;margin-bottom:4px;">
            <span class="small">${item.date}</span>
            <span class="small" style="color:var(--accent);font-weight:600;">${item.count} ${isGrowth ? 'üìà' : ''}</span>
          </div>
          <div class="progress-bar">
            <div class="progress-fill" style="width:${percentage}%"></div>
          </div>
        </div>
      `;
    });
    html += '</div>';
    
    container.innerHTML = html;
  }catch(e){ console.error('loadTeamGrowth err', e); }
}

document.querySelectorAll('.period-buttons .period-btn').forEach(btn => {
  if(!btn.dataset.userPeriod){
    btn.addEventListener('click', async (e) => {
      document.querySelectorAll('.period-buttons .period-btn').forEach(b => {
        if(!b.dataset.userPeriod) b.classList.remove('active');
      });
      e.target.classList.add('active');
      
      const period = e.target.dataset.period;
      if(period === 'custom'){
        document.getElementById('customDateRange').style.display = 'flex';
      } else {
        document.getElementById('customDateRange').style.display = 'none';
        await loadStatsChart(period);
      }
    });
  }
});

document.getElementById('applyDateRange').addEventListener('click', async () => {
  const startDate = document.getElementById('statsStartDate').value;
  const endDate = document.getElementById('statsEndDate').value;
  
  if(!startDate || !endDate){
    alert('–í—ã–±–µ—Ä–∏ –æ–±–µ –¥–∞—Ç—ã!');
    return;
  }
  
  await loadStatsChart('custom', startDate, endDate);
});

async function loadStatsChart(period, startDate = null, endDate = null){
  try{
    let start, end;
    const today = new Date();
    
    if(period === 'custom' && startDate && endDate){
      start = startDate;
      end = endDate;
    } else if(period === 'yesterday'){
      const yesterday = new Date(today);
      yesterday.setDate(yesterday.getDate() - 1);
      start = end = formatDate(yesterday);
    } else if(period === 'week'){
      const weekAgo = new Date(today);
      weekAgo.setDate(weekAgo.getDate() - 7);
      start = formatDate(weekAgo);
      end = formatDate(today);
    } else if(period === 'month'){
      const monthAgo = new Date(today);
      monthAgo.setDate(monthAgo.getDate() - 30);
      start = formatDate(monthAgo);
      end = formatDate(today);
    }
    
    const [happnRes, leadsRes] = await Promise.all([
      fetchJson(`/api/stats/growth/happn?startDate=${start}&endDate=${end}`),
      fetchJson(`/api/stats/growth/leads?startDate=${start}&endDate=${end}`)
    ]);
    
    if(!happnRes.ok || !leadsRes.ok) return;
    
    const allDates = new Set();
    happnRes.growth.forEach(g => allDates.add(g.date));
    leadsRes.growth.forEach(g => allDates.add(g.date));
    
    const labels = Array.from(allDates).sort();
    
    const happnData = labels.map(date => {
      const found = happnRes.growth.find(g => g.date === date);
      return found ? found.total : 0;
    });
    
    const leadsData = labels.map(date => {
      const found = leadsRes.growth.find(g => g.date === date);
      return found ? found.total : 0;
    });
    
    const ctx = document.getElementById('statsChart').getContext('2d');
    if(statsChart){
      statsChart.data.labels = labels;
      statsChart.data.datasets[0].data = happnData;
      statsChart.data.datasets[1].data = leadsData;
      statsChart.update();
    } else {
      statsChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'Happn –∞–∫–∫–∞—É–Ω—Ç—ã',
              data: happnData,
              backgroundColor: 'rgba(245,158,11,0.8)',
              borderColor: '#f59e0b',
              borderWidth: 2,
              borderRadius: 8
            },
            {
              label: '–õ–∏–¥—ã',
              data: leadsData,
              backgroundColor: 'rgba(16,185,129,0.8)',
              borderColor: '#10b981',
              borderWidth: 2,
              borderRadius: 8
            }
          ]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              labels: {color: '#8b92a8', font: {size: 12}}
            }
          },
          scales: {
            x: {
              ticks: {color: '#8b92a8'},
              grid: {color: 'rgba(255,255,255,0.05)'}
            },
            y: {
              ticks: {
                color: '#8b92a8',
                stepSize: 1
              },
              grid: {color: 'rgba(255,255,255,0.05)'}
            }
          }
        }
      });
    }
  }catch(e){ console.error('loadStatsChart err', e); }
}

async function loadComparisonChart(){
  try{
    const res = await fetchJson('/api/stats/detailed');
    if(!res.ok) return;
    
    const stats = res.stats.slice(0, 10);
    const labels = stats.map(s => s.username || 'Unknown');
    const happnData = stats.map(s => s.happn_total || 0);
    const leadsData = stats.map(s => s.leads_total || 0);
    
    const ctx = document.getElementById('comparisonChart').getContext('2d');
    if(comparisonChart){
      comparisonChart.data.labels = labels;
      comparisonChart.data.datasets[0].data = happnData;
      comparisonChart.data.datasets[1].data = leadsData;
      comparisonChart.update();
    } else {
      comparisonChart = new Chart(ctx, {
        type: 'horizontalBar',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'Happn',
              data: happnData,
              backgroundColor: 'rgba(245,158,11,0.8)',
              borderColor: '#f59e0b',
              borderWidth: 2
            },
            {
              label: '–õ–∏–¥—ã',
              data: leadsData,
              backgroundColor: 'rgba(16,185,129,0.8)',
              borderColor: '#10b981',
              borderWidth: 2
            }
          ]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          plugins: {
            legend: {
              labels: {color: '#8b92a8', font: {size: 12}}
            }
          },
          scales: {
            x: {
              ticks: {color: '#8b92a8'},
              grid: {color: 'rgba(255,255,255,0.05)'}
            },
            y: {
              ticks: {color: '#8b92a8'},
              grid: {color: 'rgba(255,255,255,0.05)'}
            }
          }
        }
      });
    }
  }catch(e){ console.error('loadComparisonChart err', e); }
}

document.querySelectorAll('[data-user-period]').forEach(btn => {
  btn.addEventListener('click', async (e) => {
    document.querySelectorAll('[data-user-period]').forEach(b => b.classList.remove('active'));
    e.target.classList.add('active');
    
    const period = e.target.dataset.userPeriod;
    if(period === 'custom'){
      document.getElementById('userCustomDateRange').style.display = 'flex';
    } else {
      document.getElementById('userCustomDateRange').style.display = 'none';
      await loadUserDetailedStats(period);
    }
  });
});

document.getElementById('userStatsSelect').addEventListener('change', async () => {
  const activePeriod = document.querySelector('[data-user-period].active');
  const period = activePeriod ? activePeriod.dataset.userPeriod : 'all';
  await loadUserDetailedStats(period);
});

document.getElementById('applyUserDateRange').addEventListener('click', async () => {
  const startDate = document.getElementById('userStatsStartDate').value;
  const endDate = document.getElementById('userStatsEndDate').value;
  
  if(!startDate || !endDate){
    alert('–í—ã–±–µ—Ä–∏ –æ–±–µ –¥–∞—Ç—ã!');
    return;
  }
  
  await loadUserDetailedStats('custom', startDate, endDate);
});

async function loadUserDetailedStats(period = 'all', startDate = null, endDate = null){
  try{
    const userId = document.getElementById('userStatsSelect').value;
    
    let start, end;
    const today = new Date();
    
    if(period === 'custom' && startDate && endDate){
      start = startDate;
      end = endDate;
    } else if(period === 'week'){
      const weekAgo = new Date(today);
      weekAgo.setDate(weekAgo.getDate() - 7);
      start = formatDate(weekAgo);
      end = formatDate(today);
    } else if(period === 'month'){
      const monthAgo = new Date(today);
      monthAgo.setDate(monthAgo.getDate() - 30);
      start = formatDate(monthAgo);
      end = formatDate(today);
    }
    
    let url = '/api/stats/detailed';
    if(start && end){
      url = `/api/stats/by-date?startDate=${start}&endDate=${end}`;
    }
    
    const res = await fetchJson(url);
    if(!res.ok) return;
    
    let stats = res.stats;
    
    if(userId){
      stats = stats.filter(s => s.id === parseInt(userId));
    }
    
    const container = document.getElementById('userDetailedStats');
    
    if(stats.length === 0){
      container.innerHTML = '<div class="small muted">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>';
      return;
    }
    
    stats.sort((a, b) => {
      const totalA = (a.happn_total || 0) + (a.leads_total || 0);
      const totalB = (b.happn_total || 0) + (b.leads_total || 0);
      return totalB - totalA;
    });
    
    let html = '';
    stats.forEach((user, index) => {
      const happn = user.happn_total || 0;
      const leads = user.leads_total || 0;
      const total = happn + leads;
      
      const isTopPerformer = index < 3 && total > 20;
      const topBadge = isTopPerformer ? `<span style="display:inline-flex;align-items:center;gap:6px;padding:6px 12px;border-radius:12px;font-size:12px;font-weight:600;background:linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);color:#0a0e1a;margin-left:8px;">üèÜ –¢–æ–ø-${index + 1}</span>` : '';
      
      let requirementText = '';
      if(user.role === '–¢—Ä–∞—Ñ–µ—Ä'){
        const status = leads >= 10 ? '‚úÖ' : '‚ö†Ô∏è';
        requirementText = `${status} –ù–æ—Ä–º–∞: 10 –ª–∏–¥–æ–≤ (—Ç–µ–∫—É—â–µ–µ: ${leads})`;
      } else if(user.role === '–ù–æ–≤–∏—á–æ–∫ –¢—Ä–∞—Ñ–µ—Ä'){
        const dailyAvg = period === 'week' ? (happn / 7).toFixed(1) : (happn / 30).toFixed(1);
        const status = dailyAvg >= 5 ? '‚úÖ' : '‚ö†Ô∏è';
        requirementText = `${status} –ù–æ—Ä–º–∞: 5 –∞–∫–∫–∞—É–Ω—Ç–æ–≤/–¥–µ–Ω—å (—Å—Ä–µ–¥–Ω: ${dailyAvg})`;
      } else if(user.role === '–¢–∏–º –õ–∏–¥' || user.role === '‚≠êÔ∏è –†–∞—Ñ'){
        requirementText = '‚ú® –ù–µ—Ç –æ–±—è–∑–∞—Ç–µ–ª—å—Å—Ç–≤';
      }
      
      html += `
        <div style="padding:20px;background:rgba(255,255,255,0.03);border-radius:16px;border:1px solid var(--glass-border);">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
            <div>
              <div style="font-weight:600;font-size:18px;color:var(--accent);margin-bottom:4px;">
                ${escapeHtml(user.username || 'Unknown')}${topBadge}
              </div>
              <div class="small">–†–æ–ª—å: ${user.role || '–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∞'} ¬∑ Instagram: ${escapeHtml(user.instagram_username || '‚Äî')}</div>
              ${requirementText ? `<div class="small" style="margin-top:4px;">${requirementText}</div>` : ''}
            </div>
            <div style="text-align:right;">
              <div style="font-size:24px;font-weight:700;color:var(--accent);">${total}</div>
              <div class="small">–≤—Å–µ–≥–æ</div>
            </div>
          </div>
          
          <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:12px;">
            <div class="stat-card">
              <div style="font-size:20px;font-weight:700;color:#f59e0b;">${happn}</div>
              <div class="stat-label">Happn –∞–∫–∫–∞—É–Ω—Ç—ã</div>
            </div>
            <div class="stat-card">
              <div style="font-size:20px;font-weight:700;color:#10b981;">${leads}</div>
              <div class="stat-label">–õ–∏–¥—ã</div>
            </div>
          </div>
        </div>
      `;
    });
    
    container.innerHTML = html;
  }catch(e){ console.error('loadUserDetailedStats err', e); }
}

/* ========= RANKINGS ========= */
async function loadRankings(){
  await loadRankingToday();
  await loadRankingWeek();
  await loadRankingMonth();
  await loadTop5TrendChart();
  await loadAchievements();
}

async function loadRankingToday(){
  try{
    const today = formatDate(new Date());
    const res = await fetchJson(`/api/stats/ranking?period=today&date=${today}`);
    if(!res.ok) return;
    
    renderRanking('rankingToday', res.ranking);
  }catch(e){ console.error('loadRankingToday err', e); }
}

async function loadRankingWeek(){
  try{
    const res = await fetchJson('/api/stats/ranking?period=week');
    if(!res.ok) return;
    
    renderRanking('rankingWeek', res.ranking);
  }catch(e){ console.error('loadRankingWeek err', e); }
}

async function loadRankingMonth(){
  try{
    const res = await fetchJson('/api/stats/ranking?period=month');
    if(!res.ok) return;
    
    renderRanking('rankingMonth', res.ranking);
  }catch(e){ console.error('loadRankingMonth err', e); }
}

function renderRanking(containerId, ranking){
  const container = document.getElementById(containerId);
  if(!container) return;
  
  if(ranking.length === 0){
    container.innerHTML = '<div class="small muted">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>';
    return;
  }
  
  let html = '';
  ranking.forEach((user, index) => {
    const rank = index + 1;
    let rankClass = 'rank-other';
    if(rank === 1) rankClass = 'rank-1';
    else if(rank === 2) rankClass = 'rank-2';
    else if(rank === 3) rankClass = 'rank-3';
    
    const total = user.total || 0;
    const happn = user.happn_total || 0;
    const leads = user.leads_total || 0;
    
    html += `
      <div class="top-ranking-item">
        <div class="rank-badge ${rankClass}">${rank}</div>
        <div style="flex:1;margin-left:12px;">
          <div style="font-weight:600;color:var(--accent);">${escapeHtml(user.username || 'Unknown')}</div>
          <div class="small">Happn: ${happn} ¬∑ –õ–∏–¥—ã: ${leads}</div>
        </div>
        <div style="text-align:right;">
          <div style="font-size:20px;font-weight:700;color:var(--accent);">${total}</div>
          <div class="small">–≤—Å–µ–≥–æ</div>
        </div>
      </div>
    `;
  });
  
  container.innerHTML = html;
}

async function loadTop5TrendChart(){
  try{
    const res = await fetchJson('/api/stats/top5-trend');
    if(!res.ok) return;
    
    const dates = res.trend.dates || [];
    const users = res.trend.users || [];
    
    const colors = [
      'rgba(245,158,11,0.8)',
      'rgba(16,185,129,0.8)',
      'rgba(59,130,246,0.8)',
      'rgba(168,85,247,0.8)',
      'rgba(239,68,68,0.8)'
    ];
    
    const datasets = users.map((user, index) => ({
      label: user.username,
      data: user.data,
      borderColor: colors[index],
      backgroundColor: colors[index].replace('0.8', '0.2'),
      borderWidth: 2,
      tension: 0.4,
      fill: true
    }));
    
    const ctx = document.getElementById('top5TrendChart').getContext('2d');
    if(top5TrendChart){
      top5TrendChart.data.labels = dates;
      top5TrendChart.data.datasets = datasets;
      top5TrendChart.update();
    } else {
      top5TrendChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: dates,
          datasets: datasets
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              labels: {color: '#8b92a8', font: {size: 12}}
            }
          },
          scales: {
            x: {
              ticks: {color: '#8b92a8'},
              grid: {color: 'rgba(255,255,255,0.05)'}
            },
            y: {
              ticks: {color: '#8b92a8'},
              grid: {color: 'rgba(255,255,255,0.05)'}
            }
          }
        }
      });
    }
  }catch(e){ console.error('loadTop5TrendChart err', e); }
}

async function loadAchievements(){
  try{
    const res = await fetchJson('/api/stats/achievements');
    if(!res.ok) return;
    
    const container = document.getElementById('achievements');
    const achievements = res.achievements || [];
    
    if(achievements.length === 0){
      container.innerHTML = '<div class="small muted">–ù–µ—Ç –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π</div>';
      return;
    }
    
    let html = '';
    achievements.forEach(ach => {
      html += `
        <div style="padding:16px;background:rgba(255,255,255,0.03);border-radius:12px;border:1px solid var(--glass-border);">
          <div style="display:flex;align-items:center;gap:12px;">
            <div style="font-size:32px;">${ach.icon}</div>
            <div style="flex:1;">
              <div style="font-weight:600;color:var(--accent);">${escapeHtml(ach.title)}</div>
              <div class="small">${escapeHtml(ach.description)}</div>
            </div>
          </div>
        </div>
      `;
    });
    
    container.innerHTML = html;
  }catch(e){ console.error('loadAchievements err', e); }
}

/* ========= INSIGHTS ========= */
document.getElementById('generateInsightsBtn').addEventListener('click', async () => {
  const btn = document.getElementById('generateInsightsBtn');
  const userId = document.getElementById('insightUserSelect').value;
  
  btn.textContent = '‚è≥ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è...';
  btn.disabled = true;
  
  try {
    const body = userId ? JSON.stringify({ user_id: userId }) : '{}';
    const res = await fetch('/api/insights/generate', { 
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: body
    });
    const data = await res.json();
    
    if (data.ok) {
      await loadInsights();
    }
  } catch (e) {
    console.error('Insights generation error', e);
  } finally {
    btn.textContent = '‚ú® –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫–∏';
    btn.disabled = false;
  }
});

async function loadInsights() {
  try {
    const res = await fetchJson('/api/insights');
    if (!res.ok) return;
    
    const listEl = document.getElementById('insightsList');
    
    if (res.insights.length === 0) {
      listEl.innerHTML = '<div class="small muted">–ù–µ—Ç –ø–æ–¥—Å–∫–∞–∑–æ–∫. –ù–∞–∂–º–∏ "–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫–∏"</div>';
      return;
    }
    
    let html = '';
    res.insights.forEach(insight => {
      let style = 'padding:16px;margin:8px 0;border-left:4px solid var(--accent);background:rgba(245,158,11,0.08);border-radius:12px;';
      
      if (insight.category === 'success') {
        style = 'padding:16px;margin:8px 0;border-left:4px solid var(--accent-green);background:rgba(16,185,129,0.08);border-radius:12px;';
      } else if (insight.category === 'improvement' || insight.category === 'warning') {
        style = 'padding:16px;margin:8px 0;border-left:4px solid var(--accent-red);background:rgba(239,68,68,0.08);border-radius:12px;';
      }
      
      html += `<div style="${style}">${escapeHtml(insight.content)}</div>`;
    });
    
    listEl.innerHTML = html;
  } catch (e) {
    console.error('Load insights error', e);
  }
}

/* ========= WORK LOG ========= */
document.getElementById('addWorklogBtn').addEventListener('click', async () => {
  const userId = document.getElementById('worklogUser').value;
  const date = document.getElementById('worklogDate').value;
  const status = document.getElementById('worklogStatus').value;
  const reason = document.getElementById('worklogReason').value.trim();
  const statusEl = document.getElementById('worklogStatusMsg');
  
  if (!userId || !date) {
    statusEl.textContent = '–ó–∞–ø–æ–ª–Ω–∏ –≤—Å–µ –ø–æ–ª—è!';
    return;
  }
  
  try {
    const res = await fetch('/api/worklogs/add', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ user_id: userId, date, status, reason })
    });
    const data = await res.json();
    
    if (data.ok) {
      statusEl.textContent = '‚úÖ –ó–∞–ø–∏—Å—å –¥–æ–±–∞–≤–ª–µ–Ω–∞!';
      document.getElementById('worklogReason').value = '';
      document.getElementById('worklogUser').value = '';
      document.getElementById('worklogStatus').value = 'working';
      await loadWorklogsByDate(currentWorklogDate);
    }
  } catch (e) {
    console.error('Add worklog error', e);
  }
});

document.getElementById('worklogDatePicker').addEventListener('change', (e) => {
  currentWorklogDate = new Date(e.target.value);
  loadWorklogsByDate(currentWorklogDate);
});

document.getElementById('prevDayBtn').addEventListener('click', () => {
  currentWorklogDate.setDate(currentWorklogDate.getDate() - 1);
  document.getElementById('worklogDatePicker').valueAsDate = currentWorklogDate;
  loadWorklogsByDate(currentWorklogDate);
});

document.getElementById('nextDayBtn').addEventListener('click', () => {
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  const nextDate = new Date(currentWorklogDate);
  nextDate.setDate(nextDate.getDate() + 1);
  nextDate.setHours(0, 0, 0, 0);
  
  if (nextDate <= today) {
    currentWorklogDate = nextDate;
    document.getElementById('worklogDatePicker').valueAsDate = currentWorklogDate;
    loadWorklogsByDate(currentWorklogDate);
  }
});

async function loadWorklogsByDate(date) {
  try {
    const dateStr = formatDate(date);
    const res = await fetchJson(`/api/worklogs?date=${dateStr}`);
    if (!res.ok) return;
    
    const listEl = document.getElementById('worklogList');
    
    if (res.logs.length === 0) {
      listEl.innerHTML = '<div class="small muted">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π –∑–∞ —ç—Ç–æ—Ç –¥–µ–Ω—å</div>';
      return;
    }
    
    let html = '';
    res.logs.forEach(log => {
      let badgeStyle = 'padding:6px 14px;border-radius:12px;font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;';
      let statusText = '';
      
      if (log.status === 'working') {
        badgeStyle += 'background:linear-gradient(135deg, var(--accent-green) 0%, #059669 100%);color:#fff;';
        statusText = '‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç';
      } else if (log.status === 'absent') {
        badgeStyle += 'background:linear-gradient(135deg, var(--accent-red) 0%, #dc2626 100%);color:#fff;';
        statusText = '‚ùå –ù–µ –≤—ã—à–µ–ª';
      } else if (log.status === 'evening') {
        badgeStyle += 'background:linear-gradient(135deg, var(--accent) 0%, var(--accent-hover) 100%);color:#0a0e1a;';
        statusText = 'üåô –í–µ—á–µ—Ä–æ–º';
      }
      
      html += `
        <div style="padding:16px;margin:8px 0;border-radius:16px;background:rgba(255,255,255,0.03);display:flex;justify-content:space-between;align-items:center;border:1px solid var(--glass-border);">
          <div>
            <div style="font-weight:600;margin-bottom:4px;">${escapeHtml(log.username || 'Unknown')}</div>
            <div class="small muted">${log.reason ? escapeHtml(log.reason) : '‚Äî'}</div>
          </div>
          <span style="${badgeStyle}">${statusText}</span>
        </div>
      `;
    });
    
    listEl.innerHTML = html;
  } catch (e) {
    console.error('Load worklogs error', e);
  }
}

document.getElementById('worklogDate').valueAsDate = new Date();
document.getElementById('worklogDatePicker').valueAsDate = new Date();
currentWorklogDate = new Date();

/* ========= AUTO-REFRESH ========= */
let periodicHandle = null;

async function refreshAll(){
  if (isSelectOpen) return;
  
  const now = Date.now();
  if (now - lastRefreshTime < REFRESH_COOLDOWN) return;
  lastRefreshTime = now;
  
  const state = preserveStateStart();
  await Promise.all([ 
    loadReports(), 
    loadTeam(), 
    loadGlobalStats()
  ]);
  preserveStateEnd(state);
}

(async function init(){
  await refreshAll();
  await loadInsights();
  await loadWorklogsByDate(currentWorklogDate);
  
  if(periodicHandle) clearInterval(periodicHandle);
  periodicHandle = setInterval(async ()=>{ 
    if(document.hidden) return; 
    await refreshAll(); 
  }, 3000);
})();

window.addEventListener('beforeunload', ()=>{ if(periodicHandle) clearInterval(periodicHandle); });
</script>
</body>
</html>



server.js:    import express from 'express';
import bodyParser from 'body-parser';
import cors from 'cors';
import path from 'path';
import { fileURLToPath } from 'url';
import dotenv from 'dotenv';
import TelegramBot from 'node-telegram-bot-api';
import * as db from './database.js';

dotenv.config();
const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const BOT_TOKEN = process.env.BOT_TOKEN;
const BOT_ADMIN_ID = process.env.BOT_ADMIN_ID || '';
const WEBHOOK_URL = process.env.WEBHOOK_URL;
const PORT = process.env.PORT || 3000;

db.init();

const app = express();
app.use(cors());
app.use(bodyParser.json({ limit: '200kb' }));
app.use(bodyParser.urlencoded({ extended: true }));
app.use('/', express.static(path.join(__dirname, 'public')));

// --- Telegram bot via webhook ---
let bot = null;
if (BOT_TOKEN && WEBHOOK_URL) {
  try {
    bot = new TelegramBot(BOT_TOKEN, { webHook: true });
    const webhookPath = '/tg';
    const fullWebhookUrl = WEBHOOK_URL.replace(/\/$/, '') + webhookPath;

    (async () => {
      await bot.setWebHook(fullWebhookUrl);
      console.log('Telegram webhook set ‚Üí', fullWebhookUrl);
    })().catch(err => {
      console.error('Failed to set webhook:', err?.response?.body || err);
    });

    app.post(webhookPath, (req, res) => {
      try {
        bot.processUpdate(req.body);
        res.sendStatus(200);
      } catch (err) {
        console.error('Bot processUpdate error', err);
        res.sendStatus(500);
      }
    });

    bot.onText(/\/start/, async (msg) => {
      try {
        const chatId = msg.chat.id;
        const username = msg.from.username || null;
        const display = `${msg.from.first_name || ''} ${msg.from.last_name || ''}`.trim();
        await db.ensureUserByTelegram(String(chatId), username, display);
        await bot.sendMessage(chatId, `–ü—Ä–∏–≤–µ—Ç, ${display || username || 'User'}! –¢—ã –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω.`);
      } catch (e) {
        console.error('/start handler error', e);
      }
    });

    bot.on('message', async (msg) => {
      try {
        if (!msg.text || msg.text.startsWith('/')) return;
        const username = msg.from.username ? `@${msg.from.username}` : `${msg.from.first_name || ''} ${msg.from.last_name || ''}`.trim();
        const user = await db.ensureUserByTelegram(String(msg.chat.id), username, username);

        const now = new Date();
        const reportDate = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;

        await db.addReport({
          user_id: user.id,
          text: msg.text,
          report_date: reportDate,
          created_at: Date.now()
        });

        if (BOT_ADMIN_ID) {
          await bot.sendMessage(BOT_ADMIN_ID, `üìù –ù–æ–≤—ã–π –æ—Ç—á–µ—Ç –æ—Ç ${username}: ${msg.text}`);
        }

        await bot.sendMessage(msg.chat.id, '–í–∞—à –æ—Ç—á–µ—Ç –ø–æ–ª—É—á–µ–Ω –∏ –æ–∂–∏–¥–∞–µ—Ç –æ–¥–æ–±—Ä–µ–Ω–∏—è.');
      } catch (e) {
        console.error('message handler error', e);
      }
    });

  } catch (err) {
    console.error('Telegram init error', err);
    bot = null;
  }
} else {
  console.warn('BOT_TOKEN or WEBHOOK_URL not set ‚Äî telegram disabled.');
}

// === API ENDPOINTS ===

// --- USERS ---

app.get('/api/users', async (req, res) => {
  try {
    const users = await db.listUsers();
    res.json({ ok: true, users });
  } catch (e) {
    res.status(500).json({ ok: false, error: e.message });
  }
});

app.post('/api/users/add', async (req, res) => {
  try {
    const { username } = req.body;
    if (!username) return res.json({ ok: false, error: 'Username required' });
    const user = await db.addUserByUsername(username);
    res.json({ ok: true, user });
  } catch (e) {
    res.status(500).json({ ok: false, error: e.message });
  }
});

app.post('/api/users/:id/role', async (req, res) => {
  try {
    const { role } = req.body;
    const user = await db.updateUserRole(req.params.id, role);
    res.json({ ok: true, user });
  } catch (e) {
    res.status(500).json({ ok: false, error: e.message });
  }
});

app.post('/api/users/:id/instagram', async (req, res) => {
  try {
    const { instagram } = req.body;
    const user = await db.updateUserInstagram(req.params.id, instagram);
    res.json({ ok: true, user });
  } catch (e) {
    res.status(500).json({ ok: false, error: e.message });
  }
});

app.delete('/api/users/:id', async (req, res) => {
  try {
    await db.deleteUser(req.params.id);
    res.json({ ok: true });
  } catch (e) {
    res.status(500).json({ ok: false, error: e.message });
  }
});

// --- MANAGER NOTES ---

app.get('/api/notes/:userId', async (req, res) => {
  try {
    const notes = await db.listManagerNotes(req.params.userId);
    res.json({ ok: true, notes });
  } catch (e) {
    res.status(500).json({ ok: false, error: e.message });
  }
});

app.post('/api/notes/add', async (req, res) => {
  try {
    const { user_id, note } = req.body;
    if (!user_id || !note) return res.json({ ok: false, error: 'Missing fields' });
    const newNote = await db.addManagerNote({ user_id, note });
    res.json({ ok: true, note: newNote });
  } catch (e) {
    res.status(500).json({ ok: false, error: e.message });
  }
});

app.delete('/api/notes/:id', async (req, res) => {
  try {
    await db.deleteManagerNote(req.params.id);
    res.json({ ok: true });
  } catch (e) {
    res.status(500).json({ ok: false, error: e.message });
  }
});

// --- PERSONAL NOTES (STICKY NOTES) ---

app.get('/api/personal-notes', async (req, res) => {
  try {
    const notes = await db.listPersonalNotes();
    res.json({ ok: true, notes });
  } catch (e) {
    res.status(500).json({ ok: false, error: e.message });
  }
});

app.post('/api/personal-notes/add', async (req, res) => {
  try {
    const { content, color } = req.body;
    if (!content) return res.json({ ok: false, error: 'Content required' });
    const note = await db.addPersonalNote({ content, color: color || 'yellow' });
    res.json({ ok: true, note });
  } catch (e) {
    res.status(500).json({ ok: false, error: e.message });
  }
});

app.post('/api/personal-notes/:id/toggle', async (req, res) => {
  try {
    const note = await db.togglePersonalNote(req.params.id);
    res.json({ ok: true, note });
  } catch (e) {
    res.status(500).json({ ok: false, error: e.message });
  }
});

app.delete('/api/personal-notes/:id', async (req, res) => {
  try {
    await db.deletePersonalNote(req.params.id);
    res.json({ ok: true });
  } catch (e) {
    res.status(500).json({ ok: false, error: e.message });
  }
});

// --- REPORTS ---

app.get('/api/reports', async (req, res) => {
  try {
    const reports = await db.listReports();
    res.json({ ok: true, reports });
  } catch (e) {
    res.status(500).json({ ok: false, error: e.message });
  }
});

app.post('/api/reports/:id/approve', async (req, res) => {
  try {
    const { happn_accounts = 0, leads_converted = 0, report_date = null } = req.body;
    await db.updateReportStatus(req.params.id, 'approved', happn_accounts, leads_converted, report_date);
    res.json({ ok: true });
  } catch (e) {
    res.status(500).json({ ok: false, error: e.message });
  }
});

app.post('/api/reports/:id/reject', async (req, res) => {
  try {
    await db.updateReportStatus(req.params.id, 'rejected');
    res.json({ ok: true });
  } catch (e) {
    res.status(500).json({ ok: false, error: e.message });
  }
});

// --- STATISTICS ---

app.get('/api/stats/global', async (req, res) => {
  try {
    const { startDate, endDate } = req.query;
    
    let stats;
    if (startDate && endDate) {
      stats = await db.getStatsByDateRange(startDate, endDate);
    } else {
      stats = await db.getDetailedStats();
    }
    
    const totals = {
      happn: stats.reduce((sum, s) => sum + (s.happn_total || 0), 0),
      leads: stats.reduce((sum, s) => sum + (s.leads_total || 0), 0),
      users: stats.length
    };
    
    res.json({ ok: true, data: totals });
  } catch (e) {
    res.status(500).json({ ok: false, error: e.message });
  }
});

app.get('/api/stats/detailed', async (req, res) => {
  try {
    const stats = await db.getDetailedStats();
    res.json({ ok: true, stats });
  } catch (e) {
    res.status(500).json({ ok: false, error: e.message });
  }
});

app.get('/api/stats/by-date', async (req, res) => {
  try {
    const { startDate, endDate } = req.query;
    if (!startDate || !endDate) {
      return res.json({ ok: false, error: 'startDate and endDate required' });
    }
    const stats = await db.getStatsByDateRange(startDate, endDate);
    res.json({ ok: true, stats });
  } catch (e) {
    res.status(500).json({ ok: false, error: e.message });
  }
});

app.get('/api/stats/by-user/:userId', async (req, res) => {
  try {
    const { startDate, endDate } = req.query;
    const stats = await db.getStatsByUser(req.params.userId, startDate, endDate);
    res.json({ ok: true, stats });
  } catch (e) {
    res.status(500).json({ ok: false, error: e.message });
  }
});

app.get('/api/stats/daily/:date', async (req, res) => {
  try {
    const stats = await db.getDailyStats(req.params.date);
    res.json({ ok: true, stats });
  } catch (e) {
    res.status(500).json({ ok: false, error: e.message });
  }
});

app.get('/api/stats/approvals', async (req, res) => {
  try {
    const stats = await db.getApprovalStats();
    res.json({ ok: true, stats });
  } catch (e) {
    res.status(500).json({ ok: false, error: e.message });
  }
});

app.get('/api/stats/growth/team', async (req, res) => {
  try {
    const growth = await db.getTeamGrowth();
    res.json({ ok: true, growth });
  } catch (e) {
    res.status(500).json({ ok: false, error: e.message });
  }
});

app.get('/api/stats/growth/happn', async (req, res) => {
  try {
    const { startDate, endDate } = req.query;
    const growth = await db.getHappnGrowth(startDate, endDate);
    res.json({ ok: true, growth });
  } catch (e) {
    res.status(500).json({ ok: false, error: e.message });
  }
});

app.get('/api/stats/growth/leads', async (req, res) => {
  try {
    const { startDate, endDate } = req.query;
    const growth = await db.getLeadsGrowth(startDate, endDate);
    res.json({ ok: true, growth });
  } catch (e) {
    res.status(500).json({ ok: false, error: e.message });
  }
});

app.get('/api/stats/absences', async (req, res) => {
  try {
    const ranking = await db.getAbsenceRanking();
    res.json({ ok: true, ranking });
  } catch (e) {
    res.status(500).json({ ok: false, error: e.message });
  }
});

// --- RANKINGS ---

app.get('/api/stats/ranking', async (req, res) => {
  try {
    const { period, date } = req.query;
    let ranking = [];
    
    if (period === 'today' && date) {
      ranking = await db.getRankingByDate(date);
    } else if (period === 'week') {
      const endDate = new Date();
      const startDate = new Date();
      startDate.setDate(startDate.getDate() - 7);
      ranking = await db.getRankingByPeriod(
        `${startDate.getFullYear()}-${String(startDate.getMonth() + 1).padStart(2, '0')}-${String(startDate.getDate()).padStart(2, '0')}`,
        `${endDate.getFullYear()}-${String(endDate.getMonth() + 1).padStart(2, '0')}-${String(endDate.getDate()).padStart(2, '0')}`
      );
    } else if (period === 'month') {
      const endDate = new Date();
      const startDate = new Date();
      startDate.setDate(startDate.getDate() - 30);
      ranking = await db.getRankingByPeriod(
        `${startDate.getFullYear()}-${String(startDate.getMonth() + 1).padStart(2, '0')}-${String(startDate.getDate()).padStart(2, '0')}`,
        `${endDate.getFullYear()}-${String(endDate.getMonth() + 1).padStart(2, '0')}-${String(endDate.getDate()).padStart(2, '0')}`
      );
    }
    
    res.json({ ok: true, ranking: ranking.slice(0, 5) });
  } catch (e) {
    res.status(500).json({ ok: false, error: e.message });
  }
});

app.get('/api/stats/top5-trend', async (req, res) => {
  try {
    const trend = await db.getTop5Trend();
    res.json({ ok: true, trend });
  } catch (e) {
    res.status(500).json({ ok: false, error: e.message });
  }
});

app.get('/api/stats/achievements', async (req, res) => {
  try {
    const achievements = await db.getAchievements();
    res.json({ ok: true, achievements });
  } catch (e) {
    res.status(500).json({ ok: false, error: e.message });
  }
});

// --- FEEDBACK ---

app.post('/api/feedback/send', async (req, res) => {
  try {
    const { telegram_id, text } = req.body;
    if (!telegram_id) return res.json({ ok: false, error: 'telegram_id missing' });
    if (!text) return res.json({ ok: false, error: 'text missing' });
    if (!bot) return res.json({ ok: false, error: 'Bot not active' });

    const message = `üì® *–§–∏–¥–±–µ–∫ –æ—Ç –º–µ–Ω–µ–¥–∂–µ—Ä–∞*\n\n${text}`;
    await bot.sendMessage(String(telegram_id), message, { parse_mode: 'Markdown' });

    res.json({ ok: true });
  } catch (e) {
    console.error('feedback send error', e);
    res.status(500).json({ ok: false, error: e.message });
  }
});

// --- WORK LOGS ---

app.get('/api/worklogs', async (req, res) => {
  try {
    const { date } = req.query;
    const logs = date ? await db.listWorkLogsByDate(date) : await db.listWorkLogs();
    res.json({ ok: true, logs });
  } catch (e) {
    res.status(500).json({ ok: false, error: e.message });
  }
});

app.post('/api/worklogs/add', async (req, res) => {
  try {
    const { user_id, date, status, reason } = req.body;
    if (!user_id || !date || !status) {
      return res.json({ ok: false, error: 'Missing required fields' });
    }
    const log = await db.addWorkLog({ user_id, date, status, reason: reason || '' });
    res.json({ ok: true, log });
  } catch (e) {
    res.status(500).json({ ok: false, error: e.message });
  }
});

// --- INSIGHTS ---

app.get('/api/insights', async (req, res) => {
  try {
    const insights = await db.listInsights();
    res.json({ ok: true, insights });
  } catch (e) {
    res.status(500).json({ ok: false, error: e.message });
  }
});

app.post('/api/insights/generate', async (req, res) => {
  try {
    const { user_id } = req.body;
    const stats = await db.getDetailedStats();
    const insights = [];

    if (user_id) {
      const user = stats.find(u => u.id === parseInt(user_id));
      if (user) {
        const happnAccounts = user.happn_total || 0;
        const leads = user.leads_total || 0;
        
        if (user.role === '–¢—Ä–∞—Ñ–µ—Ä') {
          if (leads < 10) {
            insights.push({
              content: `${user.username} (–¢—Ä–∞—Ñ–µ—Ä): –í—Å–µ–≥–æ ${leads} –ª–∏–¥–æ–≤. –ù–æ—Ä–º–∞ 10 –ª–∏–¥–æ–≤. –¢—Ä–µ–±—É–µ—Ç—Å—è —É–ª—É—á—à–µ–Ω–∏–µ.`,
              category: 'warning',
              user_id: user.id
            });
          } else {
            insights.push({
              content: `${user.username} (–¢—Ä–∞—Ñ–µ—Ä): –û—Ç–ª–∏—á–Ω–æ! ${leads} –ª–∏–¥–æ–≤. –ù–æ—Ä–º–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞! üéØ`,
              category: 'success',
              user_id: user.id
            });
          }
          
          if (!user.instagram_username) {
            insights.push({
              content: `${user.username} (–¢—Ä–∞—Ñ–µ—Ä): ‚ö†Ô∏è –ù–µ —É–∫–∞–∑–∞–Ω Instagram –∞–∫–∫–∞—É–Ω—Ç. –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è —Ä–æ–ª–∏ –¢—Ä–∞—Ñ–µ—Ä!`,
              category: 'warning',
              user_id: user.id
            });
          }
        } else if (user.role === '–ù–æ–≤–∏—á–æ–∫ –¢—Ä–∞—Ñ–µ—Ä') {
          const dailyAvg = happnAccounts / 7;
          if (dailyAvg < 5) {
            insights.push({
              content: `${user.username} (–ù–æ–≤–∏—á–æ–∫): ${happnAccounts} –∞–∫–∫–∞—É–Ω—Ç–æ–≤ Happn –∑–∞ –Ω–µ–¥–µ–ª—é (—Å—Ä–µ–¥–Ω. ${dailyAvg.toFixed(1)}/–¥–µ–Ω—å). –ù–æ—Ä–º–∞ 5/–¥–µ–Ω—å.`,
              category: 'improvement',
              user_id: user.id
            });
          } else {
            insights.push({
              content: `${user.username} (–ù–æ–≤–∏—á–æ–∫): –•–æ—Ä–æ—à–∞—è —Ä–∞–±–æ—Ç–∞! ${happnAccounts} –∞–∫–∫–∞—É–Ω—Ç–æ–≤ (—Å—Ä–µ–¥–Ω. ${dailyAvg.toFixed(1)}/–¥–µ–Ω—å). üëç`,
              category: 'success',
              user_id: user.id
            });
          }
        }
      }
    } else {
      stats.forEach(user => {
        const happnAccounts = user.happn_total || 0;
        const leads = user.leads_total || 0;
        
        if (user.role === '–¢—Ä–∞—Ñ–µ—Ä' && leads < 10) {
          insights.push({
            content: `${user.username} (–¢—Ä–∞—Ñ–µ—Ä): ${leads} –ª–∏–¥–æ–≤. –ù–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ –Ω–æ—Ä–º–∞ (10 –ª–∏–¥–æ–≤).`,
            category: 'warning',
            user_id: user.id
          });
        }
        
        if (user.role === '–ù–æ–≤–∏—á–æ–∫ –¢—Ä–∞—Ñ–µ—Ä' && happnAccounts < 35) {
          insights.push({
            content: `${user.username} (–ù–æ–≤–∏—á–æ–∫): ${happnAccounts} –∞–∫–∫–∞—É–Ω—Ç–æ–≤ –∑–∞ –Ω–µ–¥–µ–ª—é. –ù–æ—Ä–º–∞ 5/–¥–µ–Ω—å (35/–Ω–µ–¥–µ–ª—é).`,
            category: 'improvement',
            user_id: user.id
          });
        }
      });
    }

    for (const insight of insights) {
      await db.addInsight(insight);
    }

    res.json({ ok: true, insights });
  } catch (e) {
    console.error('insights generation error', e);
    res.status(500).json({ ok: false, error: e.message });
  }
});

// SPA fallback
app.get('*', (req, res, next) => {
  if (req.path.startsWith('/api') || req.path.startsWith('/tg')) return next();
  res.sendFile(path.join(__dirname, 'public', 'index.html'));
});

app.listen(PORT, () => console.log(`Server running on port ${PORT}`));


database.js:   import sqlite3pkg from 'sqlite3';
const sqlite3 = sqlite3pkg.verbose();

const db = new sqlite3.Database('./database.sqlite');

// === CREATE TABLES ===
export function init() {
  db.serialize(() => {
    // Users table with role field
    db.run(`
      CREATE TABLE IF NOT EXISTS users (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        telegram_id TEXT UNIQUE,
        username TEXT UNIQUE,
        display_name TEXT,
        role TEXT DEFAULT '',
        instagram_username TEXT DEFAULT '',
        created_at INTEGER DEFAULT 0
      )
    `);

    // Reports table with enhanced fields
    db.run(`
      CREATE TABLE IF NOT EXISTS reports (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        user_id INTEGER,
        text TEXT,
        report_date TEXT,
        created_at INTEGER,
        status TEXT DEFAULT 'pending',
        happn_accounts INTEGER DEFAULT 0,
        leads_converted INTEGER DEFAULT 0,
        FOREIGN KEY(user_id) REFERENCES users(id)
      )
    `);

    // Manager notes table
    db.run(`
      CREATE TABLE IF NOT EXISTS manager_notes (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        user_id INTEGER,
        note TEXT,
        created_at INTEGER,
        FOREIGN KEY(user_id) REFERENCES users(id)
      )
    `);

    // Personal notes table (sticky notes)
    db.run(`
      CREATE TABLE IF NOT EXISTS personal_notes (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        content TEXT,
        color TEXT DEFAULT 'yellow',
        completed INTEGER DEFAULT 0,
        created_at INTEGER,
        updated_at INTEGER
      )
    `);

    // Feedback table
    db.run(`
      CREATE TABLE IF NOT EXISTS feedback (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        user_id INTEGER,
        manager_id INTEGER,
        message TEXT,
        created_at INTEGER,
        FOREIGN KEY(user_id) REFERENCES users(id),
        FOREIGN KEY(manager_id) REFERENCES users(id)
      )
    `);

    // Work log table
    db.run(`
      CREATE TABLE IF NOT EXISTS work_logs (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        user_id INTEGER,
        date TEXT,
        status TEXT,
        reason TEXT,
        created_at INTEGER,
        FOREIGN KEY(user_id) REFERENCES users(id)
      )
    `);

    // Insights table
    db.run(`
      CREATE TABLE IF NOT EXISTS insights (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        content TEXT,
        category TEXT,
        user_id INTEGER,
        created_at INTEGER,
        FOREIGN KEY(user_id) REFERENCES users(id)
      )
    `);
  });
}

// === USER MANAGEMENT ===

export function ensureUserByTelegram(telegram_id, username, display) {
  return new Promise((resolve, reject) => {
    db.get(
      `SELECT * FROM users WHERE telegram_id = ?`,
      [telegram_id],
      (err, row) => {
        if (err) return reject(err);
        if (row) return resolve(row);

        db.run(
          `INSERT INTO users (telegram_id, username, display_name, created_at) VALUES (?, ?, ?, ?)`,
          [telegram_id, username, display, Date.now()],
          function (err2) {
            if (err2) return reject(err2);
            db.get(`SELECT * FROM users WHERE id = ?`, [this.lastID], (e, r) =>
              e ? reject(e) : resolve(r)
            );
          }
        );
      }
    );
  });
}

export function addUserByUsername(username) {
  return new Promise((resolve, reject) => {
    db.run(
      `INSERT INTO users (username, display_name, created_at) VALUES (?, ?, ?)`,
      [username, username, Date.now()],
      function (err) {
        if (err) return reject(err);
        db.get(`SELECT * FROM users WHERE id = ?`, [this.lastID], (e, r) =>
          e ? reject(e) : resolve(r)
        );
      }
    );
  });
}

export function updateUserRole(userId, role) {
  return new Promise((resolve, reject) => {
    db.run(
      `UPDATE users SET role = ? WHERE id = ?`,
      [role, userId],
      function (err) {
        if (err) return reject(err);
        db.get(`SELECT * FROM users WHERE id = ?`, [userId], (e, r) =>
          e ? reject(e) : resolve(r)
        );
      }
    );
  });
}

export function updateUserInstagram(userId, instagram) {
  return new Promise((resolve, reject) => {
    db.run(
      `UPDATE users SET instagram_username = ? WHERE id = ?`,
      [instagram, userId],
      function (err) {
        if (err) return reject(err);
        db.get(`SELECT * FROM users WHERE id = ?`, [userId], (e, r) =>
          e ? reject(e) : resolve(r)
        );
      }
    );
  });
}

export function deleteUser(userId) {
  return new Promise((resolve, reject) => {
    db.run(`DELETE FROM users WHERE id = ?`, [userId], (err) =>
      err ? reject(err) : resolve({ ok: true })
    );
  });
}

export function getUserByUsername(username) {
  return new Promise((resolve, reject) => {
    db.get(`SELECT * FROM users WHERE username = ?`, [username], (err, row) =>
      err ? reject(err) : resolve(row)
    );
  });
}

export function listUsers() {
  return new Promise((resolve, reject) => {
    db.all(`SELECT * FROM users ORDER BY id DESC`, (err, rows) =>
      err ? reject(err) : resolve(rows)
    );
  });
}

// === REPORTS ===

export function addReport({ user_id, text, report_date, created_at }) {
  return new Promise((resolve, reject) => {
    db.run(
      `INSERT INTO reports (user_id, text, report_date, created_at)
       VALUES (?, ?, ?, ?)`,
      [user_id, text, report_date, created_at],
      function (err) {
        if (err) return reject(err);
        db.get(`SELECT reports.*, users.username FROM reports LEFT JOIN users ON users.id = reports.user_id WHERE reports.id = ?`, [this.lastID], (e, r) =>
          e ? reject(e) : resolve(r)
        );
      }
    );
  });
}

export function listReports(limit = 1000) {
  return new Promise((resolve, reject) => {
    db.all(
      `SELECT reports.*, users.username, users.instagram_username
       FROM reports 
       LEFT JOIN users ON users.id = reports.user_id
       ORDER BY reports.id DESC 
       LIMIT ?`,
      [limit],
      (err, rows) => (err ? reject(err) : resolve(rows))
    );
  });
}

export function updateReportStatus(id, status, happn_accounts = 0, leads_converted = 0, report_date = null) {
  return new Promise((resolve, reject) => {
    let query = `UPDATE reports SET status = ?, happn_accounts = ?, leads_converted = ?`;
    let params = [status, happn_accounts, leads_converted];
    
    if (report_date) {
      query += `, report_date = ?`;
      params.push(report_date);
    }
    
    query += ` WHERE id = ?`;
    params.push(id);
    
    db.run(query, params, function (err) {
      if (err) return reject(err);
      db.get(
        `SELECT reports.*, users.username, users.instagram_username
         FROM reports
         LEFT JOIN users ON users.id = reports.user_id
         WHERE reports.id = ?`,
        [id],
        (e, row) => (e ? reject(e) : resolve(row))
      );
    });
  });
}

// === MANAGER NOTES ===

export function addManagerNote({ user_id, note }) {
  return new Promise((resolve, reject) => {
    db.run(
      `INSERT INTO manager_notes (user_id, note, created_at) VALUES (?, ?, ?)`,
      [user_id, note, Date.now()],
      function (err) {
        if (err) return reject(err);
        db.get(`SELECT * FROM manager_notes WHERE id = ?`, [this.lastID], (e, r) =>
          e ? reject(e) : resolve(r)
        );
      }
    );
  });
}

export function listManagerNotes(userId) {
  return new Promise((resolve, reject) => {
    db.all(
      `SELECT * FROM manager_notes WHERE user_id = ? ORDER BY created_at DESC`,
      [userId],
      (err, rows) => (err ? reject(err) : resolve(rows))
    );
  });
}

export function deleteManagerNote(noteId) {
  return new Promise((resolve, reject) => {
    db.run(`DELETE FROM manager_notes WHERE id = ?`, [noteId], (err) =>
      err ? reject(err) : resolve({ ok: true })
    );
  });
}

// === PERSONAL NOTES (STICKY NOTES) ===

export function addPersonalNote({ content, color }) {
  return new Promise((resolve, reject) => {
    const now = Date.now();
    db.run(
      `INSERT INTO personal_notes (content, color, created_at, updated_at) VALUES (?, ?, ?, ?)`,
      [content, color, now, now],
      function (err) {
        if (err) return reject(err);
        db.get(`SELECT * FROM personal_notes WHERE id = ?`, [this.lastID], (e, r) =>
          e ? reject(e) : resolve(r)
        );
      }
    );
  });
}

export function listPersonalNotes() {
  return new Promise((resolve, reject) => {
    db.all(
      `SELECT * FROM personal_notes ORDER BY completed ASC, created_at DESC`,
      (err, rows) => (err ? reject(err) : resolve(rows))
    );
  });
}

export function togglePersonalNote(noteId) {
  return new Promise((resolve, reject) => {
    db.get(`SELECT * FROM personal_notes WHERE id = ?`, [noteId], (err, row) => {
      if (err) return reject(err);
      if (!row) return reject(new Error('Note not found'));
      
      const newCompleted = row.completed ? 0 : 1;
      db.run(
        `UPDATE personal_notes SET completed = ?, updated_at = ? WHERE id = ?`,
        [newCompleted, Date.now(), noteId],
        function (err2) {
          if (err2) return reject(err2);
          db.get(`SELECT * FROM personal_notes WHERE id = ?`, [noteId], (e, r) =>
            e ? reject(e) : resolve(r)
          );
        }
      );
    });
  });
}

export function deletePersonalNote(noteId) {
  return new Promise((resolve, reject) => {
    db.run(`DELETE FROM personal_notes WHERE id = ?`, [noteId], (err) =>
      err ? reject(err) : resolve({ ok: true })
    );
  });
}

// === FEEDBACK ===

export function addFeedback({ user_id, manager_id, message, created_at }) {
  return new Promise((resolve, reject) => {
    db.run(
      `INSERT INTO feedback (user_id, manager_id, message, created_at)
       VALUES (?, ?, ?, ?)`,
      [user_id, manager_id, message, created_at],
      function (err) {
        if (err) return reject(err);
        db.get(`SELECT * FROM feedback WHERE id = ?`, [this.lastID], (e, r) =>
          e ? reject(e) : resolve(r)
        );
      }
    );
  });
}

export function listFeedback() {
  return new Promise((resolve, reject) => {
    db.all(
      `SELECT feedback.*, u.username AS user_name, m.username AS manager_name
       FROM feedback
       LEFT JOIN users u ON u.id = feedback.user_id
       LEFT JOIN users m ON m.id = feedback.manager_id
       ORDER BY feedback.id DESC`,
      (err, rows) => (err ? reject(err) : resolve(rows))
    );
  });
}

// === WORK LOGS ===

export function addWorkLog({ user_id, date, status, reason }) {
  return new Promise((resolve, reject) => {
    db.run(
      `INSERT INTO work_logs (user_id, date, status, reason, created_at)
       VALUES (?, ?, ?, ?, ?)`,
      [user_id, date, status, reason, Date.now()],
      function (err) {
        if (err) return reject(err);
        db.get(`SELECT * FROM work_logs WHERE id = ?`, [this.lastID], (e, r) =>
          e ? reject(e) : resolve(r)
        );
      }
    );
  });
}

export function listWorkLogs(limit = 100) {
  return new Promise((resolve, reject) => {
    db.all(
      `SELECT work_logs.*, users.username, users.display_name
       FROM work_logs
       LEFT JOIN users ON users.id = work_logs.user_id
       ORDER BY work_logs.date DESC, work_logs.created_at DESC
       LIMIT ?`,
      [limit],
      (err, rows) => (err ? reject(err) : resolve(rows))
    );
  });
}

export function listWorkLogsByDate(date) {
  return new Promise((resolve, reject) => {
    db.all(
      `SELECT work_logs.*, users.username, users.display_name
       FROM work_logs
       LEFT JOIN users ON users.id = work_logs.user_id
       WHERE work_logs.date = ?
       ORDER BY work_logs.created_at DESC`,
      [date],
      (err, rows) => (err ? reject(err) : resolve(rows))
    );
  });
}

// === INSIGHTS ===

export function addInsight({ content, category, user_id }) {
  return new Promise((resolve, reject) => {
    db.run(
      `INSERT INTO insights (content, category, user_id, created_at) VALUES (?, ?, ?, ?)`,
      [content, category, user_id || null, Date.now()],
      function (err) {
        if (err) return reject(err);
        db.get(`SELECT * FROM insights WHERE id = ?`, [this.lastID], (e, r) =>
          e ? reject(e) : resolve(r)
        );
      }
    );
  });
}

export function listInsights(limit = 50) {
  return new Promise((resolve, reject) => {
    db.all(
      `SELECT insights.*, users.username
       FROM insights
       LEFT JOIN users ON users.id = insights.user_id
       ORDER BY created_at DESC LIMIT ?`,
      [limit],
      (err, rows) => (err ? reject(err) : resolve(rows))
    );
  });
}

// === STATISTICS ===

export function getDetailedStats() {
  return new Promise((resolve, reject) => {
    db.all(
      `SELECT 
         users.id,
         users.username,
         users.role,
         users.instagram_username,
         COUNT(reports.id) AS total_reports,
         SUM(CASE WHEN reports.status = 'approved' THEN 1 ELSE 0 END) AS approved_reports,
         SUM(CASE WHEN reports.status = 'rejected' THEN 1 ELSE 0 END) AS rejected_reports,
         SUM(CASE WHEN reports.status = 'approved' THEN reports.happn_accounts ELSE 0 END) AS happn_total,
         SUM(CASE WHEN reports.status = 'approved' THEN reports.leads_converted ELSE 0 END) AS leads_total
       FROM users
       LEFT JOIN reports ON reports.user_id = users.id
       GROUP BY users.id
       ORDER BY approved_reports DESC`,
      (err, rows) => (err ? reject(err) : resolve(rows))
    );
  });
}

export function getStatsByDateRange(startDate, endDate) {
  return new Promise((resolve, reject) => {
    db.all(
      `SELECT 
         users.id,
         users.username,
         users.role,
         users.instagram_username,
         SUM(CASE WHEN reports.status = 'approved' THEN reports.happn_accounts ELSE 0 END) AS happn_total,
         SUM(CASE WHEN reports.status = 'approved' THEN reports.leads_converted ELSE 0 END) AS leads_total
       FROM users
       LEFT JOIN reports ON reports.user_id = users.id AND reports.report_date >= ? AND reports.report_date <= ?
       GROUP BY users.id
       ORDER BY happn_total DESC`,
      [startDate, endDate],
      (err, rows) => (err ? reject(err) : resolve(rows))
    );
  });
}

export function getStatsByUser(userId, startDate = null, endDate = null) {
  return new Promise((resolve, reject) => {
    let query = `
      SELECT 
        reports.report_date,
        SUM(CASE WHEN reports.status = 'approved' THEN reports.happn_accounts ELSE 0 END) AS happn_accounts,
        SUM(CASE WHEN reports.status = 'approved' THEN reports.leads_converted ELSE 0 END) AS leads_converted
      FROM reports
      WHERE reports.user_id = ?
    `;
    
    let params = [userId];
    
    if (startDate && endDate) {
      query += ` AND reports.report_date >= ? AND reports.report_date <= ?`;
      params.push(startDate, endDate);
    }
    
    query += ` GROUP BY reports.report_date ORDER BY reports.report_date DESC`;
    
    db.all(query, params, (err, rows) => (err ? reject(err) : resolve(rows)));
  });
}

export function getApprovalStats() {
  return new Promise((resolve, reject) => {
    db.get(
      `SELECT 
         SUM(CASE WHEN status = 'approved' THEN 1 ELSE 0 END) AS total_approved,
         SUM(CASE WHEN status = 'rejected' THEN 1 ELSE 0 END) AS total_rejected
       FROM reports`,
      (err, row) => (err ? reject(err) : resolve(row))
    );
  });
}

export function getTeamGrowth() {
  return new Promise((resolve, reject) => {
    db.all(
      `SELECT 
         DATE(created_at / 1000, 'unixepoch') as date,
         COUNT(*) as count
       FROM users
       GROUP BY date
       ORDER BY date ASC`,
      (err, rows) => (err ? reject(err) : resolve(rows))
    );
  });
}

export function getHappnGrowth(startDate = null, endDate = null) {
  return new Promise((resolve, reject) => {
    let query = `
      SELECT 
        report_date as date,
        SUM(happn_accounts) as total
      FROM reports
      WHERE status = 'approved'
    `;
    
    let params = [];
    
    if (startDate && endDate) {
      query += ` AND report_date >= ? AND report_date <= ?`;
      params.push(startDate, endDate);
    }
    
    query += ` GROUP BY report_date ORDER BY report_date ASC`;
    
    db.all(query, params, (err, rows) => (err ? reject(err) : resolve(rows)));
  });
}

export function getLeadsGrowth(startDate = null, endDate = null) {
  return new Promise((resolve, reject) => {
    let query = `
      SELECT 
        report_date as date,
        SUM(leads_converted) as total
      FROM reports
      WHERE status = 'approved'
    `;
    
    let params = [];
    
    if (startDate && endDate) {
      query += ` AND report_date >= ? AND report_date <= ?`;
      params.push(startDate, endDate);
    }
    
    query += ` GROUP BY report_date ORDER BY report_date ASC`;
    
    db.all(query, params, (err, rows) => (err ? reject(err) : resolve(rows)));
  });
}

export function getAbsenceRanking() {
  return new Promise((resolve, reject) => {
    db.all(
      `SELECT 
         users.id,
         users.username,
         users.display_name,
         COUNT(work_logs.id) as absence_count
       FROM users
       LEFT JOIN work_logs ON work_logs.user_id = users.id AND work_logs.status = 'absent'
       GROUP BY users.id
       HAVING absence_count > 0
       ORDER BY absence_count DESC
       LIMIT 10`,
      (err, rows) => (err ? reject(err) : resolve(rows))
    );
  });
}

export function getDailyStats(date) {
  return new Promise((resolve, reject) => {
    db.all(
      `SELECT 
         users.id,
         users.username,
         users.instagram_username,
         SUM(CASE WHEN reports.status = 'approved' THEN reports.happn_accounts ELSE 0 END) AS happn_accounts,
         SUM(CASE WHEN reports.status = 'approved' THEN reports.leads_converted ELSE 0 END) AS leads_converted
       FROM users
       LEFT JOIN reports ON reports.user_id = users.id AND reports.report_date = ?
       GROUP BY users.id
       ORDER BY happn_accounts DESC`,
      [date],
      (err, rows) => (err ? reject(err) : resolve(rows))
    );
  });
}

// === RANKINGS ===

export function getRankingByDate(date) {
  return new Promise((resolve, reject) => {
    db.all(
      `SELECT 
         users.id,
         users.username,
         users.role,
         SUM(CASE WHEN reports.status = 'approved' THEN reports.happn_accounts ELSE 0 END) AS happn_total,
         SUM(CASE WHEN reports.status = 'approved' THEN reports.leads_converted ELSE 0 END) AS leads_total,
         (SUM(CASE WHEN reports.status = 'approved' THEN reports.happn_accounts ELSE 0 END) + 
          SUM(CASE WHEN reports.status = 'approved' THEN reports.leads_converted ELSE 0 END)) AS total
       FROM users
       LEFT JOIN reports ON reports.user_id = users.id AND reports.report_date = ?
       GROUP BY users.id
       HAVING total > 0
       ORDER BY total DESC
       LIMIT 5`,
      [date],
      (err, rows) => (err ? reject(err) : resolve(rows))
    );
  });
}

export function getRankingByPeriod(startDate, endDate) {
  return new Promise((resolve, reject) => {
    db.all(
      `SELECT 
         users.id,
         users.username,
         users.role,
         SUM(CASE WHEN reports.status = 'approved' THEN reports.happn_accounts ELSE 0 END) AS happn_total,
         SUM(CASE WHEN reports.status = 'approved' THEN reports.leads_converted ELSE 0 END) AS leads_total,
         (SUM(CASE WHEN reports.status = 'approved' THEN reports.happn_accounts ELSE 0 END) + 
          SUM(CASE WHEN reports.status = 'approved' THEN reports.leads_converted ELSE 0 END)) AS total
       FROM users
       LEFT JOIN reports ON reports.user_id = users.id 
         AND reports.report_date >= ? 
         AND reports.report_date <= ?
       GROUP BY users.id
       HAVING total > 0
       ORDER BY total DESC
       LIMIT 5`,
      [startDate, endDate],
      (err, rows) => (err ? reject(err) : resolve(rows))
    );
  });
}

export function getTop5Trend() {
  return new Promise((resolve, reject) => {
    // Get last 7 days
    const dates = [];
    for (let i = 6; i >= 0; i--) {
      const d = new Date();
      d.setDate(d.getDate() - i);
      dates.push(`${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`);
    }
    
    // Get top 5 users overall
    db.all(
      `SELECT 
         users.id,
         users.username,
         (SUM(CASE WHEN reports.status = 'approved' THEN reports.happn_accounts ELSE 0 END) + 
          SUM(CASE WHEN reports.status = 'approved' THEN reports.leads_converted ELSE 0 END)) AS total
       FROM users
       LEFT JOIN reports ON reports.user_id = users.id
       GROUP BY users.id
       ORDER BY total DESC
       LIMIT 5`,
      (err, topUsers) => {
        if (err) return reject(err);
        
        const userPromises = topUsers.map(user => {
          return new Promise((res, rej) => {
            const dataPromises = dates.map(date => {
              return new Promise((r, rj) => {
                db.get(
                  `SELECT 
                     (SUM(CASE WHEN status = 'approved' THEN happn_accounts ELSE 0 END) + 
                      SUM(CASE WHEN status = 'approved' THEN leads_converted ELSE 0 END)) AS total
                   FROM reports
                   WHERE user_id = ? AND report_date = ?`,
                  [user.id, date],
                  (e, row) => e ? rj(e) : r(row ? row.total || 0 : 0)
                );
              });
            });
            
            Promise.all(dataPromises)
              .then(data => res({ username: user.username, data }))
              .catch(rej);
          });
        });
        
        Promise.all(userPromises)
          .then(users => resolve({ dates, users }))
          .catch(reject);
      }
    );
  });
}

export function getAchievements() {
  return new Promise((resolve, reject) => {
    const achievements = [];
    
    // Get top performer
    db.get(
      `SELECT 
         users.username,
         (SUM(CASE WHEN reports.status = 'approved' THEN reports.happn_accounts ELSE 0 END) + 
          SUM(CASE WHEN reports.status = 'approved' THEN reports.leads_converted ELSE 0 END)) AS total
       FROM users
       LEFT JOIN reports ON reports.user_id = users.id
       GROUP BY users.id
       ORDER BY total DESC
       LIMIT 1`,
      (err, topUser) => {
        if (err) return reject(err);
        
        if (topUser && topUser.total > 0) {
          achievements.push({
            icon: 'üèÜ',
            title: '–¢–æ–ø –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å',
            description: `${topUser.username} –ª–∏–¥–∏—Ä—É–µ—Ç —Å ${topUser.total} –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–º–∏ –∑–∞–¥–∞—á–∞–º–∏!`
          });
        }
        
        // Get most consistent
        db.get(
          `SELECT 
             users.username,
             COUNT(DISTINCT reports.report_date) AS days_active
           FROM users
           LEFT JOIN reports ON reports.user_id = users.id AND reports.status = 'approved'
           GROUP BY users.id
           ORDER BY days_active DESC
           LIMIT 1`,
          (err2, consistent) => {
            if (err2) return reject(err2);
            
            if (consistent && consistent.days_active > 5) {
              achievements.push({
                icon: 'üî•',
                title: '–°–∞–º—ã–π —Å—Ç–∞–±–∏–ª—å–Ω—ã–π',
                description: `${consistent.username} —Ä–∞–±–æ—Ç–∞–ª ${consistent.days_active} –¥–Ω–µ–π –ø–æ–¥—Ä—è–¥!`
              });
            }
            
            // Get team total
            db.get(
              `SELECT 
                 (SUM(CASE WHEN status = 'approved' THEN happn_accounts ELSE 0 END) + 
                  SUM(CASE WHEN status = 'approved' THEN leads_converted ELSE 0 END)) AS team_total
               FROM reports`,
              (err3, teamStats) => {
                if (err3) return reject(err3);
                
                if (teamStats && teamStats.team_total > 100) {
                  achievements.push({
                    icon: 'üéØ',
                    title: '–ö–æ–º–∞–Ω–¥–Ω–æ–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ',
                    description: `–ö–æ–º–∞–Ω–¥–∞ –≤—ã–ø–æ–ª–Ω–∏–ª–∞ ${teamStats.team_total} –∑–∞–¥–∞—á –≤–º–µ—Å—Ç–µ!`
                  });
                }
                
                resolve(achievements);
              }
            );
          }
        );
      }
    );
  });
}