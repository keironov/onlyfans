<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Team Dashboard - Enhanced</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root{
  --bg:#0b1220;
  --card:#111827;
  --muted:#9ca3af;
  --accent:#f59e0b;
  --accent-dark:#d48806;
  --input-bg:#0f1724;
  --accent-green:#10b981;
  --accent-red:#ef4444;
  --accent-blue:#3b82f6;
}
html,body{height:100%;margin:0;padding:0;background:linear-gradient(180deg,var(--bg),#0f1724);color:#e6eef8;font-family:Inter,Arial,Helvetica,sans-serif;}
.wrap{max-width:1400px;margin:20px auto;padding:18px;}
.top{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:8px;}
.card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:12px;padding:14px;box-shadow: 0 6px 18px rgba(2,6,23,0.6);margin-bottom:12px;}
.grid{display:grid;grid-template-columns:1fr 420px;gap:16px;}
.team-list{max-height:420px;overflow:auto;padding:8px;}
.user-row{display:flex;justify-content:space-between;padding:8px;border-bottom:1px dashed rgba(255,255,255,0.03);align-items:center;gap:8px;}
.muted{color:var(--muted);font-size:13px;}
.small{font-size:13px;color:var(--muted);}
h1,h3{margin:0 0 8px 0;}
input,textarea,select{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.05);background:var(--input-bg);color:inherit;box-sizing:border-box;outline:none;transition:box-shadow .18s, border-color .18s;}
input:focus, textarea:focus, select:focus{box-shadow:0 0 8px rgba(245,158,11,0.14);border-color:rgba(245,158,11,0.28);}
input[type="number"]{width:80px;padding:6px 8px;border-radius:8px;text-align:center;}
button{background:var(--accent);color:#081125;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:600;transition:opacity .2s;}
button:hover{opacity:0.9;}
button.secondary{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted);padding:6px 10px;}
button.danger{background:var(--accent-red);color:#fff;}
.action-btn{width:34px;height:34px;border-radius:8px;display:inline-flex;align-items:center;justify-content:center;font-weight:700;cursor:pointer;border:none;}
.approve{background:var(--accent-green);color:#081125;}
.reject{background:var(--accent-red);color:#fff;}
table{width:100%;border-collapse:collapse;color:#e6eef8;}
th,td{padding:8px;border-bottom:1px solid rgba(255,255,255,0.06);text-align:left;vertical-align:middle;}
thead th{color:var(--muted);font-weight:600;font-size:13px;}
.pending-row{background:transparent;}
.pending-row:hover{background:rgba(255,255,255,0.01);}
.table-select {width:140px;padding:6px;border-radius:8px;background:var(--input-bg);}
canvas{max-width:100%;}
.insight-item{padding:10px;margin:6px 0;border-left:3px solid var(--accent);background:rgba(245,158,11,0.05);border-radius:6px;}
.insight-success{border-left-color:var(--accent-green);background:rgba(16,185,129,0.05);}
.insight-warning{border-left-color:var(--accent-red);background:rgba(239,68,68,0.05);}
.worklog-item{padding:8px;margin:4px 0;border-radius:6px;background:rgba(255,255,255,0.02);display:flex;justify-content:space-between;align-items:center;}
.status-badge{padding:4px 8px;border-radius:6px;font-size:12px;font-weight:600;}
.status-working{background:var(--accent-green);color:#081125;}
.status-absent{background:var(--accent-red);color:#fff;}
.status-evening{background:var(--accent);color:#081125;}
.tabs{display:flex;gap:8px;margin-bottom:12px;border-bottom:1px solid rgba(255,255,255,0.06);}
.tab{padding:8px 16px;cursor:pointer;border-bottom:2px solid transparent;transition:all .2s;}
.tab.active{border-bottom-color:var(--accent);color:var(--accent);}
.tab:hover{background:rgba(255,255,255,0.02);}
@media (max-width:980px){ .grid{grid-template-columns:1fr;} .wrap{padding:12px;} }
</style>
</head>
<body>
<div class="wrap" id="wrap">
  <div class="top">
    <div>
      <h1>Team Dashboard - Enhanced</h1>
      <div class="muted">OnlyFans Agency Management System</div>
    </div>
    <div style="display:flex;gap:8px;align-items:center">
      <select id="periodSelect" class="period-selector" title="–ü–µ—Ä–∏–æ–¥">
        <option value="today">–°–µ–≥–æ–¥–Ω—è</option>
        <option value="yesterday">–í—á–µ—Ä–∞</option>
        <option value="week">–ù–µ–¥–µ–ª—è</option>
        <option value="month">–ú–µ—Å—è—Ü</option>
      </select>
      <button id="refreshBtn" class="secondary">Refresh</button>
    </div>
  </div>

  <div class="tabs">
    <div class="tab active" data-tab="reports">üìä –û—Ç—á–µ—Ç—ã</div>
    <div class="tab" data-tab="team">üë• –ö–æ–º–∞–Ω–¥–∞</div>
    <div class="tab" data-tab="insights">üí° –ü–æ–¥—Å–∫–∞–∑–∫–∏</div>
    <div class="tab" data-tab="worklog">üìù –ë–ª–æ–≥ —Ä–∞–±–æ—Ç—ã</div>
  </div>

  <!-- TAB: REPORTS -->
  <div id="tab-reports" class="tab-content">
    <div class="grid">
      <div>
        <div class="card">
          <h3>Global Stats</h3>
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">
            <div id="globalSummary" class="small muted">Loading...</div>
            <div style="font-size:13px;color:var(--muted)">–ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 3—Å</div>
          </div>
          <canvas id="globalChart" style="height:220px;"></canvas>
        </div>

        <div class="card">
          <h3>–û—Ç—á–µ—Ç—ã (–æ–∂–∏–¥–∞—é—â–∏–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è)</h3>
          <div style="overflow:auto;max-height:360px;">
            <table>
              <thead>
                <tr><th style="width:16%">@user</th><th style="width:44%">Text</th><th style="width:12%">Number</th><th style="width:14%">Type</th><th style="width:14%">‚úî / ‚ùå</th></tr>
              </thead>
              <tbody id="reportsTable"></tbody>
            </table>
          </div>
        </div>
      </div>

      <div>
        <div class="card">
          <h3>User Summary</h3>
          <div style="display:grid;gap:8px">
            <input id="viewUsername" placeholder="username (e.g. @ivan)" />
            <div style="display:flex;gap:8px">
              <button id="viewUserBtn">View</button>
              <button id="clearUserBtn" class="secondary">Clear</button>
            </div>
            <div id="userSummary" class="small muted">No user selected</div>
            <canvas id="userActivityChart" style="height:180px;margin-top:8px;"></canvas>
          </div>
        </div>

        <div class="card">
          <h3>–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–∏–¥–±–µ–∫</h3>
          <div style="display:grid;gap:8px">
            <select id="feedbackUserSelect">
              <option value="">–í—ã–±–µ—Ä–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è‚Ä¶</option>
            </select>
            <textarea id="feedbackText" rows="3" placeholder="–¢–µ–∫—Å—Ç —Ñ–∏–¥–±—ç–∫–∞"></textarea>
            <div style="display:flex;gap:8px;align-items:center">
              <button id="sendFeedbackBtn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
              <div id="feedbackStatus" class="small muted"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- TAB: TEAM -->
  <div id="tab-team" class="tab-content" style="display:none;">
    <div class="grid">
      <div class="card">
        <h3>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥–æ–π</h3>
        <div style="display:grid;gap:8px;margin-bottom:16px;">
          <input id="newUsername" placeholder="–í–≤–µ–¥–∏ username (–Ω–∞–ø—Ä–∏–º–µ—Ä @ivan)" />
          <button id="addUserBtn">–î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ–º–∞–Ω–¥—É</button>
          <div id="addUserStatus" class="small muted"></div>
        </div>
        <div id="teamList" class="team-list small">Loading...</div>
      </div>
      <div class="card">
        <h3>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫–æ–º–∞–Ω–¥—ã</h3>
        <div id="teamStats" class="small muted">Loading...</div>
      </div>
    </div>
  </div>

  <!-- TAB: INSIGHTS -->
  <div id="tab-insights" class="tab-content" style="display:none;">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
        <h3>–£–º–Ω—ã–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏</h3>
        <button id="generateInsightsBtn">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫–∏</button>
      </div>
      <div id="insightsList" class="small muted">–ù–∞–∂–º–∏ "–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫–∏" –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞</div>
    </div>
  </div>

  <!-- TAB: WORKLOG -->
  <div id="tab-worklog" class="tab-content" style="display:none;">
    <div class="grid">
      <div class="card">
        <h3>–î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å</h3>
        <div style="display:grid;gap:8px;">
          <select id="worklogUser">
            <option value="">–í—ã–±–µ—Ä–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è‚Ä¶</option>
          </select>
          <input type="date" id="worklogDate" />
          <select id="worklogStatus">
            <option value="working">–í—ã—à–µ–ª –Ω–∞ —Ä–∞–±–æ—Ç—É</option>
            <option value="absent">–ù–µ –≤—ã—à–µ–ª –Ω–∞ —Ä–∞–±–æ—Ç—É</option>
            <option value="evening">–í—ã–π–¥–µ—Ç –≤–µ—á–µ—Ä–æ–º</option>
          </select>
          <textarea id="worklogReason" rows="2" placeholder="–ü—Ä–∏—á–∏–Ω–∞ (–µ—Å–ª–∏ –Ω–µ –≤—ã—à–µ–ª)"></textarea>
          <button id="addWorklogBtn">–î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å</button>
          <div id="worklogStatus" class="small muted"></div>
        </div>
      </div>
      <div class="card">
        <h3>–ò—Å—Ç–æ—Ä–∏—è —Ä–∞–±–æ—Ç—ã</h3>
        <div id="worklogList" style="max-height:500px;overflow:auto;">Loading...</div>
      </div>
    </div>
  </div>
</div>

<script>
/* ========= Helpers ========= */
async function fetchJson(url, opts){ const res = await fetch(url, opts); return res.json(); }
const reportsTable = document.getElementById('reportsTable');
const globalSummaryEl = document.getElementById('globalSummary');
const globalChartCtx = document.getElementById('globalChart').getContext('2d');
let globalChart = null;

function escapeHtml(text){
  if(!text && text!==0) return '';
  return String(text).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}

/* ========= Tab Switching ========= */
document.querySelectorAll('.tab').forEach(tab => {
  tab.addEventListener('click', () => {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
    tab.classList.add('active');
    document.getElementById('tab-' + tab.dataset.tab).style.display = 'block';
  });
});

/* ========= Preserve scroll state ========= */
function preserveStateStart(){
  return {
    scrollY: window.scrollY || document.documentElement.scrollTop || document.body.scrollTop || 0,
    activeElement: document.activeElement,
    activeRowId: (() => {
      const ae = document.activeElement;
      if(!ae) return null;
      const tr = ae.closest && ae.closest('tr');
      return tr ? tr.dataset.reportId : null;
    })()
  };
}
function preserveStateEnd(state){
  window.scrollTo({ top: state.scrollY, behavior: 'auto' });
  if(state.activeElement && document.body.contains(state.activeElement)) {
    try { state.activeElement.focus({ preventScroll: true }); } catch(e) {}
  }
}

/* ========= REPORTS ========= */
async function loadReports(){
  const state = preserveStateStart();
  try{
    const res = await fetchJson('/api/reports');
    if(!res.ok){ reportsTable.innerHTML='<tr><td colspan="5">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</td></tr>'; preserveStateEnd(state); return; }
    const pendingReports = res.reports.filter(r=>r.status==='pending');

    const existingMap = {};
    reportsTable.querySelectorAll('tr[data-report-id]').forEach(tr=>{
      existingMap[tr.dataset.reportId] = tr;
    });

    pendingReports.forEach(rep=>{
      const id = String(rep.id);
      let tr = existingMap[id];
      if(!tr){
        tr = document.createElement('tr');
        tr.className = 'pending-row';
        tr.dataset.reportId = id;
        tr.innerHTML = `
          <td class="table-username">${escapeHtml(rep.username||'‚Äî')}</td>
          <td class="report-text" style="white-space:normal;word-break:break-word">${escapeHtml(rep.text)}</td>
          <td><input type="number" value="0" style="width:72px" /></td>
          <td>
            <select class="table-select">
              <option value="happn">Happn</option>
              <option value="instagram">Instagram</option>
              <option value="lid">–õ–∏–¥</option>
            </select>
          </td>
          <td>
            <button class="action-btn approve">‚úî</button>
            <button class="action-btn reject" style="margin-left:6px">‚úñ</button>
          </td>
        `;
        reportsTable.appendChild(tr);

        const numInput = tr.querySelector('input');
        const sel = tr.querySelector('select');
        tr.querySelector('.approve').addEventListener('click', async ()=>{
          const num = parseInt(numInput.value)||0;
          const type = sel.value;
          try {
            await fetch(`/api/reports/${id}/approve`,{
              method:'POST',
              headers:{'Content-Type':'application/json'},
              body: JSON.stringify({ number:num, type })
            });
            tr.remove();
            await loadGlobalChart();
          } catch(e){ console.error(e); }
        });
        tr.querySelector('.reject').addEventListener('click', async ()=>{
          try {
            await fetch(`/api/reports/${id}/reject`,{ method:'POST' });
            tr.remove();
          } catch(e){ console.error(e); }
        });
      } else {
        const activeRow = state.activeRowId === id;
        if(!activeRow){
          const numInput = tr.querySelector('input');
          const sel = tr.querySelector('select');
          if(numInput) numInput.value = numInput.value || '0';
          if(sel) sel.value = sel.value || 'happn';
        }
      }
      delete existingMap[id];
    });

    Object.keys(existingMap).forEach(oldId=>{
      const tr = existingMap[oldId];
      if(tr) tr.remove();
    });

  }catch(e){ console.error('loadReports err', e); }
  preserveStateEnd(state);
}

/* ========= GLOBAL CHART ========= */
async function loadGlobalChart(){
  try{
    const period = document.getElementById('periodSelect').value;
    const res = await fetchJson(`/api/stats/global?period=${period}`);
    if(!res.ok){ globalSummaryEl.innerText='–û—à–∏–±–∫–∞'; return; }
    const data = res.data || {happn:0,instagram:0,lid:0};
    const total = (data.happn||0)+(data.instagram||0)+(data.lid||0);
    globalSummaryEl.innerText = `–í—Å–µ–≥–æ: ${total} ¬∑ Happn: ${data.happn||0} ¬∑ Instagram: ${data.instagram||0} ¬∑ –õ–∏–¥: ${data.lid||0}`;

    const dataset = [data.happn||0, data.instagram||0, data.lid||0];

    if(globalChart){
      globalChart.data.datasets[0].data = dataset;
      globalChart.update();
    } else {
      globalChart = new Chart(globalChartCtx,{
        type:'doughnut',
        data:{
          labels:['Happn','Instagram','–õ–∏–¥'],
          datasets:[{
            data: dataset,
            backgroundColor:['#f59e0b','#10b981','#3b82f6'],
            borderWidth:0
          }]
        },
        options:{
          plugins:{legend:{position:'bottom',labels:{boxWidth:12}}},
          cutout: '60%',
          animation:{duration:500}
        }
      });
    }
  }catch(e){ console.error('loadGlobalChart err', e); globalSummaryEl.innerText='–û—à–∏–±–∫–∞'; }
}

/* ========= USER SUMMARY ========= */
document.getElementById('viewUserBtn').addEventListener('click', async ()=>{
  const username = document.getElementById('viewUsername').value.trim();
  if(!username) return;
  try{
    const usersRes = await fetchJson('/api/users');
    if(!usersRes.ok){ document.getElementById('userSummary').innerText='–û—à–∏–±–∫–∞'; return; }
    const user = usersRes.users.find(u => u.username === username);
    if(!user){ document.getElementById('userSummary').innerText='–ù–µ –Ω–∞–π–¥–µ–Ω'; return; }

    const reportsRes = await fetchJson('/api/reports');
    if(!reportsRes.ok){ document.getElementById('userSummary').innerText='–û—à–∏–±–∫–∞'; return; }
    const userReports = reportsRes.reports.filter(r => r.user_id === user.id && r.status === 'approved');

    const total = userReports.reduce((acc, r) => acc + (parseInt(r.number)||0), 0);
    const byType = {happn:0, instagram:0, lid:0};
    userReports.forEach(r => { if(r.type) byType[r.type] += parseInt(r.number)||0; });

    document.getElementById('userSummary').innerText = `–í—Å–µ–≥–æ: ${total} ¬∑ Happn: ${byType.happn} ¬∑ Instagram: ${byType.instagram} ¬∑ –õ–∏–¥: ${byType.lid}`;

    const ctx = document.getElementById('userActivityChart').getContext('2d');
    const values = [byType.happn, byType.instagram, byType.lid];
    if(window.userChart){
      window.userChart.data.datasets[0].data = values;
      window.userChart.update();
    } else {
      window.userChart = new Chart(ctx,{
        type:'doughnut',
        data:{
          labels:['Happn','Instagram','–õ–∏–¥'],
          datasets:[{ data: values, backgroundColor:['#f59e0b','#10b981','#3b82f6'] }]
        },
        options:{cutout:'60%', animation:{duration:400}}
      });
    }
  }catch(e){ console.error(e); document.getElementById('userSummary').innerText='–û—à–∏–±–∫–∞'; }
});

document.getElementById('clearUserBtn').addEventListener('click', ()=>{
  document.getElementById('viewUsername').value = '';
  document.getElementById('userSummary').innerText = 'No user selected';
  if(window.userChart) { window.userChart.data.datasets[0].data = [0,0,0]; window.userChart.update(); }
});

/* ========= FEEDBACK ========= */
document.getElementById('sendFeedbackBtn').addEventListener('click', async () => {
  const userId = document.getElementById('feedbackUserSelect').value;
  const text = document.getElementById('feedbackText').value.trim();
  const status = document.getElementById('feedbackStatus');

  if (!userId) { status.textContent = "–í—ã–±–µ—Ä–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è!"; return; }
  if (!text) { status.textContent = "–ù–∞–ø–∏—à–∏ —Ç–µ–∫—Å—Ç —Ñ–∏–¥–±—ç–∫–∞!"; return; }
  status.textContent = "–û—Ç–ø—Ä–∞–≤–∫–∞‚Ä¶";

  try {
    const res = await fetch('/api/feedback/send', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ telegram_id: userId, text })
    });
    const data = await res.json();
    if (data.ok) {
      status.textContent = "–§–∏–¥–±–µ–∫ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!";
      document.getElementById('feedbackText').value = "";
    } else {
      status.textContent = "–û—à–∏–±–∫–∞: " + data.error;
    }
  } catch (e) {
    console.error(e);
    status.textContent = "–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è";
  }
});

/* ========= TEAM MANAGEMENT ========= */
async function loadTeam(){
  try{
    const res = await fetchJson('/api/users');
    if(!res.ok){ document.getElementById('teamList').innerText='–û—à–∏–±–∫–∞'; return; }
    
    const teamList = document.getElementById('teamList');
    teamList.innerHTML = '';
    
    res.users.forEach(u=>{
      const div = document.createElement('div');
      div.className='user-row';
      div.dataset.userId = u.id;
      const uname = u.username || ('id:'+u.id);
      div.innerHTML = `
        <span style="font-weight:600;color:var(--accent);flex:1;">${escapeHtml(uname)}</span>
        <select class="table-select role-select" data-user-id="${u.id}">
          <option value="">–í—ã–±—Ä–∞—Ç—å —Ä–æ–ª—å</option>
          <option value="worker" ${u.role==='worker'?'selected':''}>–†–∞–±–æ—Ç–Ω–∏–∫</option>
          <option value="cleaner" ${u.role==='cleaner'?'selected':''}>–£–±–æ—Ä—â–∏–∫</option>
          <option value="accountant" ${u.role==='accountant'?'selected':''}>–ë—É—Ö–≥–∞–ª—Ç–µ—Ä</option>
        </select>
        <button class="action-btn reject delete-user" data-user-id="${u.id}" title="–£–¥–∞–ª–∏—Ç—å">‚úñ</button>
      `;
      teamList.appendChild(div);
    });

    // Role change handlers
    teamList.querySelectorAll('.role-select').forEach(sel => {
      sel.addEventListener('change', async (e) => {
        const userId = e.target.dataset.userId;
        const role = e.target.value;
        try {
          await fetch(`/api/users/${userId}/role`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ role })
          });
        } catch (err) {
          console.error('Role update error', err);
        }
      });
    });

    // Delete handlers
    teamList.querySelectorAll('.delete-user').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        const userId = e.target.dataset.userId;
        if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?')) return;
        try {
          await fetch(`/api/users/${userId}`, { method: 'DELETE' });
          await loadTeam();
        } catch (err) {
          console.error('Delete error', err);
        }
      });
    });

    // Fill selects
    fillFeedbackUsers(res.users);
    fillWorklogUsers(res.users);
    
    // Load team stats
    await loadTeamStats();
  }catch(e){ console.error(e); document.getElementById('teamList').innerText='–û—à–∏–±–∫–∞'; }
}

document.getElementById('addUserBtn').addEventListener('click', async () => {
  const username = document.getElementById('newUsername').value.trim();
  const status = document.getElementById('addUserStatus');
  
  if (!username) {
    status.textContent = '–í–≤–µ–¥–∏ username!';
    return;
  }
  
  status.textContent = '–î–æ–±–∞–≤–ª–µ–Ω–∏–µ...';
  
  try {
    const res = await fetch('/api/users/add', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ username })
    });
    const data = await res.json();
    
    if (data.ok) {
      status.textContent = '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–±–∞–≤–ª–µ–Ω!';
      document.getElementById('newUsername').value = '';
      await loadTeam();
    } else {
      status.textContent = '–û—à–∏–±–∫–∞: ' + data.error;
    }
  } catch (e) {
    console.error(e);
    status.textContent = '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è';
  }
});

async function loadTeamStats() {
  try {
    const res = await fetchJson('/api/stats/detailed');
    if (!res.ok) return;
    
    const statsEl = document.getElementById('teamStats');
    let html = '<div style="display:grid;gap:8px;">';
    
    res.stats.forEach(user => {
      const total = (user.happn_total || 0) + (user.instagram_total || 0) + (user.lid_total || 0);
      html += `
        <div style="padding:8px;background:rgba(255,255,255,0.02);border-radius:6px;">
          <div style="font-weight:600;color:var(--accent);">${escapeHtml(user.username || 'Unknown')}</div>
          <div class="small" style="margin-top:4px;">
            –†–æ–ª—å: ${user.role || '–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∞'} ¬∑ –û—Ç—á–µ—Ç–æ–≤: ${user.approved_reports || 0} ¬∑ –ö–æ–Ω–≤–µ—Ä—Å–∏–π: ${total}
          </div>
          <div class="small">
            Happn: ${user.happn_total || 0} ¬∑ Instagram: ${user.instagram_total || 0} ¬∑ –õ–∏–¥: ${user.lid_total || 0}
          </div>
        </div>
      `;
    });
    
    html += '</div>';
    statsEl.innerHTML = html;
  } catch (e) {
    console.error('Team stats error', e);
  }
}

function fillFeedbackUsers(users){
  const sel = document.getElementById('feedbackUserSelect');
  if(!sel) return;
  const cur = sel.value;
  sel.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è‚Ä¶</option>';
  users.forEach(u=>{
    const option = document.createElement('option');
    option.value = u.telegram_id || '';
    option.textContent = u.username || ('id:'+u.id);
    sel.appendChild(option);
  });
  if(cur) sel.value = cur;
}

function fillWorklogUsers(users){
  const sel = document.getElementById('worklogUser');
  if(!sel) return;
  const cur = sel.value;
  sel.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è‚Ä¶</option>';
  users.forEach(u=>{
    const option = document.createElement('option');
    option.value = u.id;
    option.textContent = u.username || ('id:'+u.id);
    sel.appendChild(option);
  });
  if(cur) sel.value = cur;
}

/* ========= INSIGHTS ========= */
document.getElementById('generateInsightsBtn').addEventListener('click', async () => {
  const btn = document.getElementById('generateInsightsBtn');
  btn.textContent = '–ì–µ–Ω–µ—Ä–∞—Ü–∏—è...';
  btn.disabled = true;
  
  try {
    const res = await fetch('/api/insights/generate', { method: 'POST' });
    const data = await res.json();
    
    if (data.ok) {
      await loadInsights();
    }
  } catch (e) {
    console.error('Insights generation error', e);
  } finally {
    btn.textContent = '–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫–∏';
    btn.disabled = false;
  }
});

async function loadInsights() {
  try {
    const res = await fetchJson('/api/insights');
    if (!res.ok) return;
    
    const listEl = document.getElementById('insightsList');
    
    if (res.insights.length === 0) {
      listEl.innerHTML = '<div class="small muted">–ù–µ—Ç –ø–æ–¥—Å–∫–∞–∑–æ–∫. –ù–∞–∂–º–∏ "–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫–∏"</div>';
      return;
    }
    
    let html = '';
    res.insights.forEach(insight => {
      let className = 'insight-item';
      if (insight.category === 'success') className += ' insight-success';
      if (insight.category === 'improvement') className += ' insight-warning';
      
      html += `<div class="${className}">${escapeHtml(insight.content)}</div>`;
    });
    
    listEl.innerHTML = html;
  } catch (e) {
    console.error('Load insights error', e);
  }
}

/* ========= WORK LOG ========= */
document.getElementById('addWorklogBtn').addEventListener('click', async () => {
  const userId = document.getElementById('worklogUser').value;
  const date = document.getElementById('worklogDate').value;
  const status = document.getElementById('worklogStatus').value;
  const reason = document.getElementById('worklogReason').value.trim();
  const statusEl = document.getElementById('worklogStatus');
  
  if (!userId || !date) {
    document.getElementById('worklogStatus').textContent = '–ó–∞–ø–æ–ª–Ω–∏ –≤—Å–µ –ø–æ–ª—è!';
    return;
  }
  
  try {
    const res = await fetch('/api/worklogs/add', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ user_id: userId, date, status, reason })
    });
    const data = await res.json();
    
    if (data.ok) {
      document.getElementById('worklogReason').value = '';
      await loadWorklogs();
    }
  } catch (e) {
    console.error('Add worklog error', e);
  }
});

async function loadWorklogs() {
  try {
    const res = await fetchJson('/api/worklogs');
    if (!res.ok) return;
    
    const listEl = document.getElementById('worklogList');
    
    if (res.logs.length === 0) {
      listEl.innerHTML = '<div class="small muted">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π</div>';
      return;
    }
    
    let html = '';
    res.logs.forEach(log => {
      let badgeClass = 'status-badge ';
      let statusText = '';
      
      if (log.status === 'working') {
        badgeClass += 'status-working';
        statusText = '–†–∞–±–æ—Ç–∞–µ—Ç';
      } else if (log.status === 'absent') {
        badgeClass += 'status-absent';
        statusText = '–ù–µ –≤—ã—à–µ–ª';
      } else if (log.status === 'evening') {
        badgeClass += 'status-evening';
        statusText = '–í–µ—á–µ—Ä–æ–º';
      }
      
      html += `
        <div class="worklog-item">
          <div>
            <div style="font-weight:600;">${escapeHtml(log.username || 'Unknown')}</div>
            <div class="small muted">${log.date}${log.reason ? ' ¬∑ ' + escapeHtml(log.reason) : ''}</div>
          </div>
          <span class="${badgeClass}">${statusText}</span>
        </div>
      `;
    });
    
    listEl.innerHTML = html;
  } catch (e) {
    console.error('Load worklogs error', e);
  }
}

// Set today's date as default
document.getElementById('worklogDate').valueAsDate = new Date();

/* ========= AUTO-REFRESH ========= */
let periodicHandle = null;
async function refreshAll(){
  const state = preserveStateStart();
  await Promise.all([ loadReports(), loadTeam(), loadGlobalChart() ]);
  preserveStateEnd(state);
}

document.getElementById('refreshBtn').addEventListener('click', refreshAll);
document.getElementById('periodSelect').addEventListener('change', () => { loadGlobalChart(); });

(async function init(){
  await refreshAll();
  await loadInsights();
  await loadWorklogs();
  
  if(periodicHandle) clearInterval(periodicHandle);
  periodicHandle = setInterval(async ()=>{ 
    if(document.hidden) return; 
    await refreshAll(); 
  }, 3000);
})();

window.addEventListener('beforeunload', ()=>{ if(periodicHandle) clearInterval(periodicHandle); });
</script>
</body>
</html>