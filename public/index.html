<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Team Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  :root{--bg:#0f1724;--card:#111827;--muted:#9ca3af;--accent:#f59e0b;}
  html,body{margin:0;padding:0;height:100%;font-family:Inter,sans-serif;background:var(--bg);color:#fff;}
  .wrap{max-width:1200px;margin:20px auto;padding:16px;}
  .grid{display:grid;grid-template-columns:1fr 400px;gap:16px;}
  .card{background:var(--card);border-radius:12px;padding:16px;box-shadow:0 6px 18px rgba(0,0,0,0.6);}
  h1,h3{margin:0 0 8px 0;}
  .muted{color:var(--muted);font-size:13px;}
  .team-list{max-height:500px;overflow:auto;}
  .user-row{display:flex;justify-content:space-between;padding:8px;border-bottom:1px dashed rgba(255,255,255,0.1);}
  input,textarea,select,button{border-radius:6px;border:none;padding:8px;}
  input,textarea,select{width:100%;margin-bottom:8px;background:#1b1f2c;color:#fff;}
  button{background:var(--accent);color:#081125;cursor:pointer;}
  canvas{background:transparent;}
</style>
</head>
<body>
<div class="wrap">
  <h1>Team Dashboard</h1>

  <div class="grid">
    <div>
      <!-- Global Stats -->
      <div class="card">
        <h3>Global Stats</h3>
        <div id="globalSummary" class="muted">Loading...</div>
        <canvas id="globalChart" height="200"></canvas>
      </div>

      <!-- Recent Reports -->
      <div class="card">
        <h3>Recent Reports</h3>
        <div id="recentReportsList" class="team-list muted">Loading...</div>
      </div>

      <!-- Submit Report -->
      <div class="card">
        <h3>Submit Quick Report</h3>
        <input id="reportUser" placeholder="Username (e.g. @ivan)">
        <select id="reportReason">
          <option value="">Select Reason</option>
          <option value="Много врёт и почти ничего не выполняет">Много врёт и почти ничего не выполняет</option>
          <option value="Слишком мало делает">Слишком мало делает</option>
          <option value="Нужно поговорить о стратегии">Нужно поговорить о стратегии</option>
        </select>
        <textarea id="reportText" rows="3" placeholder="Report text"></textarea>
        <button id="sendReport">Send Report</button>
        <div id="reportResult" class="muted"></div>
      </div>
    </div>

    <div>
      <!-- Team List -->
      <div class="card">
        <h3>Team</h3>
        <div id="teamList" class="team-list muted">Loading...</div>
      </div>

      <!-- User Summary -->
      <div class="card">
        <h3>User Summary</h3>
        <input id="viewUsername" placeholder="Username to view">
        <button id="viewUserBtn">View</button>
        <div id="userSummary" class="muted">No user selected</div>
        <canvas id="userChart" height="180"></canvas>
        <div id="userReports" class="muted"></div>
      </div>
    </div>
  </div>
</div>

<script>
async function fetchJson(url, opts){ const res=await fetch(url, opts); return res.json(); }

// Global Stats
let gChart = null;
async function loadGlobalStats(){
  const data = await fetchJson('/api/stats/global');
  if(!data.ok) return;
  const done = data.summary.done_total||0;
  const failed = data.summary.failed_total||0;
  document.getElementById('globalSummary').innerText=`Done: ${done} · Failed: ${failed}`;
  const ctx = document.getElementById('globalChart').getContext('2d');
  if(gChart) gChart.destroy();
  gChart = new Chart(ctx,{
    type:'doughnut',
    data:{labels:['Done','Failed'],datasets:[{data:[done,failed],backgroundColor:['#00ff00','#ff0000']}]},
    options:{plugins:{legend:{labels:{color:'#fff'}}}}
  });
}

// Recent Reports
async function loadRecentReports(){
  const el=document.getElementById('recentReportsList');
  const data = await fetchJson('/api/reports/web/recent');
  if(!data.ok){ el.innerText='Error'; return; }
  el.innerHTML='';
  data.reports.forEach(r=>{
    const div=document.createElement('div');
    div.className='user-row';
    div.innerHTML=`<div><strong>${r.username||'—'}</strong><br><span class="muted">${r.text}</span></div>
      <div style="display:flex;gap:4px">
        <button onclick="markReport(${r.id},'done')">✔</button>
        <button onclick="markReport(${r.id},'failed')">✖</button>
      </div>`;
    el.appendChild(div);
  });
}
async function markReport(id,status){
  await fetch(`/api/reports/${id}/mark`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({status})});
  loadRecentReports(); loadGlobalStats();
}

// Team List
async function loadTeam(){
  const data = await fetchJson('/api/users');
  if(!data.ok) return;
  const el=document.getElementById('teamList');
  el.innerHTML='';
  data.users.forEach(u=>{
    const div=document.createElement('div');
    div.className='user-row';
    div.innerHTML=`<div><strong>${u.username||u.display_name||'—'}</strong></div>`;
    el.appendChild(div);
  });
}

// Send Report
document.getElementById('sendReport').addEventListener('click', async ()=>{
  const username=document.getElementById('reportUser').value;
  const reason=document.getElementById('reportReason').value;
  const text=document.getElementById('reportText').value;
  const resEl=document.getElementById('reportResult');
  if(!username||!reason||!text){ resEl.innerText='Fill all fields'; return; }
  const r = await fetchJson('/api/reports',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username,text,reason})});
  if(r.ok){ resEl.innerText='Sent'; document.getElementById('reportText').value=''; loadRecentReports(); loadGlobalStats(); }
  else resEl.innerText='Error: '+(r.error||'');
});

// User Summary
let uChart=null;
document.getElementById('viewUserBtn').addEventListener('click',async ()=>{
  const username=document.getElementById('viewUsername').value;
  if(!username) return;
  const data=await fetchJson('/api/user/'+encodeURIComponent(username));
  if(!data.ok){ document.getElementById('userSummary').innerText='Not found'; return; }
  const sum=data.summary;
  document.getElementById('userSummary').innerHTML=`Total: ${sum.total} · Completed: ${sum.completed} · Failed: ${sum.failed} · Suspicious: ${sum.suspicious}`;
  const labels=(data.reports||[]).slice(-20).map(r=>new Date(r.created_at).toLocaleDateString());
  const values=(data.reports||[]).slice(-20).map(r=>r.length);
  const ctx=document.getElementById('userChart').getContext('2d');
  if(uChart) uChart.destroy();
  uChart=new Chart(ctx,{type:'bar',data:{labels, datasets:[{label:'Report length',data:values,backgroundColor:'#f59e0b'}]},options:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}});
  document.getElementById('userReports').innerHTML=(data.reports||[]).slice(-20).map(r=>`<div>${new Date(r.created_at).toLocaleString()}: ${r.text}</div>`).join('');
});

// Init
loadGlobalStats();
loadRecentReports();
loadTeam();
</script>
</body>
</html>
