<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Team Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root{
  --bg:#0b1220; --card:#111827; --muted:#9ca3af; --accent:#f59e0b;
  --accent-dark:#d48806; --input-bg:#0f1724; --accent-green:#10b981;
  --accent-red:#ef4444;
}
html,body{height:100%;margin:0;padding:0;background:linear-gradient(180deg,var(--bg),#0f1724);color:#e6eef8;font-family:Inter,Arial,Helvetica,sans-serif;}
.wrap{max-width:1200px;margin:20px auto;padding:18px;}
.top{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:8px;}
.card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:12px;padding:14px;box-shadow: 0 6px 18px rgba(2,6,23,0.6);margin-bottom:12px;}
.grid{display:grid;grid-template-columns:1fr 420px;gap:16px;}
.team-list{max-height:520px;overflow:auto;padding:8px;}
.user-row{display:flex;justify-content:space-between;padding:8px;border-bottom:1px dashed rgba(255,255,255,0.03);align-items:center;}
.muted{color:var(--muted);font-size:13px;}
.small{font-size:13px;color:var(--muted);}
h1,h3{margin:0 0 8px 0;}
input,textarea,select{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.05);background:var(--input-bg);color:inherit;box-sizing:border-box;outline:none;transition:box-shadow .18s, border-color .18s;}
input:focus, textarea:focus, select:focus{box-shadow:0 0 8px rgba(245,158,11,0.14);border-color:rgba(245,158,11,0.28);}
input[type="number"]{width:80px;padding:6px 8px;border-radius:8px;text-align:center;}
button{background:var(--accent);color:#081125;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:600;}
button.secondary{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted);padding:6px 10px;}
.action-btn{width:34px;height:34px;border-radius:8px;display:inline-flex;align-items:center;justify-content:center;font-weight:700;cursor:pointer;border:none;}
.approve{background:var(--accent-green);color:#081125;}
.reject{background:var(--accent-red);color:#fff;}
table{width:100%;border-collapse:collapse;color:#e6eef8;}
th,td{padding:8px;border-bottom:1px solid rgba(255,255,255,0.06);text-align:left;vertical-align:middle;}
thead th{color:var(--muted);font-weight:600;font-size:13px;}
.pending-row{background:transparent;}
.pending-row:hover{background:rgba(255,255,255,0.01);}
.table-select {width:140px;padding:6px;border-radius:8px;background:var(--input-bg);}
canvas{max-width:100%;}
@media (max-width:980px){ .grid{grid-template-columns:1fr;} .wrap{padding:12px;} }
.feedback-card .small{margin-top:6px;}
</style>
</head>
<body>
<div class="wrap" id="wrap">
  <div class="top">
    <div>
      <h1>Team Dashboard</h1>
      <div class="muted">Webhook bot mode — Telegram интеграция через WEBHOOK</div>
    </div>
    <div style="display:flex;gap:8px;align-items:center">
      <select id="periodSelect" class="period-selector" title="Период">
        <option value="today">Сегодня</option>
        <option value="yesterday">Вчера</option>
        <option value="week">Неделя</option>
        <option value="month">Месяц</option>
      </select>
      <button id="refreshBtn" class="secondary">Refresh</button>
    </div>
  </div>

  <div class="grid">
    <div>
      <div class="card">
        <h3>Global Stats</h3>
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">
          <div id="globalSummary" class="small muted">Loading...</div>
          <div style="font-size:13px;color:var(--muted)">Автообновление каждые 3с</div>
        </div>
        <canvas id="globalChart" style="height:220px;"></canvas>
      </div>

      <div class="card">
        <h3>Отчеты (ожидающие подтверждения — ОТЧЕТ)</h3>
        <div style="overflow:auto;max-height:360px;">
          <table>
            <thead>
              <tr><th style="width:16%">@user</th><th style="width:44%">Text</th><th style="width:12%">Number</th><th style="width:14%">Type</th><th style="width:14%">✔ / ❌</th></tr>
            </thead>
            <tbody id="reportsTable"></tbody>
          </table>
        </div>
      </div>
    </div>

    <div>
      <div class="card">
        <h3>Team</h3>
        <div style="display:flex; gap:8px; margin-bottom:8px;">
          <input id="newUsername" placeholder="@username" />
          <input id="newDisplay" placeholder="Display Name" />
          <button id="addUserBtn">Add</button>
        </div>
        <div id="teamList" class="team-list small muted">Loading...</div>
      </div>

      <div class="card feedback-card">
        <h3>User Summary</h3>
        <div style="display:grid;gap:8px">
          <input id="viewUsername" placeholder="username to view (e.g. @ivan)" />
          <div style="display:flex;gap:8px">
            <button id="viewUserBtn">View</button>
            <button id="clearUserBtn" class="secondary">Clear</button>
          </div>
          <div id="userSummary" class="small muted">No user selected</div>
          <canvas id="userActivityChart" style="height:180px;margin-top:8px"></canvas>
        </div>
      </div>

      <div class="card">
        <h3>Отправить фидбек пользователю</h3>
        <div style="display:grid;gap:8px">
          <select id="feedbackUserSelect">
            <option value="">Выбери пользователя…</option>
          </select>
          <textarea id="feedbackText" rows="3" placeholder="Текст фидбэка"></textarea>
          <div style="display:flex;gap:8px;align-items:center">
            <button id="sendFeedbackBtn">Отправить</button>
            <div id="feedbackStatus" class="small muted"></div>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<script>
/* ====== Helpers ====== */
async function fetchJson(url, opts) { 
  const res = await fetch(url, opts); 
  return res.json(); 
}
function escapeHtml(text){ 
  if(!text && text!==0) return ''; 
  return String(text).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); 
}

/* ====== Elements ====== */
const reportsTable = document.getElementById('reportsTable');
const teamListEl = document.getElementById('teamList');
const globalSummaryEl = document.getElementById('globalSummary');
const globalChartCtx = document.getElementById('globalChart').getContext('2d');
let globalChart = null;
let userChart = null;
let isRefreshing = false;

/* ====== Preserve scroll/input ====== */
function preserveStateStart(){
  return {
    scrollY: window.scrollY || document.documentElement.scrollTop || document.body.scrollTop || 0,
    activeElement: document.activeElement
  };
}
function preserveStateEnd(state){
  window.scrollTo({ top: state.scrollY, behavior: 'auto' });
  if(state.activeElement && document.body.contains(state.activeElement)) {
    try { state.activeElement.focus({ preventScroll: true }); } catch(e) {}
  }
}

/* ====== Load Team ====== */
async function loadTeam(){
  try{
    const res = await fetchJson('/api/users');
    if(!res.ok){ teamListEl.innerText='Ошибка'; return; }
    const existingRows = {};
    teamListEl.querySelectorAll('.user-row').forEach(row=>existingRows[row.dataset.userid]=row);

    res.users.forEach(u=>{
      const uname = u.username || ('id:'+u.id);
      let div = existingRows[u.id];
      if(!div){
        div = document.createElement('div');
        div.className='user-row';
        div.dataset.userid = u.id;
        div.innerHTML = `
          <span style="font-weight:600;color:var(--accent);">${escapeHtml(uname)}</span>
          <select class="table-select">
            <option value="">Выбрать роль</option>
            <option value="worker">Работник</option>
            <option value="cleaner">Уборщик</option>
            <option value="accountant">Бухгалтер</option>
          </select>
          <button class="secondary deleteUserBtn">Удалить</button>
        `;
        teamListEl.appendChild(div);
      }
      const sel = div.querySelector('select');
      sel.value = u.role || '';
      div.querySelector('.deleteUserBtn').onclick = async ()=>{
        if(!confirm(`Удалить пользователя ${uname}?`)) return;
        try{ await fetch(`/api/users/${u.id}/delete`,{method:'POST'}); loadTeam(); }catch(e){console.error(e);}
      };
      sel.onchange = async ()=>{
        try{ 
          await fetch(`/api/users/${u.id}/role`,{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({role:sel.value})
          }); 
        } catch(e){console.error(e);}
      };
      delete existingRows[u.id];
    });
    Object.values(existingRows).forEach(row=>row.remove());
    fillFeedbackUsers(res.users);
  }catch(e){ console.error(e); teamListEl.innerText='Ошибка'; }
}

/* ====== Add User ====== */
document.getElementById('addUserBtn').addEventListener('click', async ()=>{
  const username = document.getElementById('newUsername').value.trim();
  const display_name = document.getElementById('newDisplay').value.trim();
  if(!username){ alert('Введите username'); return; }
  try{
    await fetch('/api/users/add',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({username, display_name})
    });
    document.getElementById('newUsername').value='';
    document.getElementById('newDisplay').value='';
    loadTeam();
  }catch(e){ console.error(e); alert('Ошибка добавления'); }
});

/* ====== Fill Feedback Users ====== */
function fillFeedbackUsers(users){
  const sel = document.getElementById('feedbackUserSelect');
  if(!sel) return;
  const cur = sel.value;
  sel.innerHTML = '<option value="">Выбери пользователя…</option>';
  users.forEach(u=>{
    const option = document.createElement('option');
    option.value = u.telegram_id || '';
    option.textContent = u.username || ('id:'+u.id);
    sel.appendChild(option);
  });
  if(cur) sel.value = cur;
}

/* ====== Load Reports ====== */
async function loadReports(){
  const state = preserveStateStart();
  try{
    const res = await fetchJson('/api/reports');
    if(!res.ok){ reportsTable.innerHTML='<tr><td colspan="5">Ошибка загрузки</td></tr>'; preserveStateEnd(state); return; }
    const pendingReports = res.reports.filter(r=>r.status==='pending');
    const existingMap = {};
    reportsTable.querySelectorAll('tr[data-report-id]').forEach(tr=>{ existingMap[tr.dataset.reportId] = tr; });

    pendingReports.forEach(rep=>{
      const id = String(rep.id);
      let tr = existingMap[id];
      if(!tr){
        tr = document.createElement('tr');
        tr.className='pending-row';
        tr.dataset.reportId = id;
        tr.innerHTML = `
          <td class="table-username">${escapeHtml(rep.username||'—')}</td>
          <td class="report-text">${escapeHtml(rep.text)}</td>
          <td><input type="number" value="${rep.number||0}" style="width:72px" /></td>
          <td>
            <select class="table-select">
              <option value="happn">Happn</option>
              <option value="instagram">Instagram</option>
              <option value="lid">Лид</option>
            </select>
          </td>
          <td>
            <button class="action-btn approve">✔</button>
            <button class="action-btn reject" style="margin-left:6px">✖</button>
          </td>
        `;
        reportsTable.appendChild(tr);
      } else {
        tr.querySelector('.table-username').textContent = escapeHtml(rep.username||'—');
        tr.querySelector('.report-text').textContent = escapeHtml(rep.text);
        tr.querySelector('input').value = rep.number||0;
        tr.querySelector('select').value = rep.type || 'happn';
      }
      delete existingMap[id];
    });
    Object.values(existingMap).forEach(tr=>tr.remove());
  }catch(e){ console.error('loadReports err', e); }
  preserveStateEnd(state);
}

/* ====== Global Chart ====== */
async function loadGlobalChart(){
  try{
    const period = document.getElementById('periodSelect').value;
    const res = await fetchJson(`/api/stats/global?period=${period}`);
    if(!res.ok){ globalSummaryEl.innerText='Ошибка'; return; }
    const data = res.data || {happn:0,instagram:0,lid:0};
    const total = (data.happn||0)+(data.instagram||0)+(data.lid||0);
    globalSummaryEl.innerText = `Всего: ${total} · Happn: ${data.happn||0} · Instagram: ${data.instagram||0} · Лид: ${data.lid||0}`;
    const dataset = [data.happn||0, data.instagram||0, data.lid||0];

    if(globalChart){
      globalChart.data.datasets[0].data = dataset;
      globalChart.update();
    } else {
      globalChart = new Chart(globalChartCtx,{
        type:'doughnut',
        data:{ labels:['Happn','Instagram','Лид'], datasets:[{ data: dataset, backgroundColor:['#f59e0b','#10b981','#3b82f6'], borderWidth:0 }] },
        options:{plugins:{legend:{position:'bottom',labels:{boxWidth:12}}}, cutout: '60%', animation:{duration:500}}
      });
    }
  }catch(e){ console.error('loadGlobalChart err', e); globalSummaryEl.innerText='Ошибка'; }
}

/* ====== Auto-refresh ====== */
async function refreshAll(){
  if(isRefreshing) return; 
  isRefreshing = true;
  await Promise.all([loadReports(), loadTeam(), loadGlobalChart()]);
  isRefreshing = false;
}
document.getElementById('refreshBtn').addEventListener('click', refreshAll);
document.getElementById('periodSelect').addEventListener('change', loadGlobalChart);
setInterval(async ()=>{ if(document.hidden) return; await refreshAll(); }, 3000);

/* ====== Init ====== */
(async function init(){ await refreshAll(); })();
</script>
</body>
</html>
